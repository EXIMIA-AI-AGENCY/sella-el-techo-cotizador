<!DOCTYPE html>
<html lang="es-PR">

<head>
  <meta charset="UTF-8">

  <!-- Primary Meta Tags -->
  <title>Cotizador de Sellado de Techo en Puerto Rico | Sella El Techo - Cotizaci√≥n Gratis Instant√°nea</title>
  <meta name="title" content="Cotizador de Sellado de Techo en Puerto Rico | Sella El Techo - Cotizaci√≥n Gratis Instant√°nea">
  <meta name="description" content="Obt√©n tu cotizaci√≥n GRATIS de sellado de techo en Puerto Rico en menos de 2 minutos. Servicios profesionales con Silicone y Danosa. Protege tu hogar de filtraciones. ¬°Calcula el precio ahora!">
  <meta name="keywords" content="sellado de techo Puerto Rico, cotizaci√≥n techo gratis, reparaci√≥n de techo PR, impermeabilizaci√≥n techo, Danosa Puerto Rico, silicone techo, filtraciones techo, mantenimiento techo, techo plano, roofing Puerto Rico, sellador de techo, presupuesto techo, Sella El Techo">
  <meta name="author" content="Sella El Techo">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="googlebot" content="index, follow">

  <!-- Viewport & Mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sella El Techo">
  <meta name="application-name" content="Sella El Techo Cotizador">
  <meta name="theme-color" content="#0a192f">
  <meta name="msapplication-TileColor" content="#ff9900">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://sellaeltecho.com/cotizador">

  <!-- Geographic Meta Tags (Puerto Rico) -->
  <meta name="geo.region" content="PR">
  <meta name="geo.country" content="US">
  <meta name="geo.placename" content="Puerto Rico">
  <meta name="ICBM" content="18.2208, -66.5901">
  <meta name="DC.title" content="Sellado de Techo Puerto Rico">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sellaeltecho.com/cotizador">
  <meta property="og:title" content="Cotizador de Sellado de Techo | Sella El Techo Puerto Rico">
  <meta property="og:description" content="Calcula el precio de tu sellado de techo GRATIS en menos de 2 minutos. Servicios profesionales con garant√≠a en todo Puerto Rico. ¬°Protege tu hogar hoy!">
  <meta property="og:image" content="https://sellaeltecho.com/images/og-image-cotizador.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="Sella El Techo - Cotizador de Sellado de Techo Puerto Rico">
  <meta property="og:locale" content="es_PR">
  <meta property="og:site_name" content="Sella El Techo">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://sellaeltecho.com/cotizador">
  <meta name="twitter:title" content="Cotizador de Sellado de Techo | Sella El Techo Puerto Rico">
  <meta name="twitter:description" content="Calcula el precio de tu sellado de techo GRATIS en menos de 2 minutos. Servicios profesionales con garant√≠a en todo Puerto Rico.">
  <meta name="twitter:image" content="https://sellaeltecho.com/images/twitter-card-cotizador.jpg">
  <meta name="twitter:image:alt" content="Sella El Techo - Cotizador de Sellado de Techo">

  <!-- Structured Data - LocalBusiness -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "@id": "https://sellaeltecho.com/#business",
    "name": "Sella El Techo",
    "description": "Servicios profesionales de sellado e impermeabilizaci√≥n de techos en Puerto Rico. Expertos en Silicone y Danosa con m√°s de 10 a√±os de experiencia.",
    "url": "https://sellaeltecho.com",
    "telephone": "+1-787-123-4567",
    "email": "info@sellaeltecho.com",
    "image": "https://sellaeltecho.com/images/logo.png",
    "logo": "https://sellaeltecho.com/images/logo.png",
    "priceRange": "$$",
    "currenciesAccepted": "USD",
    "paymentAccepted": "Cash, Credit Card, ATH Movil",
    "address": {
      "@type": "PostalAddress",
      "addressRegion": "PR",
      "addressCountry": "US",
      "addressLocality": "Puerto Rico"
    },
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": "18.2208",
      "longitude": "-66.5901"
    },
    "areaServed": {
      "@type": "Place",
      "name": "Puerto Rico"
    },
    "serviceArea": {
      "@type": "GeoCircle",
      "geoMidpoint": {
        "@type": "GeoCoordinates",
        "latitude": "18.2208",
        "longitude": "-66.5901"
      },
      "geoRadius": "200 km"
    },
    "openingHoursSpecification": [
      {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
        "opens": "07:00",
        "closes": "18:00"
      },
      {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": "Saturday",
        "opens": "08:00",
        "closes": "14:00"
      }
    ],
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.9",
      "reviewCount": "127",
      "bestRating": "5",
      "worstRating": "1"
    },
    "sameAs": [
      "https://www.facebook.com/sellaeltecho",
      "https://www.instagram.com/sellaeltecho"
    ]
  }
  </script>

  <!-- Structured Data - Service -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Service",
    "serviceType": "Sellado de Techo",
    "name": "Sellado Profesional de Techo",
    "description": "Servicio de sellado e impermeabilizaci√≥n de techos residenciales y comerciales en Puerto Rico. Utilizamos materiales de primera calidad como Silicone y Danosa.",
    "provider": {
      "@type": "LocalBusiness",
      "name": "Sella El Techo",
      "url": "https://sellaeltecho.com"
    },
    "areaServed": {
      "@type": "Place",
      "name": "Puerto Rico"
    },
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Servicios de Sellado de Techo",
      "itemListElement": [
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Sellado con Silicone",
            "description": "Impermeabilizaci√≥n de techo con silicone de alta calidad"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Sellado con Danosa",
            "description": "Sistema de impermeabilizaci√≥n Danosa con membrana asf√°ltica"
          }
        },
        {
          "@type": "Offer",
          "itemOffered": {
            "@type": "Service",
            "name": "Remoci√≥n de Membranas",
            "description": "Remoci√≥n de capas de membrana existentes antes del sellado"
          }
        }
      ]
    }
  }
  </script>

  <!-- Structured Data - WebApplication (Cotizador) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Cotizador de Sellado de Techo",
    "description": "Herramienta gratuita para calcular el precio de sellado de techo en Puerto Rico. Obt√©n tu cotizaci√≥n en menos de 2 minutos.",
    "url": "https://sellaeltecho.com/cotizador",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "All",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "author": {
      "@type": "Organization",
      "name": "Sella El Techo"
    }
  }
  </script>

  <!-- Structured Data - FAQ -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "¬øCu√°nto cuesta sellar un techo en Puerto Rico?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "El costo de sellar un techo en Puerto Rico var√≠a seg√∫n el tama√±o y tipo de servicio. El precio base es aproximadamente $3.50 por pie cuadrado. Usa nuestro cotizador gratuito para obtener un estimado preciso."
        }
      },
      {
        "@type": "Question",
        "name": "¬øQu√© es mejor, Silicone o Danosa?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ambos son excelentes opciones. Silicone es ideal para techos en buen estado y ofrece excelente protecci√≥n UV. Danosa es mejor para techos que necesitan m√°s impermeabilizaci√≥n y durabilidad a largo plazo."
        }
      },
      {
        "@type": "Question",
        "name": "¬øCu√°nto tiempo dura el sellado de techo?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Un sellado profesional de techo puede durar entre 5 a 15 a√±os dependiendo del material utilizado, el mantenimiento y las condiciones clim√°ticas de Puerto Rico."
        }
      },
      {
        "@type": "Question",
        "name": "¬øOfrecen garant√≠a en el trabajo?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "S√≠, todos nuestros trabajos de sellado de techo incluyen garant√≠a. La duraci√≥n de la garant√≠a var√≠a seg√∫n el tipo de servicio y materiales utilizados."
        }
      }
    ]
  }
  </script>

  <!-- Preconnect for Performance -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://services.leadconnectorhq.com" crossorigin>

  <!-- DNS Prefetch -->
  <link rel="dns-prefetch" href="https://api.leadconnectorhq.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700;800&display=swap"
    rel="stylesheet">
  <!-- HTML2PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      /* Core Colors */
      --bg-color: #0a192f;
      --bg-secondary: #0d1f3c;
      --card-bg: #112240;
      --card-elevated: #1a2f4f;
      --text-main: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #ff9900;
      --accent-hover: #ffaa33;
      --accent-light: rgba(255, 153, 0, 0.1);
      --border: #1e3a5f;
      --border-light: #2d4a6f;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      --shadow-glow: 0 0 20px rgba(255, 153, 0, 0.3);

      /* Spacing */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;

      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Override Bootstrap muted text for better visibility on dark theme */
    .text-muted {
      color: var(--text-muted) !important;
    }

    /* Skip Link for Accessibility */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #000;
      padding: 10px 20px;
      border-radius: var(--radius-md);
      z-index: 10000;
      font-weight: 600;
      transition: top var(--transition-fast);
    }

    .skip-link:focus {
      top: 10px;
      outline: 2px solid #fff;
      outline-offset: 2px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-color) 0%, var(--bg-secondary) 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-xl);
      padding-bottom: 120px;
      -webkit-tap-highlight-color: var(--accent-light);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* Prevent unwanted behaviors on mobile */
    * {
      -webkit-touch-callout: none;
      /* Disable callout on long press */
    }

    /* Allow text selection for inputs and text content */
    input,
    textarea,
    p,
    span,
    td,
    th {
      -webkit-touch-callout: default;
      user-select: text;
    }

    /* Make placeholder text visible on dark backgrounds */
    input::placeholder,
    textarea::placeholder {
      color: rgba(255, 255, 255, 0.6) !important;
      opacity: 1;
    }

    .wizard-container {
      max-width: 1000px;
      width: 100%;
      background: var(--card-bg);
      border-radius: var(--radius-2xl);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
      min-height: 650px;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    /* Header & Progress */
    .w-header {
      padding: var(--spacing-xl) var(--spacing-2xl);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(10, 25, 47, 0.95) 0%, rgba(17, 34, 64, 0.95) 100%);
      backdrop-filter: blur(10px);
    }

    .w-header img {
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
      transition: transform var(--transition-base);
    }

    .w-header img:hover {
      transform: scale(1.02);
    }

    .progress-track {
      height: 6px;
      background: var(--border);
      width: 100%;
      margin-top: 0;
      position: relative;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
      width: 0%;
      transition: width var(--transition-slow);
      box-shadow: var(--shadow-glow);
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    /* Step Content */
    .step-content {
      flex-grow: 1;
      padding: var(--spacing-2xl);
      display: none;
      animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .step-content.active {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(24px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Typography Improvements */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    h1 {
      font-size: 2.5rem;
    }

    h2 {
      font-size: 2rem;
      color: var(--text-main);
    }

    h3 {
      font-size: 1.75rem;
      color: var(--text-main);
    }

    p {
      line-height: 1.6;
      color: var(--text-secondary);
    }

    small {
      color: var(--text-muted);
    }

    /* Map Specifics */
    #map-container {
      width: 100%;
      height: 450px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--border);
      position: relative;
      background: #000;
      /* Loading state */
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* Inputs & UI */
    .search-lg {
      background: transparent;
      border: 2px solid var(--border);
      color: white;
      font-size: 1.2rem;
      padding: 15px 20px;
      border-radius: 12px;
      width: 100%;
      transition: all 0.3s;
    }

    .search-lg:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 20px rgba(255, 153, 0, 0.1);
    }

    .option-card {
      background: linear-gradient(135deg, var(--card-elevated) 0%, var(--card-bg) 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      cursor: pointer;
      transition: all var(--transition-base);
      text-align: center;
      height: 100%;
      user-select: none;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(255, 153, 0, 0.3);
    }

    .option-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0;
      transition: opacity var(--transition-base);
    }

    .option-card:hover {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--card-elevated) 0%, rgba(255, 153, 0, 0.05) 100%);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      transform: translateY(-4px);
    }

    .option-card:hover::before {
      opacity: 1;
    }

    .option-card.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 153, 0, 0.1) 0%, var(--card-elevated) 100%);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      transform: translateY(-2px);
    }

    .option-card.selected::before {
      opacity: 1;
    }

    .option-card:active {
      transform: translateY(0) scale(0.98);
    }

    .option-card .img-3d {
      max-height: 180px;
      width: auto;
      filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.3));
      transition: all 0.3s ease;
    }

    /* Ensure Danosa image fits well */
    #serviceImg {
      max-height: 180px;
      object-fit: contain;
    }

    .option-card:hover img {
      transform: scale(1.05);
    }

    /* 3D Asset Style */
    .img-3d {
      max-height: 200px;
      animation: float 5s ease-in-out infinite;
      /* Seamless Solid Style */
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
    }

    @keyframes float {
      0% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-10px);
      }

      100% {
        transform: translateY(0px);
      }
    }

    /* Professional Button System */
    .btn {
      font-weight: 600;
      transition: all var(--transition-base);
      user-select: none;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-lg);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:active::before {
      width: 300px;
      height: 300px;
    }

    /* Warning Button (Continuar, etc) */
    .btn-warning {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border: none;
      color: #000;
      font-weight: 700;
      box-shadow: var(--shadow-md), var(--shadow-glow);
      transition: all var(--transition-base);
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, var(--accent) 100%);
      box-shadow: var(--shadow-lg), 0 0 30px rgba(255, 153, 0, 0.4);
      transform: translateY(-2px);
    }

    .btn-warning:active {
      transform: translateY(0);
    }

    /* Primary Button */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      color: white;
      font-weight: 700;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    /* Summary Specific */
    .summary-table td {
      color: var(--text-muted);
      padding: 10px 0;
      font-size: 0.95rem;
    }

    .summary-table .price {
      color: white;
      text-align: right;
      font-family: 'Inter', monospace;
      font-size: 1.15rem;
      font-weight: 600;
    }

    /* Professional quote header on step 6 */
    #step6 h3 {
      text-transform: uppercase;
      font-weight: 800;
    }

    /* Improved total box */
    #step6 .total-row {
      border-top: 1px solid var(--border);
      margin-top: 10px;
      padding-top: 10px;
      font-size: 1.5rem;
      color: var(--accent);
      font-weight: 800;
      display: flex;
      justify-content: space-between;
    }

    /* Mobile Responsiveness - Better Design */
    @media (max-width: 768px) {
      body {
        padding: 0 !important;
        margin: 0 !important;
        background-color: var(--card-bg);
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        justify-content: flex-start !important;
        align-items: stretch !important;
      }

      .wizard-container {
        border-radius: 0;
        border: none;
        box-shadow: none;
        height: 100vh;
        height: 100dvh;
        min-height: 100vh;
        min-height: 100dvh;
        max-height: 100vh;
        max-height: 100dvh;
        display: flex;
        flex-direction: column;
        max-width: 100%;
        width: 100%;
        overflow: hidden;
        margin: 0 !important;
      }

      /* Compact header for mobile */
      .w-header {
        padding: 8px 15px;
        flex-wrap: nowrap;
        gap: 0;
        flex-shrink: 0;
      }

      .w-header img {
        max-height: 180px !important;
      }

      .w-header .small {
        display: none !important;
      }

      .progress-track {
        height: 4px;
      }

      #backButtonContainer {
        flex-shrink: 0;
        padding: 5px 15px !important;
      }

      #backButtonContainer .btn {
        padding: 6px 12px !important;
        font-size: 0.85rem !important;
      }

      /* Step content - NO SCROLL by default */
      .step-content {
        padding: 10px;
        overflow: hidden !important;
        display: none !important;
      }

      .step-content.active {
        display: flex !important;
        flex: 1;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 10px;
      }

      /* Remove excessive padding on mobile */
      .step-content .px-5 {
        padding-left: 10px !important;
        padding-right: 10px !important;
      }

      .step-content .my-auto {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
      }

      .step-content.active > div {
        width: 100%;
      }

      /* ONLY contact form, calendar, and quote need scrolling */
      #step6.active,
      #step7.active,
      #step2B.active {
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
        justify-content: flex-start !important;
      }

      /* Typography */
      h2 {
        font-size: 1.1rem !important;
        margin-bottom: 1rem !important;
      }

      h3 {
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
      }

      h5 {
        font-size: 0.95rem !important;
      }

      p.text-muted {
        font-size: 0.85rem !important;
        margin-bottom: 0.5rem !important;
      }

      /* Option cards - compact and visible */
      .option-card {
        padding: 15px 10px;
        min-height: auto;
        height: 140px;
        border-width: 2px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      .option-card h1 {
        font-size: 2rem !important;
        margin-bottom: 5px !important;
        line-height: 1;
      }

      .option-card h3 {
        font-size: 0.85rem !important;
        margin-top: 8px !important;
        margin-bottom: 3px !important;
        white-space: nowrap;
      }

      .option-card h5 {
        font-size: 0.85rem !important;
        margin-top: 8px !important;
        margin-bottom: 3px !important;
      }

      .option-card small {
        font-size: 0.7rem !important;
        line-height: 1.2;
        text-align: center;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Images in cards - visible */
      .option-card .img-3d,
      .option-card img {
        max-height: 50px !important;
        margin-bottom: 5px !important;
      }

      #serviceImg {
        max-height: 60px !important;
      }

      /* Large images at top of steps 3, 4, 5 - make smaller */
      #step3 > div > .img-3d,
      #step4 > div > .img-3d,
      #step5 > div > .img-3d {
        max-height: 100px !important;
        max-width: 120px !important;
        margin-bottom: 10px !important;
      }

      /* Grid spacing */
      .row.g-3, .row.g-4 {
        --bs-gutter-y: 10px;
        --bs-gutter-x: 10px;
        margin: 0 !important;
      }

      /* Step 1, 3, 4, 5 - 2 cards side by side */
      #step1 .row,
      #step3 .row,
      #step4 .row,
      #step5 .row {
        flex-wrap: nowrap !important;
        width: 100%;
      }

      #step1 .col-md-5,
      #step3 .col-md-5,
      #step4 .col-md-5,
      #step5 .col-md-4,
      #step5 .col-md-5 {
        flex: 0 0 50% !important;
        max-width: 50% !important;
        padding: 5px !important;
      }

      /* Step 5 service cards - need more space for text */
      #step5 .option-card h5 {
        font-size: 0.75rem !important;
        white-space: nowrap;
      }

      /* Step 5 - hide image and make title smaller when Danosa options visible */
      #step5 h3 {
        font-size: 1rem !important;
        margin-bottom: 8px !important;
      }

      /* Danosa options - compact on mobile */
      #danosaOptions {
        margin-top: 8px !important;
        padding: 8px !important;
      }

      #danosaOptions p {
        font-size: 0.8rem !important;
        margin-bottom: 6px !important;
      }

      #danosaOptions .btn-sm {
        padding: 4px 12px !important;
        font-size: 0.75rem !important;
      }

      #danosaContinueBtn {
        padding: 10px !important;
        font-size: 0.9rem !important;
        margin-top: 8px !important;
      }

      /* Cards in steps 3, 4, 4B - smaller height since no image inside */
      #step3 .option-card,
      #step4 .option-card,
      #step4B .option-card {
        height: 80px !important;
        min-height: auto !important;
        padding: 10px 8px !important;
      }

      /* Step 4B (AC) - 2 cards side by side */
      #step4B .row {
        flex-wrap: nowrap !important;
        width: 100%;
      }

      #step4B .col-md-5 {
        flex: 0 0 50% !important;
        max-width: 50% !important;
        padding: 5px !important;
      }

      /* Step 2A specific */
      #step2A h3 {
        margin-bottom: 1rem !important;
      }

      #step2A p.text-muted {
        margin-bottom: 0.5rem !important;
      }

      #map-container {
        height: 35vh;
      }

      .search-lg {
        font-size: 1.1rem;
        padding: 12px 15px;
      }

      /* Summary table improvements */
      .summary-table td {
        padding: 8px 0;
        font-size: 0.9rem;
      }

      .summary-table .price {
        font-size: 1rem;
      }

      /* Contact form step */
      #step6 h3 {
        font-size: 1.2rem !important;
      }

      #step6 .total-row {
        font-size: 1.1rem;
        padding-top: 12px;
      }

      /* Quote content box */
      #quoteContent {
        padding: 15px !important;
      }

      /* Input improvements */
      input[type="number"] {
        font-size: 1.3rem !important;
        padding: 15px !important;
        text-align: center;
        -webkit-appearance: none;
        -moz-appearance: textfield;
      }

      /* Remove spinner from number inputs */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* Floating area badge on map */
      #map-container .position-absolute {
        max-width: 95% !important;
        margin: 10px !important;
      }

      /* Calendar iframe */
      #step2B .flex-grow-1 {
        min-height: 70vh !important;
      }

      /* Danosa options */
      #danosaOptions {
        padding: 12px !important;
        margin-top: 12px !important;
      }

      #danosaOptions h5 {
        font-size: 0.9rem !important;
        margin-bottom: 10px !important;
      }

      #danosaOptions .btn {
        padding: 10px 15px !important;
        font-size: 0.85rem !important;
        min-height: 44px;
      }

      /* Layer adjustment buttons */
      #layersInput .btn {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
        padding: 0;
      }

      #layersInput #layerCount {
        font-size: 1.5rem !important;
        min-width: 55px;
      }

      /* Action buttons */
      .btn-warning {
        font-size: 1rem !important;
        padding: 12px 25px !important;
        min-height: 48px;
      }

      /* PDF Download button */
      .btn-success {
        font-size: 0.95rem !important;
        padding: 12px 20px !important;
        min-height: 46px;
      }

      /* Better text sizing */
      p {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      small {
        font-size: 0.75rem !important;
      }

      /* Margins reset */
      .mb-4 {
        margin-bottom: 1rem !important;
      }

      .mt-3 {
        margin-top: 0.75rem !important;
      }

      /* Prevent zoom on focus for iOS */
      select,
      textarea,
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="tel"] {
        font-size: 16px !important;
      }
    }

    /* Extra small devices (phones in portrait) */
    @media (max-width: 576px) {
      .w-header img {
        max-height: 140px !important;
      }

      .w-header {
        padding: 5px 10px !important;
      }

      h2 {
        font-size: 1rem !important;
      }

      h3 {
        font-size: 0.95rem !important;
      }

      .option-card {
        padding: 12px 8px;
        height: 130px;
      }

      .option-card h1 {
        font-size: 1.8rem !important;
        margin-bottom: 3px !important;
      }

      .option-card h3,
      .option-card h5 {
        font-size: 0.8rem !important;
        margin-top: 6px !important;
      }

      .option-card small {
        font-size: 0.65rem !important;
        display: block;
        line-height: 1.1;
      }

      .option-card .img-3d,
      .option-card img {
        max-height: 45px !important;
      }

      /* Large images at top of steps 3, 4, 5 - even smaller */
      #step3 > div > .img-3d,
      #step4 > div > .img-3d,
      #step5 > div > .img-3d {
        max-height: 80px !important;
        max-width: 100px !important;
        margin-bottom: 8px !important;
      }

      /* Cards in steps 3, 4, 4B - smaller */
      #step3 .option-card,
      #step4 .option-card,
      #step4B .option-card {
        height: 70px !important;
      }

      /* Step 4B col-md-5 fix */
      #step4B .col-md-5 {
        flex: 0 0 50% !important;
        max-width: 50% !important;
        padding: 4px !important;
      }

      /* Step 5 (service) col-md-4 fix */
      #step5 .col-md-4 {
        flex: 0 0 50% !important;
        max-width: 50% !important;
        padding: 4px !important;
      }

      #step5 .option-card h5 {
        font-size: 0.7rem !important;
      }

      .total-row {
        font-size: 0.95rem;
        flex-direction: column;
        align-items: flex-end;
        gap: 3px;
      }

      input[type="number"] {
        font-size: 1.2rem !important;
        padding: 12px !important;
      }

      #quoteContent {
        padding: 12px !important;
      }

      #quoteContent table {
        font-size: 0.85rem;
      }

      /* Buttons */
      .btn-warning {
        font-size: 0.95rem !important;
        padding: 10px 20px !important;
        min-height: 44px;
      }

      #danosaOptions {
        padding: 10px !important;
        margin-top: 10px !important;
      }

      #danosaOptions .d-flex {
        gap: 6px !important;
      }

      #danosaOptions .btn {
        padding: 8px 10px !important;
        font-size: 0.75rem !important;
        min-height: 38px;
      }

      #layersInput {
        margin-top: 8px !important;
      }

      #layersInput .btn {
        width: 34px;
        height: 34px;
        font-size: 1rem;
      }

      #layersInput #layerCount {
        font-size: 1.2rem !important;
        min-width: 40px;
      }
    }

    /* Modal improvements for mobile */
    @media (max-width: 768px) {
      .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
      }

      .modal-content {
        border-radius: 15px;
      }

      .modal-body {
        padding: 20px;
        font-size: 1rem;
        line-height: 1.6;
      }

      .modal-header {
        padding: 15px 20px;
      }

      .modal-title {
        font-size: 1.25rem !important;
      }

      .btn-close {
        font-size: 1.2rem;
        padding: 10px;
      }
    }

    /* Landscape mobile optimization */
    @media (max-width: 896px) and (orientation: landscape) {
      .wizard-container {
        max-height: 100vh;
        overflow-y: auto;
      }

      .step-content {
        padding: 15px;
      }

      .img-3d {
        max-height: 100px !important;
      }

      .option-card {
        padding: 15px 10px;
        min-height: 100px;
      }

      h3 {
        font-size: 1.1rem !important;
      }
    }

    /* Chat widget accommodation */
    /* Ensure chat widget doesn't cover important content */
    @media (max-width: 768px) {
      /* Add safe area for chat widget on mobile */
      .wizard-container {
        padding-bottom: 80px;
        /* Space for chat widget bubble */
      }

      /* Ensure summary content doesn't get hidden */
      #step6 {
        padding-bottom: 100px !important;
      }

      /* Step 5C - Location step (all mobile devices) */
      #step5C {
        padding: 8px 12px !important;
        overflow: visible !important;
      }

      #step5C .location-container {
        display: flex;
        flex-direction: column;
        height: auto;
      }

      #step5C .location-icon {
        font-size: 1.2rem;
      }

      #step5C h3 {
        font-size: 1rem !important;
        margin-bottom: 8px !important;
      }

      #step5C p.text-muted {
        font-size: 0.7rem !important;
        margin-bottom: 4px !important;
      }

      #step5C #autoLocationBtn {
        padding: 10px 12px !important;
        font-size: 0.85rem !important;
        margin-bottom: 8px !important;
      }

      #step5C #locationSearch {
        padding: 10px 12px !important;
        font-size: 0.85rem !important;
      }

      #step5C #locationMapContainer {
        height: 35vh !important;
        max-height: 200px !important;
        min-height: 140px !important;
        margin-bottom: 8px !important;
      }

      #step5C #selectedAddress {
        font-size: 0.7rem !important;
        margin-bottom: 8px !important;
        padding: 8px 10px;
        background: rgba(255, 153, 0, 0.1);
        border-radius: 8px;
        line-height: 1.3;
      }

      #step5C #locationContinueBtn {
        padding: 14px 16px !important;
        font-size: 1rem !important;
      }

      /* Step 1B - Location for Calendar flow (same as step5C) */
      #step1B {
        padding: 8px 12px !important;
        overflow: visible !important;
      }

      #step1B .location-container {
        display: flex;
        flex-direction: column;
        height: auto;
      }

      #step1B h3 {
        font-size: 1rem !important;
        margin-bottom: 8px !important;
      }

      #step1B p.text-muted {
        font-size: 0.7rem !important;
        margin-bottom: 4px !important;
      }

      #step1B #autoLocationBtnCal {
        padding: 10px 12px !important;
        font-size: 0.85rem !important;
        margin-bottom: 8px !important;
      }

      #step1B #locationSearchCal {
        padding: 10px 12px !important;
        font-size: 0.85rem !important;
      }

      #step1B #locationMapContainerCal {
        height: 35vh !important;
        max-height: 200px !important;
        min-height: 140px !important;
        margin-bottom: 8px !important;
      }

      #step1B #selectedAddressCal {
        font-size: 0.7rem !important;
        margin-bottom: 8px !important;
        padding: 8px 10px;
        background: rgba(255, 153, 0, 0.1);
        border-radius: 8px;
      }

      #step1B #locationContinueBtnCal {
        padding: 14px 16px !important;
        font-size: 1rem !important;
      }
    }

    /* Desktop chat widget spacing */
    @media (min-width: 769px) {
      /* Ensure PDF button and actions don't overlap with chat */
      #step6 .col-md-8 {
        padding-right: 120px;
        /* Space for chat widget on right side */
      }
    }

    /* ========================================
       HEIGHT-BASED BREAKPOINTS FOR SMALL PHONES
       iPhone SE/8: ~667px height in browser
       iPhone 5/SE1: ~568px height
       ======================================== */

    /* Medium-small height devices (iPhone SE, iPhone 8, etc.) */
    @media (max-width: 768px) and (max-height: 700px) {
      .wizard-container {
        padding-bottom: 60px;
      }

      .w-header {
        padding: 6px 10px !important;
      }

      .w-header img {
        max-height: 120px !important;
      }

      h3 {
        font-size: 0.9rem !important;
        margin-bottom: 8px !important;
      }

      /* Hide large step images on small height screens */
      #step3 > div > .img-3d,
      #step4 > div > .img-3d,
      #step4B > div > h1,
      #step5 > div > .img-3d {
        max-height: 50px !important;
        max-width: 60px !important;
        margin-bottom: 5px !important;
      }

      /* Smaller cards */
      .option-card {
        height: auto !important;
        min-height: 60px !important;
        padding: 8px 6px !important;
      }

      #step3 .option-card,
      #step4 .option-card,
      #step4B .option-card {
        height: 60px !important;
        min-height: auto !important;
      }

      .option-card h5 {
        font-size: 0.75rem !important;
        margin-top: 4px !important;
        margin-bottom: 2px !important;
      }

      .option-card small {
        font-size: 0.6rem !important;
      }

      /* Danosa options - much more compact */
      #danosaOptions {
        padding: 8px !important;
        margin-top: 8px !important;
      }

      #danosaOptions h5 {
        font-size: 0.8rem !important;
        margin-bottom: 6px !important;
      }

      #danosaOptions p {
        font-size: 0.75rem !important;
        margin-bottom: 6px !important;
      }

      #danosaOptions .d-flex {
        gap: 4px !important;
      }

      #danosaOptions .btn {
        padding: 6px 8px !important;
        font-size: 0.7rem !important;
        min-height: 32px !important;
      }

      #layersInput {
        margin-top: 6px !important;
      }

      #layersInput .btn {
        width: 30px !important;
        height: 30px !important;
        font-size: 0.9rem !important;
      }

      #layersInput #layerCount {
        font-size: 1rem !important;
        min-width: 35px !important;
      }

      /* Step 5 specific - service cards */
      #step5 .option-card {
        height: 65px !important;
        min-height: auto !important;
      }

      #step5 .option-card h5 {
        font-size: 0.65rem !important;
      }

      #step5 .option-card small {
        font-size: 0.55rem !important;
      }

      /* Step 5C - Location step (medium-small height) */
      #step5C h3 {
        font-size: 0.9rem !important;
        margin-bottom: 4px !important;
      }

      #step5C .location-icon {
        font-size: 1rem !important;
      }

      #step5C p.text-muted {
        font-size: 0.65rem !important;
        margin-bottom: 3px !important;
      }

      #step5C #autoLocationBtn {
        padding: 8px 10px !important;
        font-size: 0.8rem !important;
        margin-bottom: 4px !important;
      }

      #step5C #locationSearch {
        padding: 8px 10px !important;
        font-size: 0.8rem !important;
      }

      #step5C #locationMapContainer {
        height: 28vh !important;
        max-height: 150px !important;
        min-height: 100px !important;
        margin-bottom: 6px !important;
      }

      #step5C #selectedAddress {
        font-size: 0.65rem !important;
        margin-bottom: 6px !important;
        padding: 5px 8px !important;
      }

      #step5C #locationContinueBtn {
        padding: 10px 12px !important;
        font-size: 0.85rem !important;
      }

      /* Row spacing */
      .row.g-3, .row.g-4 {
        --bs-gutter-y: 6px !important;
        --bs-gutter-x: 6px !important;
      }

      /* Back button */
      #backButtonContainer {
        padding-top: 4px !important;
      }
    }

    /* Very small height devices (iPhone 5/SE1, small Android) */
    @media (max-width: 768px) and (max-height: 600px) {
      .wizard-container {
        padding-bottom: 50px;
      }

      .w-header {
        padding: 5px 8px !important;
      }

      .w-header img {
        max-height: 100px !important;
      }

      h3 {
        font-size: 0.85rem !important;
        margin-bottom: 5px !important;
      }

      /* Hide images completely on very small screens */
      #step3 > div > .img-3d,
      #step4 > div > .img-3d,
      #step4B > div > h1,
      #step5 > div > .img-3d {
        display: none !important;
      }

      /* Even smaller cards */
      .option-card {
        min-height: 50px !important;
        padding: 6px 5px !important;
      }

      #step3 .option-card,
      #step4 .option-card,
      #step4B .option-card {
        height: 50px !important;
      }

      #step5 .option-card {
        height: 55px !important;
      }

      .option-card h5 {
        font-size: 0.7rem !important;
        margin-top: 3px !important;
      }

      .option-card small {
        font-size: 0.55rem !important;
        line-height: 1 !important;
      }

      /* Ultra compact danosa options */
      #danosaOptions {
        padding: 6px !important;
        margin-top: 5px !important;
      }

      #danosaOptions h5 {
        font-size: 0.75rem !important;
        margin-bottom: 4px !important;
      }

      #danosaOptions p {
        font-size: 0.7rem !important;
        margin-bottom: 4px !important;
      }

      #danosaOptions .btn {
        padding: 5px 6px !important;
        font-size: 0.65rem !important;
        min-height: 28px !important;
      }

      #layersInput .btn {
        width: 26px !important;
        height: 26px !important;
        font-size: 0.85rem !important;
      }

      #layersInput #layerCount {
        font-size: 0.9rem !important;
        min-width: 30px !important;
      }

      /* Step 5C - Location step (very small screens) */
      #step5C h3 {
        font-size: 0.8rem !important;
        margin-bottom: 2px !important;
      }

      #step5C .location-icon {
        font-size: 0.9rem !important;
      }

      #step5C p.text-muted {
        font-size: 0.6rem !important;
        margin-bottom: 2px !important;
      }

      #step5C #autoLocationBtn {
        padding: 6px 8px !important;
        font-size: 0.75rem !important;
        margin-bottom: 3px !important;
      }

      #step5C #locationSearch {
        padding: 6px 8px !important;
        font-size: 0.75rem !important;
      }

      #step5C #locationMapContainer {
        height: 22vh !important;
        max-height: 120px !important;
        min-height: 80px !important;
        margin-bottom: 4px !important;
      }

      #step5C #selectedAddress {
        font-size: 0.6rem !important;
        margin-bottom: 4px !important;
        padding: 4px 6px !important;
      }

      #step5C #locationContinueBtn {
        padding: 8px 10px !important;
        font-size: 0.8rem !important;
      }

      /* Row spacing */
      .row.g-3, .row.g-4 {
        --bs-gutter-y: 4px !important;
        --bs-gutter-x: 4px !important;
      }
    }
  </style>

  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '957533069392232');
    fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=957533069392232&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->
</head>

<body>

  <div class="wizard-container">

    <!-- Header -->
    <div class="w-header">
      <img src="assets/logo_white_ps.png" alt="Sella El Techo"
        style="max-height: 100px; width: auto; object-fit: contain;">
      <div class="text-muted small" id="stepCounter">Paso <span id="stepCount" class="font-monospace">1</span> de 9</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Back Button -->
    <div class="px-3 pt-2" id="backButtonContainer" style="display: none;">
      <button class="btn btn-link text-muted p-0" id="btnPrev" type="button" onclick="changeStep(-1)">
        <span style="font-size: 14px;">‚Üê Atr√°s</span>
      </button>
    </div>

    <!-- STEP 1: Qualification -->
    <div class="step-content active" id="step1">
      <div class="text-center my-auto px-5">
        <h2 class="mb-4">¬øConoces los pies cuadrados de tu techo?</h2>
        <div class="row justify-content-center g-4">
          <div class="col-md-5">
            <div class="option-card" onclick="setKnowsSqFt(true, this)">
              <h1 class="mb-0">‚úÖ</h1>
              <h3 class="mt-3">S√≠, los conozco</h3>
              <small class="text-muted">Ingresar medidas manuales</small>
            </div>
          </div>
          <div class="col-md-5">
            <div class="option-card" onclick="setKnowsSqFt(false, this)">
              <h1 class="mb-0">‚ùå</h1>
              <h3 class="mt-3">No, necesito ayuda</h3>
              <small class="text-muted">Agendar cita con un experto</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2A: Manual Input (YES path) -->
    <div class="step-content" id="step2A">
      <div class="text-center my-auto px-5">
        <h3 class="mb-4">Ingresa el tama√±o del techo</h3>
        <div class="d-flex justify-content-center align-items-center gap-3">
          <input type="number" id="inputSqFt" class="search-lg text-center" placeholder="1500" style="width: 200px;" min="100" step="1">
          <span class="fs-4 text-muted">ft¬≤</span>
        </div>
        <p class="text-muted mt-3">Ingresa el √°rea total a sellar.</p>
        <button class="btn btn-warning fw-bold px-5 mt-3" onclick="confirmManualSqFt()">Continuar ‚û°Ô∏è</button>
        <!-- Debug info -->
        <div id="debugArea" class="mt-3 small text-warning" style="display:none;"></div>
      </div>
    </div>

    <!-- STEP 1B: Location for Calendar Flow (before scheduling) -->
    <div class="step-content" id="step1B">
      <div class="text-center location-container">
        <h3 class="mb-1"><span class="location-icon">üìç</span> ¬øD√≥nde est√° la propiedad?</h3>
        <p class="text-muted small mb-2">Necesitamos saber d√≥nde ir para la inspecci√≥n</p>

        <!-- Auto-location button -->
        <button type="button" class="btn btn-outline-warning w-100 py-2 mb-2" id="autoLocationBtnCal" onclick="autoLocateForCalendar()">
          <span id="autoLocateBtnTextCal">üìç Usar mi ubicaci√≥n actual</span>
          <span id="autoLocateSpinnerCal" style="display:none;">
            <span class="spinner-border spinner-border-sm me-2"></span>Localizando...
          </span>
        </button>

        <p class="text-muted small mb-1">‚Äî o escribe la direcci√≥n ‚Äî</p>

        <div class="mb-2">
          <input type="text" id="locationSearchCal" class="form-control search-lg"
            placeholder="Escribe la direcci√≥n..."
            style="background: var(--card-bg); color: white; border-color: var(--accent);">
        </div>

        <div id="locationMapContainerCal" class="mb-2"
          style="height: 200px; border-radius: 12px; overflow: hidden; border: 2px solid var(--accent);">
          <div id="locationMapCal" style="width: 100%; height: 100%;"></div>
        </div>

        <p id="selectedAddressCal" class="text-warning small mb-2" style="display:none;">
          <strong>üìç</strong> <span id="addressTextCal"></span>
        </p>

        <button type="button" class="btn btn-warning w-100 py-2 fw-bold" id="locationContinueBtnCal"
          onclick="confirmLocationForCalendar()" style="display:none;">
          Continuar ‚Üí
        </button>
      </div>
    </div>

    <!-- STEP 1C: Contact Info before Calendar -->
    <div class="step-content" id="step1C">
      <div class="text-center">
        <h3 class="mb-2">üìã Tu Informaci√≥n</h3>
        <p class="text-muted small mb-3">Para guardar tu ubicaci√≥n y agendar la inspecci√≥n</p>

        <div class="mx-auto" style="max-width: 400px;">
          <div class="mb-3">
            <input type="text" id="calContactName" class="form-control search-lg"
              placeholder="Nombre completo"
              style="background: var(--card-bg); color: white; border-color: var(--accent);">
          </div>

          <div class="mb-3">
            <input type="email" id="calContactEmail" class="form-control search-lg"
              placeholder="Email"
              style="background: var(--card-bg); color: white; border-color: var(--accent);">
          </div>

          <div class="mb-3">
            <input type="tel" id="calContactPhone" class="form-control search-lg"
              placeholder="Tel√©fono (787) 123-4567"
              style="background: var(--card-bg); color: white; border-color: var(--accent);">
          </div>

          <p id="calContactStatus" class="small text-warning mb-3" style="display: none;"></p>

          <button type="button" class="btn btn-warning w-100 py-2 fw-bold" onclick="createContactAndShowCalendar()">
            <span id="calContactBtnText">Continuar a Agendar Cita ‚Üí</span>
            <span id="calContactSpinner" style="display:none;">
              <span class="spinner-border spinner-border-sm me-2"></span>Guardando...
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- STEP 2B: Calendar (NO path) -->
    <div class="step-content" id="step2B">
      <div class="text-center h-100 d-flex flex-column">
        <h3 class="mb-2">Agenda tu Inspecci√≥n</h3>
        <p class="text-muted mb-3">Uno de nuestros expertos te visitar√° para medir.</p>

        <!-- CALENDAR EMBED -->
        <div class="flex-grow-1 border border-secondary rounded"
          style="background: #fff; min-height: 700px; -webkit-overflow-scrolling: touch;">
          <iframe src="https://api.leadconnectorhq.com/widget/booking/hSO8bJXNuwvua7DybRJ7"
            style="width: 100%; height: 700px; min-height: 700px; border:none; touch-action: pan-y;"
            scrolling="yes"
            allow="geolocation"
            id="hSO8bJXNuwvua7DybRJ7_1769897386462">
          </iframe>
          <script src="https://link.msgsndr.com/js/form_embed.js" type="text/javascript"></script>
        </div>
      </div>
    </div>

    <!-- Hidden Step 2 Legacy Map (Preserved but Hidden) -->
    <div class="step-content" id="stepMapHidden" style="display:none!important">
      <div class="step-content" id="step2">
        <div class="row h-100">
          <div class="col-12 mb-3">
            <div class="d-flex justify-content-between align-items-end mb-2">
              <div>
                <h3 class="mb-1">Selecciona el Techo</h3>
                <p class="text-muted small m-0">Haz clic en la casa para detectar. O usa modo manual.</p>
              </div>
              <button id="btnDrawToggle" class="btn btn-sm btn-outline-secondary" onclick="toggleDrawMode()">‚úèÔ∏è Dibujar
                Manual</button>
            </div>
            <script>
              let manualMode = false;
              function toggleDrawMode() {
                manualMode = !manualMode;
                if (window.setManualDraw) window.setManualDraw(manualMode);
                const btn = document.getElementById('btnDrawToggle');
                if (manualMode) {
                  btn.className = 'btn btn-sm btn-primary';
                  btn.innerText = 'üëÜ Volver a Auto';
                } else {
                  btn.className = 'btn btn-sm btn-outline-secondary';
                  btn.innerText = '‚úèÔ∏è Dibujar Manual';
                }
              }
            </script>
          </div>
          <div class="col-12">
            <div id="map-container">
              <div id="map"></div>

              <!-- Floating Area Badge -->
              <!-- Floating Area Badge -->
              <div
                class="position-absolute bottom-0 end-0 m-3 bg-dark text-white p-3 rounded shadow border border-secondary"
                style="max-width: 280px; z-index: 1000;">
                <small class="text-muted d-block uppercase" style="font-size:0.7em;">Area Promedio Estimada</small>
                <div class="fw-bold fs-3 text-warning mb-2 lh-1"><span id="liveArea">0</span> <small
                    class="fs-6 text-white">ft¬≤</small></div>

                <div class="small border-top border-secondary pt-2 mb-2">
                  <div class="d-flex justify-content-between">
                    <span class="text-muted">üì° Sat√©lite:</span>
                    <span id="valSat" class="fw-bold text-light">-</span>
                  </div>
                </div>

                <div class="mt-2 text-end border-top border-secondary pt-2">
                  <button class="btn btn-warning w-100 fw-bold" onclick="changeStep(1)">
                    ‚úÖ Confirmar y Seguir
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- STEP 3: Cistern -->
    <div class="step-content" id="step3">
      <div class="text-center my-auto">
        <img src="assets/cistern.png" class="img-3d img-fluid mb-4">
        <h3 class="mb-3">¬øCu√°ntas Cisternas Tienes?</h3>
        <p class="text-muted mb-3">$250 por cada cisterna</p>
        <div class="d-flex justify-content-center align-items-center gap-3 mb-4">
          <button class="btn btn-outline-light btn-lg px-4" onclick="adjustCistern(-1)">-</button>
          <span id="cisternCount" class="display-4 fw-bold text-warning px-4">0</span>
          <button class="btn btn-outline-light btn-lg px-4" onclick="adjustCistern(1)">+</button>
        </div>
        <button class="btn btn-warning w-50 py-2 fw-bold" onclick="confirmCistern()">
          Continuar ‚Üí
        </button>
      </div>
    </div>

    <!-- STEP 4: Solar -->
    <div class="step-content" id="step4">
      <div class="text-center my-auto">
        <img src="assets/solar.png" class="img-3d img-fluid mb-4">
        <h3 class="mb-3">¬øPlacas Solares?</h3>
        <div class="row justify-content-center g-3">
          <div class="col-md-5">
            <div class="option-card" onclick="setOption('solar', false, this)">
              <h5 class="mt-2">No</h5>
              <small class="text-muted">Sin sistema solar</small>
            </div>
          </div>
          <div class="col-md-5">
            <div class="option-card" onclick="setOption('solar', true, this)">
              <h5 class="mt-2">S√≠ (+$1,000)</h5>
              <small class="text-muted">Protecci√≥n especial</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 4B: Air Conditioning -->
    <div class="step-content" id="step4B">
      <div class="text-center my-auto">
        <h1 class="mb-3">‚ùÑÔ∏è</h1>
        <h3 class="mb-3">¬øCu√°ntos Aires Acondicionados en el Techo?</h3>
        <p class="text-muted mb-3">$250 por cada unidad</p>
        <div class="d-flex justify-content-center align-items-center gap-3 mb-4">
          <button class="btn btn-outline-light btn-lg px-4" onclick="adjustAC(-1)">-</button>
          <span id="acCount" class="display-4 fw-bold text-warning px-4">0</span>
          <button class="btn btn-outline-light btn-lg px-4" onclick="adjustAC(1)">+</button>
        </div>
        <button class="btn btn-warning w-50 py-2 fw-bold" onclick="confirmAC()">
          Continuar ‚Üí
        </button>
      </div>
    </div>

    <!-- STEP 5: Service Type -->
    <div class="step-content" id="step5">
      <div class="text-center my-auto">
        <img src="assets/service.png" id="serviceImg" class="img-3d img-fluid mb-2">
        <h3 class="mb-2">Tipo de Sellado</h3>

        <div class="row justify-content-center g-2 mb-2">
          <div class="col-md-4">
            <div class="option-card" onclick="setOption('service', 'Silicona', this)">
              <h5 class="mt-1 text-warning">Silicona 100%</h5>
              <small class="text-muted">Premium Reflectivo</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="option-card" onclick="setOption('service', 'Danosa', this)">
              <h5 class="mt-1">Danosa</h5>
              <small class="text-muted">Membrana Asf√°ltica</small>
            </div>
          </div>
        </div>

        <!-- DANOSA EXTRA OPTIONS - Compact layout -->
        <div id="danosaOptions" class="mt-2 p-2 border border-secondary rounded"
          style="display:none; background: rgba(255,153,0,0.05);">
          <p class="small text-warning mb-2 fw-bold">¬øRemover membrana vieja?</p>

          <div class="d-flex justify-content-center gap-2 mb-2">
            <button class="btn btn-outline-light btn-sm px-3" onclick="setRemoval(false, this)">No</button>
            <button class="btn btn-outline-light btn-sm px-3" onclick="setRemoval(true, this)">S√≠, remover</button>
          </div>

          <div id="layersInput" style="display:none;">
            <div class="d-flex justify-content-center align-items-center gap-2 mb-1">
              <small class="text-muted">Capas:</small>
              <button class="btn btn-secondary btn-sm py-0 px-2" onclick="adjLayers(-1)">-</button>
              <span id="layerCount" class="fw-bold px-2">1</span>
              <button class="btn btn-secondary btn-sm py-0 px-2" onclick="adjLayers(1)">+</button>
            </div>
            <small class="text-warning">*1ra incluida. $1/ft¬≤ extra por capa.</small>
          </div>

          <button id="danosaContinueBtn" class="btn btn-warning w-100 mt-2 py-2 fw-bold" onclick="continueFromDanosa()">
            Continuar ‚Üí
          </button>
        </div>

      </div>
    </div>

    <!-- STEP 5C: Location / Pin -->
    <div class="step-content" id="step5C">
      <div class="text-center location-container">
        <h3 class="mb-1"><span class="location-icon">üìç</span> ¬øD√≥nde est√° la propiedad?</h3>

        <!-- Auto-location button -->
        <button type="button" class="btn btn-outline-warning w-100 py-2 mb-2" id="autoLocationBtn" onclick="autoLocate()">
          <span id="autoLocateBtnText">üìç Usar mi ubicaci√≥n actual</span>
          <span id="autoLocateSpinner" style="display:none;">
            <span class="spinner-border spinner-border-sm me-2"></span>Localizando...
          </span>
        </button>

        <p class="text-muted small mb-1">‚Äî o escribe la direcci√≥n ‚Äî</p>

        <div class="mb-2">
          <input type="text" id="locationSearch" class="form-control search-lg"
            placeholder="Escribe la direcci√≥n..."
            style="background: var(--card-bg); color: white; border-color: var(--accent);">
        </div>

        <div id="locationMapContainer" class="mb-2"
          style="height: 200px; border-radius: 12px; overflow: hidden; border: 2px solid var(--accent);">
          <div id="locationMap" style="width: 100%; height: 100%;"></div>
        </div>

        <p id="selectedAddress" class="text-warning small mb-2" style="display:none;">
          <strong>üìç</strong> <span id="addressText"></span>
        </p>

        <button type="button" class="btn btn-warning w-100 py-2 fw-bold" id="locationContinueBtn"
          onclick="confirmLocation()" style="display:none;">
          Confirmar Ubicaci√≥n ‚Üí
        </button>
      </div>
    </div>

    <!-- STEP 6: Contact Information (NEW) -->
    <div class="step-content" id="step6">
      <div class="row justify-content-center h-100 align-items-center">
        <div class="col-md-7">
          <div class="text-center mb-4">
            <h3 class="mb-2">üìã Informaci√≥n de Contacto</h3>
            <p class="text-secondary">Para enviarte tu cotizaci√≥n y coordinar el servicio</p>
          </div>

          <div class="p-4 rounded border border-warning" style="background: linear-gradient(135deg, var(--card-elevated) 0%, var(--card-bg) 100%);">
            <form id="contactForm" onsubmit="return false;">
              <div class="mb-3">
                <label for="contactName" class="form-label text-light">Nombre Completo *</label>
                <input type="text" class="form-control search-lg" id="contactName" required
                  placeholder="Juan P√©rez" style="background: var(--card-bg); color: white;">
              </div>

              <div class="mb-3">
                <label for="contactEmail" class="form-label text-light">Email *</label>
                <input type="email" class="form-control search-lg" id="contactEmail" required
                  placeholder="juan@email.com" style="background: var(--card-bg); color: white;">
              </div>

              <div class="mb-3">
                <label for="contactPhone" class="form-label text-light">Tel√©fono *</label>
                <input type="tel" class="form-control search-lg" id="contactPhone" required
                  placeholder="(787) 123-4567" style="background: var(--card-bg); color: white;">
              </div>

              <div class="mb-3">
                <label for="contactAddress" class="form-label text-light">Direcci√≥n de la Propiedad</label>
                <textarea class="form-control search-lg" id="contactAddress" rows="2"
                  placeholder="Calle, Ciudad, PR" style="background: var(--card-bg); color: white;"></textarea>
                <small class="text-muted">Opcional - ayuda para la inspecci√≥n</small>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="contactConsent" required
                  style="width: 20px; height: 20px; cursor: pointer;">
                <label class="form-check-label text-secondary ms-2" for="contactConsent" style="cursor: pointer;">
                  Acepto recibir informaci√≥n sobre mi cotizaci√≥n y servicios de Sella El Techo
                </label>
              </div>

              <button type="button" class="btn btn-warning w-100 py-3 fw-bold" onclick="submitContactAndProceed()">
                ‚úÖ Confirmar y Ver Cotizaci√≥n
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 7: Quote Summary (renamed from step6) -->
    <div class="step-content" id="step7">
      <div class="row justify-content-center h-100">
        <div class="col-md-8">
          <!-- Debug alert for missing area -->
          <div id="areaWarning" class="alert alert-danger mb-3" style="display:none;">
            <strong>‚ö†Ô∏è ERROR:</strong> No se detect√≥ el √°rea del techo.<br>
            <small>state.area = <span id="debugStateArea">0</span></small><br>
            <small>window.manualArea = <span id="debugWindowArea">0</span></small><br>
            <small>DOM input = <span id="debugDomInput">N/A</span></small>
          </div>

          <!-- Invoice status notification -->
          <div id="invoiceWarning" class="alert alert-warning mb-3" style="display:none;">
            <strong>‚ö†Ô∏è Nota:</strong> No se pudo crear el invoice autom√°ticamente.
            Tu cotizaci√≥n fue guardada y te contactaremos pronto.
            <br><small id="invoiceErrorDetail" class="text-muted"></small>
          </div>
          <div id="invoiceSuccess" class="alert alert-success mb-3" style="display:none;">
            <strong>‚úÖ</strong> Invoice creado exitosamente en el sistema.
          </div>

          <!-- Professional Quote Design -->
          <div class="rounded-3 overflow-hidden" style="background: #0d1b2a; border: 1px solid rgba(255,153,0,0.3);" id="quoteContent">

            <!-- Header -->
            <div class="p-4 text-center" style="background: linear-gradient(135deg, #1b2838 0%, #0d1b2a 100%); border-bottom: 3px solid #ff9900;">
              <h2 class="text-warning fw-bold mb-1" style="letter-spacing: 2px; font-size: 1.5rem;">SELLA EL TECHO</h2>
              <p class="text-muted small mb-0">Sellado Profesional de Techos en Puerto Rico</p>
            </div>

            <!-- Quote Title & Date -->
            <div class="px-4 py-3 d-flex justify-content-between align-items-center" style="background: rgba(255,153,0,0.05);">
              <div>
                <span class="text-warning fw-bold" style="font-size: 1.1rem;">ESTIMADO</span>
                <span class="text-muted ms-2 small">#<span id="quoteNumber">---</span></span>
              </div>
              <div class="text-end">
                <span class="text-muted small" id="quoteDate"></span>
              </div>
            </div>

            <!-- Quote Body -->
            <div class="p-4">

              <!-- Area Section -->
              <div class="mb-4">
                <h6 class="text-muted text-uppercase small mb-3" style="letter-spacing: 1px;">Medidas del Techo</h6>
                <table class="w-100">
                  <tr>
                    <td class="py-2 text-light">√Årea del Techo</td>
                    <td class="py-2 text-end text-light"><span id="sumAreaRaw">0</span> ft¬≤</td>
                  </tr>
                  <tr class="text-muted" style="font-size: 0.85rem;">
                    <td class="py-1" style="padding-left: 15px;">+ Material de Seguridad (<span id="lblWaste">15</span>%)</td>
                    <td class="py-1 text-end">+<span id="sumWaste">0</span> ft¬≤</td>
                  </tr>
                </table>
                <div class="mt-2 p-2 rounded" style="background: rgba(255,153,0,0.1); border-left: 3px solid #ff9900;">
                  <div class="d-flex justify-content-between">
                    <span class="text-light fw-semibold">Material Requerido</span>
                    <span class="text-warning fw-bold" id="sumeffectiveArea">0 ft¬≤</span>
                  </div>
                </div>
              </div>

              <!-- Services Section -->
              <div class="mb-4">
                <h6 class="text-muted text-uppercase small mb-3" style="letter-spacing: 1px;">Servicios</h6>
                <table class="w-100">
                  <tr>
                    <td class="py-2 text-light">Sellado de Techo (<span id="serviceTypeLabel">Silicone</span>)</td>
                    <td class="py-2 text-end text-light" id="sumBase">$0.00</td>
                  </tr>
                  <tr id="rowCistern" style="display:none">
                    <td class="py-2 text-light" id="lblCistern">Manejo de Cisterna</td>
                    <td class="py-2 text-end text-warning" id="sumCistern">+$0.00</td>
                  </tr>
                  <tr id="rowSolar" style="display:none">
                    <td class="py-2 text-light">Desmontaje de Placas Solares</td>
                    <td class="py-2 text-end text-warning">+$1,000.00</td>
                  </tr>
                  <tr id="rowAC" style="display:none">
                    <td class="py-2 text-light" id="lblAC">Protecci√≥n de Aire Acondicionado</td>
                    <td class="py-2 text-end text-warning" id="sumAC">+$0.00</td>
                  </tr>
                  <tr id="rowRemoval" style="display:none">
                    <td class="py-2 text-light" id="lblRemoval">Remoci√≥n de Membranas</td>
                    <td class="py-2 text-end text-warning" id="sumRemoval">+$0.00</td>
                  </tr>
                </table>
              </div>

              <!-- Divider -->
              <hr style="border-color: rgba(255,255,255,0.1); margin: 0;">

              <!-- Tax -->
              <div class="py-3">
                <div class="d-flex justify-content-between text-muted">
                  <span>IVU (11.5%)</span>
                  <span id="sumTax">$0.00</span>
                </div>
              </div>

              <!-- Total -->
              <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(255,153,0,0.15) 0%, rgba(255,153,0,0.05) 100%); border: 2px solid #ff9900;">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-light fw-bold" style="font-size: 1.1rem;">TOTAL ESTIMADO</span>
                  <span id="sumTotal" class="text-warning fw-bold" style="font-size: 1.75rem;">$0.00</span>
                </div>
              </div>

              <!-- Disclaimer -->
              <p class="text-muted text-center small mt-3 mb-0">
                * Precio sujeto a verificaci√≥n en inspecci√≥n f√≠sica
              </p>
            </div>
          </div>

          <div class="text-center mt-4 d-grid gap-2">
            <button id="btnContract" class="btn btn-warning py-3 fw-bold" onclick="requestContract()">üìÑ Recibir Contrato</button>
            <button id="btnShowCalendar" class="btn btn-primary py-3 fw-bold" onclick="showWorkCalendar()">üìÖ Agendar Inspecci√≥n Gratuita</button>
          </div>

          <!-- Calendar for scheduling (hidden initially) -->
          <div id="workCalendarSection" class="mt-4" style="display: none;">
            <h4 class="text-center text-warning mb-3">üìÖ Agendar Inspecci√≥n Gratuita</h4>
            <div class="border border-warning rounded" style="background: #fff; overflow: hidden;">
              <iframe src="https://api.leadconnectorhq.com/widget/booking/hSO8bJXNuwvua7DybRJ7"
                style="width: 100%; height: 600px; border:none;"
                scrolling="yes"
                id="hSO8bJXNuwvua7DybRJ7_inspection">
              </iframe>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS (Required for Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Logic -->
  <script src="js/map_logic.js?v=fix_loc_final"></script>
  <!-- Google Maps API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBR72tWGSonQu3eMgfcEUZdDiAcqaQ_bhA&libraries=places,drawing,geometry&callback=initMap"
    async defer></script>

  <script>
    let currentStep = 1;
    const totalSteps = 9;
    const state = {
      address: '',
      area: 0,
      cistern: 0,  // Number of cisterns ($250 each)
      solar: null,
      ac: 0,  // Number of AC units ($250 each)
      service: null,
      // New fields
      knowsSqFt: null,
      removal: false,
      layers: 1,
      // Location fields
      pinLocation: null,  // { lat, lng, address, mapsUrl }
      locationMap: null,
      locationMarker: null,
      manualOverride: false
    };

    // --- NEW LOGIC START ---

    let previousStepForCalendar = 1;

    function goToCalendar(originStep) {
      previousStepForCalendar = originStep;
      showStep('step2B');
      currentStep = 99; // Calendar Mode
      updateSteps();
    }

    function setKnowsSqFt(knows, el) {
      console.log("setKnowsSqFt clicked:", knows);
      state.knowsSqFt = knows;

      // Visual feedback
      const cards = document.querySelectorAll('#step1 .option-card');
      cards.forEach(c => c.classList.remove('selected'));
      if (el) el.classList.add('selected');

      setTimeout(() => {
        if (knows) {
          // Go to Manual Input
          showStep('step2A');
          currentStep = 2; // technical mapping
        } else {
          // Go to Location step first, then Calendar
          showStep('step1B');
          currentStep = 98; // Location before Calendar mode
          initLocationMapForCalendar();
        }
        updateSteps();
      }, 300);
    }

    function confirmManualSqFt() {
      const input = document.getElementById('inputSqFt');
      const val = parseFloat(input.value);

      console.log("confirmManualSqFt() called with input value:", input.value);
      console.log("Parsed value:", val);

      if (!val || val < 100) {
        alert("Por favor ingresa un tama√±o v√°lido (min 100 ft).");
        return;
      }

      // STRICT STATE SETTING - Triple redundancy to ensure persistence
      state.area = val;
      state.knowsSqFt = true;
      state.manualOverride = true; // Flag to prevent map from overwriting
      window.manualArea = val;

      console.log("‚úÖ CONFIRMED MANUAL AREA:", val);
      console.log("State after confirmation:", {
        area: state.area,
        knowsSqFt: state.knowsSqFt,
        manualOverride: state.manualOverride,
        windowManualArea: window.manualArea
      });

      // Show debug info
      const debugDiv = document.getElementById('debugArea');
      if (debugDiv) {
        debugDiv.style.display = 'block';
        debugDiv.innerHTML = `‚úÖ √Årea capturada: ${val} ft¬≤ (state.area: ${state.area}, window.manualArea: ${window.manualArea})`;
      }

      // NAVIGATE TO STEP 3
      currentStep = 3;
      showStep('step3'); // Explicit ID
      updateSteps();
    }

    // Submit contact form and create GoHighLevel contact
    async function submitContactAndProceed() {
      console.log("submitContactAndProceed() called");

      // 1. Validate form
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();
      const formAddress = document.getElementById('contactAddress').value.trim();
      // Use pin location address if form address is empty
      const address = formAddress || (state.pinLocation?.address || '');
      const consent = document.getElementById('contactConsent').checked;

      if (!name || !email || !phone) {
        alert('‚ö†Ô∏è Por favor completa todos los campos requeridos (Nombre, Email, Tel√©fono)');
        return;
      }

      if (!consent) {
        alert('‚ö†Ô∏è Debes aceptar recibir informaci√≥n para continuar');
        return;
      }

      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('‚ö†Ô∏è Por favor ingresa un email v√°lido');
        return;
      }

      // Phone validation (basic)
      if (phone.length < 10) {
        alert('‚ö†Ô∏è Por favor ingresa un tel√©fono v√°lido');
        return;
      }

      // 2. Calculate quote total
      let finalArea = state.area || window.manualArea || 0;
      if (finalArea === 0) {
        alert('‚ö†Ô∏è Error: No se detect√≥ el √°rea del techo. Por favor regresa y completa los pasos anteriores.');
        return;
      }

      // Calculate rates
      let baseRate = 3.50; // Silicona - $3.50/ft¬≤
      let surchargeRate = 0;

      if (state.service === 'Danosa') {
        baseRate = 3.50; // Danosa - $3.50/ft¬≤
        if (state.removal && state.layers >= 2) {
          surchargeRate = (state.layers - 1) * 1.00;
        }
      }

      const totalRate = baseRate + surchargeRate;
      const materialCost = finalArea * totalRate;
      const cisternCost = state.cistern * 250.00;  // $250 per cistern
      const solarCost = state.solar ? 1000.00 : 0;
      const acCost = state.ac * 250.00;  // $250 per AC unit
      const subtotal = materialCost + cisternCost + solarCost + acCost;
      const tax = subtotal * 0.115;
      const grandTotal = subtotal + tax;

      // 3. Show loading state
      const submitBtn = document.querySelector('#contactForm button[type="button"]');
      const originalText = submitBtn.innerText;
      submitBtn.innerText = '‚è≥ Enviando...';
      submitBtn.disabled = true;

      try {
        // 4. Send to GoHighLevel API
        const ghlToken = 'pit-f3ebb971-2fd1-415b-91f0-f4449c8e5314';
        const ghlLocationId = 'LVwbqYFEmGiKJ7AgtSIf';
        const ghlApiUrl = 'https://services.leadconnectorhq.com/contacts/';

        // Parse name - handle multiple spaces and edge cases
        const nameParts = name.trim().split(/\s+/);
        const firstName = nameParts[0] || name;
        const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';

        // Create notes with all quote information
        const quoteNotes = `
üìã COTIZACI√ìN GENERADA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìç Direcci√≥n: ${address || 'No proporcionada'}
üìê √Årea: ${Math.round(finalArea)} pies cuadrados
üîß Servicio: ${state.service || 'No seleccionado'}

üí∞ DESGLOSE DE PRECIOS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Precio por pie: $${totalRate.toFixed(2)}
‚Ä¢ Costo Material: $${materialCost.toFixed(2)}
‚Ä¢ Cisterna: $${cisternCost.toFixed(2)}
‚Ä¢ Placas Solares: $${solarCost.toFixed(2)}
‚Ä¢ Subtotal: $${subtotal.toFixed(2)}
‚Ä¢ IVU (11.5%): $${tax.toFixed(2)}
‚Ä¢ TOTAL: $${grandTotal.toFixed(2)}

üè† DETALLES ADICIONALES:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Cisternas: ${state.cistern} ($250 c/u)
‚Ä¢ Tiene Placas Solares: ${state.solar ? 'S√≠' : 'No'}
‚Ä¢ Aires Acondicionados: ${state.ac} ($250 c/u)
‚Ä¢ Requiere Remoci√≥n: ${state.removal ? 'S√≠' : 'No'}
‚Ä¢ Capas de Remoci√≥n: ${state.layers || 1}
${state.pinLocation?.mapsUrl ? `
üìç UBICACI√ìN EN MAPA:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${state.pinLocation.mapsUrl}` : ''}

üìÖ Fecha: ${new Date().toLocaleString('es-PR')}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        `.trim();

        const contactData = {
          locationId: ghlLocationId,
          firstName: firstName,
          lastName: lastName,
          email: email,
          phone: phone,
          address1: address || '',
          source: 'Cotizador Online',
          tags: ['cotizador-online', state.service ? state.service.toLowerCase() : 'sin-servicio'],
          customFields: [
            { id: 'JVE4U8McHgJfAV20nSNH', value: String(Math.round(finalArea)) },
            { id: 'KNWSmZs63hL2jMXNZvpM', value: String(grandTotal.toFixed(2)) },
            { id: 'qDVGDd879hOARK6M6Uax', value: state.cistern > 0 ? 'Si' : 'No' },
            { id: 'D1yRe3BskNRgAtGbK7gJ', value: state.solar === true ? 'Si' : 'No' },
            { id: '6wqy3fR4Osdt6xk55udZ', value: state.ac > 0 ? 'Si' : 'No' },
            { id: 'usGrA7qJvXwrjZiU7kZh', value: state.service === 'Danosa' ? 'Danosa' : 'Silicone' },
            { id: 'VA7E6Ir1bk0zBqpbQ4Mb', value: state.removal === true ? 'Si' : 'No' },
            { id: 'j4FfurcAXnA7O8rCjv4z', value: String(state.layers || 1) },
            { id: 'X8GLbec6WrfimB9lR4XV', value: state.pinLocation?.mapsUrl || '' }
          ]
        };

        console.log("üì§ Sending to GHL:", contactData);
        console.log("üìã Custom Fields being sent:");
        console.log("  - Pies Cuadrados (JVE4U8McHgJfAV20nSNH):", String(Math.round(finalArea)));
        console.log("  - Valor Cotizacion (KNWSmZs63hL2jMXNZvpM):", String(grandTotal.toFixed(2)));
        console.log("  - Cisterna (qDVGDd879hOARK6M6Uax):", state.cistern > 0 ? 'Si' : 'No');
        console.log("  - Placas Solares (D1yRe3BskNRgAtGbK7gJ):", state.solar === true ? 'Si' : 'No');
        console.log("  - Aire Acondicionado (6wqy3fR4Osdt6xk55udZ):", state.ac > 0 ? 'Si' : 'No');
        console.log("  - Material (usGrA7qJvXwrjZiU7kZh):", state.service === 'Danosa' ? 'Danosa' : 'Silicone');
        console.log("  - Remocion (VA7E6Ir1bk0zBqpbQ4Mb):", state.removal === true ? 'Si' : 'No', '| state.removal =', state.removal);
        console.log("  - Capas (j4FfurcAXnA7O8rCjv4z):", String(state.layers || 1));
        console.log("  - Pin Location (X8GLbec6WrfimB9lR4XV):", state.pinLocation?.mapsUrl || '(vac√≠o)');

        const response = await fetch(ghlApiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ghlToken}`,
            'Content-Type': 'application/json',
            'Version': '2021-07-28'
          },
          body: JSON.stringify(contactData)
        });

        let result;
        let contactId;

        if (!response.ok) {
          const errorData = await response.json();
          console.log('GHL Response:', errorData);

          // If duplicate contact, update existing one
          if (response.status === 400 && errorData.meta?.contactId) {
            console.log('üìù Contact exists, updating...', errorData.meta.contactId);
            contactId = errorData.meta.contactId;

            // Update existing contact - remove locationId (not allowed in PUT)
            const { locationId, ...updateData } = contactData;
            const updateResponse = await fetch(`${ghlApiUrl}${contactId}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${ghlToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
              },
              body: JSON.stringify(updateData)
            });

            if (updateResponse.ok) {
              result = await updateResponse.json();
              console.log('‚úÖ Contact updated in GHL:', result);
              // Also try to get contactId from update response
              if (!contactId && result.contact?.id) {
                contactId = result.contact.id;
              }
            } else {
              console.error('Update failed:', await updateResponse.text());
              throw new Error(`Error del servidor: ${updateResponse.status}`);
            }
          } else {
            throw new Error(`Error del servidor: ${response.status}`);
          }
        } else {
          result = await response.json();
          // Try multiple paths to get contactId
          contactId = result.contact?.id || result.id || result.contactId;
          console.log('‚úÖ Contact created in GHL:', result);
          console.log('üìã Extracted contactId:', contactId);
        }

        // FALLBACK: If we still don't have contactId, search by email
        if (!contactId && email) {
          console.log('üîç ContactId not found, searching by email...');
          try {
            const searchResponse = await fetch(
              `https://services.leadconnectorhq.com/contacts/?locationId=${ghlLocationId}&query=${encodeURIComponent(email)}&limit=1`,
              {
                headers: {
                  'Authorization': `Bearer ${ghlToken}`,
                  'Version': '2021-07-28'
                }
              }
            );
            if (searchResponse.ok) {
              const searchResult = await searchResponse.json();
              if (searchResult.contacts && searchResult.contacts.length > 0) {
                contactId = searchResult.contacts[0].id;
                console.log('‚úÖ Found contact by email search:', contactId);
              }
            }
          } catch (searchError) {
            console.warn('‚ö†Ô∏è Contact search failed:', searchError.message);
          }
        }

        console.log('üìå Final contactId for invoice:', contactId);

        // 4b. Add note to contact with quote details
        if (contactId) {
          try {
            const noteResponse = await fetch(`https://services.leadconnectorhq.com/contacts/${contactId}/notes`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${ghlToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
              },
              body: JSON.stringify({
                body: quoteNotes
              })
            });
            if (noteResponse.ok) {
              console.log('‚úÖ Note added to contact');
            } else {
              console.warn('‚ö†Ô∏è Could not add note:', await noteResponse.text());
            }
          } catch (noteError) {
            console.warn('‚ö†Ô∏è Note creation failed:', noteError.message);
          }
        }

        // 5. Send quote data to webhook
        const webhookUrl = 'https://services.leadconnectorhq.com/hooks/LVwbqYFEmGiKJ7AgtSIf/webhook-trigger/b275a7d9-e59e-4a55-9380-bc2a2bd33248';

        const quoteData = {
          // Contact Information
          contactId: contactId || null,
          nombre: name,
          email: email,
          telefono: phone,
          direccion: address || '',

          // Quote Details
          area_pies_cuadrados: Math.round(finalArea),
          tipo_servicio: state.service || 'No seleccionado',

          // Pricing Breakdown
          precio_por_pie: totalRate,
          costo_material: materialCost.toFixed(2),
          costo_cisterna: cisternCost.toFixed(2),
          costo_solar: solarCost.toFixed(2),
          subtotal: subtotal.toFixed(2),
          ivu: tax.toFixed(2),
          total: grandTotal.toFixed(2),

          // Additional Options
          tiene_cisterna: state.cistern > 0,
          tiene_ac: state.ac > 0,
          tiene_placas_solares: state.solar ? true : false,
          requiere_remocion: state.removal ? true : false,
          capas_remocion: state.layers || 1,

          // Metadata
          fuente: 'Cotizador Online',
          fecha_cotizacion: new Date().toISOString(),
          url_origen: window.location.href
        };

        console.log("Sending quote to webhook:", quoteData);

        // Send to webhook - await to ensure it completes
        try {
          const webhookResponse = await fetch(webhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(quoteData)
          });
          console.log('‚úÖ Quote sent to webhook, status:', webhookResponse.status);
        } catch (webhookError) {
          // If CORS fails, try with no-cors (won't get response but data is sent)
          console.warn('‚ö†Ô∏è Webhook CORS error, retrying with no-cors:', webhookError.message);
          try {
            await fetch(webhookUrl, {
              method: 'POST',
              body: JSON.stringify(quoteData),
              mode: 'no-cors'
            });
            console.log('‚úÖ Quote sent to webhook (no-cors fallback)');
          } catch (fallbackError) {
            console.error('‚ö†Ô∏è Webhook fallback also failed:', fallbackError);
          }
        }

        // 6. Create Invoice in Draft status
        // IMPORTANT: Only proceed if we have a valid contactId
        if (!contactId) {
          console.error('‚ùå No contactId available - cannot create invoice');
          console.log('Attempting one more search by email...');

          // Last attempt to find contact
          try {
            const finalSearchResponse = await fetch(
              `https://services.leadconnectorhq.com/contacts/?locationId=${ghlLocationId}&query=${encodeURIComponent(email)}&limit=1`,
              {
                headers: {
                  'Authorization': `Bearer ${ghlToken}`,
                  'Version': '2021-07-28'
                }
              }
            );
            if (finalSearchResponse.ok) {
              const finalSearchResult = await finalSearchResponse.json();
              if (finalSearchResult.contacts && finalSearchResult.contacts.length > 0) {
                contactId = finalSearchResult.contacts[0].id;
                console.log('‚úÖ Found contact in final search:', contactId);
              }
            }
          } catch (e) {
            console.error('Final search failed:', e);
          }
        }

        if (contactId) {
          // Wait a moment for GHL to fully process the contact
          console.log('‚è≥ Waiting for GHL to process contact...');
          await new Promise(resolve => setTimeout(resolve, 1500));

          // Verify contact exists before creating invoice
          try {
            const verifyResponse = await fetch(
              `https://services.leadconnectorhq.com/contacts/${contactId}`,
              {
                headers: {
                  'Authorization': `Bearer ${ghlToken}`,
                  'Version': '2021-07-28'
                }
              }
            );
            if (verifyResponse.ok) {
              console.log('‚úÖ Contact verified, proceeding with invoice creation');
            } else {
              console.warn('‚ö†Ô∏è Contact verification failed, but proceeding anyway');
            }
          } catch (verifyError) {
            console.warn('‚ö†Ô∏è Could not verify contact:', verifyError.message);
          }

          // Validate contactId before creating invoice
          if (!contactId || typeof contactId !== 'string' || contactId.length < 5) {
            console.error('‚ùå Invalid contactId for invoice:', contactId);
            state.invoiceErrorMsg = 'ContactId inv√°lido - no se puede crear invoice';
            throw new Error('Invalid contactId');
          }

          try {
            const invoiceApiUrl = 'https://services.leadconnectorhq.com/invoices/';

            // Sanitize string to ASCII only (removes accents and special chars)
            const sanitize = (str) => {
              return String(str || '')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')  // Remove accents
                .replace(/[^\x20-\x7E]/g, '')     // Keep only printable ASCII
                .trim()
                .substring(0, 100);
            };

            // Ensure number is a valid integer
            const safeInt = (num) => {
              const n = Number(num);
              return isNaN(n) ? 0 : Math.round(Math.abs(n));
            };

            // Build detailed line items for the invoice
            const invoiceItems = [];

            // Main service item
            invoiceItems.push({
              name: sanitize(`Sellado de Techo - ${state.service || 'Profesional'}`),
              description: sanitize(`Area: ${Math.round(finalArea)} ft2 x $${totalRate.toFixed(2)}/ft2`),
              amount: safeInt(materialCost),
              qty: 1,
              currency: 'USD',
              taxes: []
            });

            // Cistern if applicable (quantity-based, $250 each)
            if (state.cistern > 0) {
              invoiceItems.push({
                name: sanitize(`Manejo de ${state.cistern} Cisterna${state.cistern > 1 ? 's' : ''}`),
                description: sanitize(`${state.cistern} cisterna${state.cistern > 1 ? 's' : ''} x $250`),
                amount: 250,
                qty: state.cistern,
                currency: 'USD',
                taxes: []
              });
            }

            // Solar panels if applicable
            if (state.solar) {
              invoiceItems.push({
                name: sanitize('Desmontaje Placas Solares'),
                description: sanitize('Remocion de placas solares'),
                amount: 1000,
                qty: 1,
                currency: 'USD',
                taxes: []
              });
            }

            // Air conditioning if applicable (quantity-based, $250 each)
            if (state.ac > 0) {
              invoiceItems.push({
                name: sanitize(`Proteccion de ${state.ac} Aire${state.ac > 1 ? 's' : ''} Acondicionado${state.ac > 1 ? 's' : ''}`),
                description: sanitize(`${state.ac} unidad${state.ac > 1 ? 'es' : ''} AC x $250`),
                amount: 250,
                qty: state.ac,
                currency: 'USD',
                taxes: []
              });
            }

            // Membrane removal surcharge if applicable
            if (state.service === 'Danosa' && state.removal && state.layers >= 2) {
              const extraLayers = state.layers - 1;
              const removalCost = extraLayers * 1.00 * finalArea;
              invoiceItems.push({
                name: sanitize(`Remocion de ${extraLayers} Membranas`),
                description: sanitize(`${extraLayers} capas adicionales x $1.00/ft2`),
                amount: safeInt(removalCost),
                qty: 1,
                currency: 'USD',
                taxes: []
              });
            }

            // IVU Tax item
            invoiceItems.push({
              name: sanitize('IVU 11.5%'),
              description: sanitize('Impuesto sobre Ventas y Uso'),
              amount: safeInt(tax),
              qty: 1,
              currency: 'USD',
              taxes: []
            });

            // Calculate dates in YYYY-MM-DD format
            const today = new Date();
            const issueDate = today.toISOString().split('T')[0];
            const dueDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // Format phone for E.164
            const formatPhoneE164 = (p) => {
              const digits = String(p || '').replace(/\D/g, '');
              if (digits.length === 0) return '+17870000000';
              return digits.startsWith('1') ? `+${digits}` : `+1${digits}`;
            };

            // Required business details
            const businessDetails = {
              name: 'Sella El Techo',
              phone: '+17879876543',
              email: 'info@sellaeltecho.com'
            };

            // Required contact details - must include id!
            const contactDetails = {
              id: String(contactId),
              name: sanitize(name || 'Cliente'),
              email: sanitize(email || 'cliente@email.com'),
              phone: formatPhoneE164(phone)
            };

            // Base invoice data with ALL required fields
            const baseInvoice = {
              altId: String(ghlLocationId),
              altType: 'location',
              contactId: String(contactId),
              name: 'Cotizacion Sellado de Techo',
              title: 'COTIZACION',
              status: 'draft',
              currency: 'USD',
              issueDate: issueDate,
              dueDate: dueDate,
              businessDetails: businessDetails,
              contactDetails: contactDetails,
              items: invoiceItems
            };

            let invoiceCreated = false;

            console.log('üìÑ Creating invoice with payload:', JSON.stringify(baseInvoice, null, 2));

            // Try up to 3 times with retry
            let lastError = '';
            for (let attempt = 1; attempt <= 3 && !invoiceCreated; attempt++) {
              try {
                console.log(`üìÑ Invoice attempt ${attempt}/3...`);

                const response = await fetch(invoiceApiUrl, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${ghlToken}`,
                    'Content-Type': 'application/json',
                    'Version': '2021-07-28'
                  },
                  body: JSON.stringify(baseInvoice)
                });

                if (response.ok) {
                  const result = await response.json();
                  console.log('‚úÖ Invoice created successfully:', result);
                  state.invoiceId = result.invoice?.id || result.id || result._id;
                  state.invoiceError = false;
                  state.invoiceErrorMsg = null;
                  invoiceCreated = true;
                } else {
                  const errText = await response.text();
                  lastError = `Status ${response.status}: ${errText}`;
                  console.warn(`Attempt ${attempt} failed:`, lastError);

                  // If 4xx error, don't retry (bad request)
                  if (response.status >= 400 && response.status < 500) {
                    console.error('Client error, stopping retries. Error:', lastError);
                    state.invoiceErrorMsg = lastError;
                    break;
                  }
                }
              } catch (err) {
                lastError = `Network error: ${err.message}`;
                console.warn(`Attempt ${attempt} network error:`, err.message);
              }

              // Wait before retry
              if (!invoiceCreated && attempt < 3) {
                await new Promise(r => setTimeout(r, 1000 * attempt));
              }
            }

            // Track invoice creation status
            if (invoiceCreated) {
              console.log('‚úÖ Invoice created successfully!');
              state.invoiceError = false;
              state.invoiceErrorMsg = null;
            } else {
              console.warn('‚ö†Ô∏è Invoice not created after 3 attempts. Last error:', lastError);
              state.invoiceError = true;
              state.invoiceErrorMsg = lastError || 'No se pudo crear el invoice despu√©s de 3 intentos';
            }
          } catch (invoiceError) {
            console.error('‚ö†Ô∏è Invoice creation error:', invoiceError);
            state.invoiceError = true;
            state.invoiceErrorMsg = invoiceError.message || 'Error desconocido';
          }
        } else {
          console.error('‚ùå Cannot create invoice - no contactId available');
          state.invoiceError = true;
          state.invoiceErrorMsg = 'No se encontr√≥ el contactId';
        }

        // Log final state for debugging
        console.log('=== FINAL SUBMISSION STATE ===');
        console.log('contactId:', contactId);
        console.log('invoiceId:', state.invoiceId);
        console.log('invoiceError:', state.invoiceError);

        // 7. Store contact info in state for display
        state.contactName = name;
        state.contactEmail = email;
        state.contactPhone = phone;
        state.contactAddress = address;

        // 8. Fire Meta Pixel Lead Event - Contact info submitted successfully
        if (typeof fbq === 'function') {
          fbq('track', 'Lead', {
            content_name: state.service || 'Cotizaci√≥n',
            content_category: 'Sellado de Techo',
            value: grandTotal,
            currency: 'USD'
          });
          console.log('üìä Meta Pixel: Lead event fired');
        }

        // 9. Navigate to Step 9 (Final Quote Summary)
        currentStep = 9;
        showStep('step7');
        updateSteps();

        // Show invoice status to user
        const invoiceWarning = document.getElementById('invoiceWarning');
        const invoiceSuccess = document.getElementById('invoiceSuccess');
        const invoiceErrorDetail = document.getElementById('invoiceErrorDetail');
        if (state.invoiceError) {
          if (invoiceWarning) invoiceWarning.style.display = 'block';
          if (invoiceSuccess) invoiceSuccess.style.display = 'none';
          if (invoiceErrorDetail && state.invoiceErrorMsg) {
            invoiceErrorDetail.textContent = `Debug: ${state.invoiceErrorMsg}`;
          }
        } else if (state.invoiceId) {
          if (invoiceWarning) invoiceWarning.style.display = 'none';
          if (invoiceSuccess) invoiceSuccess.style.display = 'block';
        }

      } catch (error) {
        console.error('Error creating contact:', error);
        alert('‚ö†Ô∏è Hubo un problema al enviar tu informaci√≥n. Por favor intenta de nuevo o cont√°ctanos directamente.\n\nError: ' + error.message);

        // Restore button state
        submitBtn.innerText = originalText;
        submitBtn.disabled = false;
      }
    }

    // ...

    function renderSummary() {
      console.log("--- RENDER SUMMARY (ROBUST REWRITE) ---");
      console.log("DEBUG: state.area =", state.area);
      console.log("DEBUG: window.manualArea =", window.manualArea);
      console.log("DEBUG: state.knowsSqFt =", state.knowsSqFt);
      console.log("DEBUG: state =", JSON.stringify(state));

      // Update debug display
      const inputEl = document.getElementById('inputSqFt');
      const inputValue = inputEl ? inputEl.value : 'N/A';

      document.getElementById('debugStateArea').innerText = state.area || '0 (undefined)';
      document.getElementById('debugWindowArea').innerText = window.manualArea || '0 (undefined)';
      document.getElementById('debugDomInput').innerText = inputValue;

      // 1. RESOLVE AREA
      // Priority: State -> Window Global -> DOM Input
      let finalArea = state.area;

      if (!finalArea || finalArea === 0) {
        console.log("DEBUG: state.area is 0 or empty, trying window.manualArea");
        if (typeof window.manualArea === 'number' && window.manualArea > 0) {
          finalArea = window.manualArea;
          console.log("DEBUG: Using window.manualArea =", finalArea);
        }
      }

      // Fallback 2: Read DOM Input directly (Crucial for "User entered footage" handling)
      if (!finalArea || finalArea === 0) {
        console.log("DEBUG: Trying to read from DOM input");
        if (inputEl && inputEl.value) {
          const val = parseFloat(inputEl.value);
          if (val > 0) {
            finalArea = val;
            console.log("DEBUG: Using DOM input value =", finalArea);
            // Update state to preserve this value
            state.area = val;
            window.manualArea = val;
          }
        }
      }

      // Final Validity Check
      if (!finalArea || finalArea === 0) {
        console.error("‚ùå ERROR: Area could not be resolved. It is 0.");
        console.error("DEBUG: All fallbacks failed!");

        // Show warning alert
        document.getElementById('areaWarning').style.display = 'block';

        // Display error message
        document.getElementById('sumBase').innerText = "$0.00 (Falta √Årea)";
        document.getElementById('sumTax').innerText = "$0.00";
        document.getElementById('sumTotal').innerText = "$0.00";
        return; // Stop processing if no area is available
      }

      // Hide warning if area found
      document.getElementById('areaWarning').style.display = 'none';

      console.log("‚úÖ SUCCESS: finalArea resolved to:", finalArea);

      // 2. CALCULATE RATES & SURCHARGES
      let baseRate = 3.50; // Default - $3.50/ft¬≤ for both Silicona and Danosa
      let removalCost = 0;

      console.log("Service type:", state.service);

      if (state.service === 'Danosa') {
        baseRate = 3.50;
        console.log("‚úÖ Danosa selected - Using $3.50 per ft¬≤");
        // Logic: Removal adds $1.00/ft¬≤ per extra layer (starting from 2nd layer)
        if (state.removal && state.layers >= 2) {
          const extraLayers = state.layers - 1;
          removalCost = extraLayers * 1.00 * finalArea;
          console.log(`Adding removal cost: ${extraLayers} layer(s) √ó $1.00/ft¬≤ √ó ${finalArea} ft¬≤ = $${removalCost.toFixed(2)}`);
        }
      } else {
        console.log("‚úÖ Silicona selected - Using $3.50 per ft¬≤");
      }

      const materialCost = finalArea * baseRate;

      console.log("Calculation breakdown:");
      console.log(`  Base rate: $${baseRate}/ft¬≤`);
      console.log(`  Area: ${finalArea} ft¬≤`);
      console.log(`  Material cost: $${materialCost.toFixed(2)}`);
      console.log(`  Removal cost: $${removalCost.toFixed(2)}`);

      // 3. FIXED COSTS
      const cisternCost = state.cistern * 250.00;  // $250 per cistern
      const solarCost = state.solar ? 1000.00 : 0;
      const acCost = state.ac * 250.00;  // $250 per AC unit

      console.log("Add-ons:");
      console.log(`  Cisternas: ${state.cistern} x $250 = $${cisternCost}`);
      console.log(`  Placas Solares: ${state.solar ? 'Yes' : 'No'} - $${solarCost}`);
      console.log(`  Aires Acondicionados: ${state.ac} x $250 = $${acCost}`);
      console.log(`  Remoci√≥n: ${removalCost > 0 ? 'Yes' : 'No'} - $${removalCost.toFixed(2)}`);

      // 4. TOTALS (now includes removal cost)
      const subtotal = materialCost + cisternCost + solarCost + acCost + removalCost;
      const tax = subtotal * 0.115; // 11.5% IVU
      const grandTotal = subtotal + tax;

      console.log("Final totals:");
      console.log(`  Subtotal: $${subtotal.toFixed(2)}`);
      console.log(`  Tax (11.5%): $${tax.toFixed(2)}`);
      console.log(`  Grand Total: $${grandTotal.toFixed(2)}`);

      // 5. UPDATE UI SAFEGUARDS
      safeSetText('sumAreaRaw', Math.round(finalArea).toLocaleString());
      safeSetText('sumeffectiveArea', Math.round(finalArea).toLocaleString() + " ft¬≤");

      safeSetText('sumBase', formatMoney(materialCost));

      // Cistern row - show if count > 0
      const rCis = document.getElementById('rowCistern');
      if (rCis) {
        const showCistern = state.cistern > 0;
        rCis.style.display = showCistern ? 'table-row' : 'none';
        if (showCistern) {
          safeSetText('lblCistern', `Manejo de ${state.cistern} Cisterna${state.cistern > 1 ? 's' : ''} ($250 c/u)`);
          safeSetText('sumCistern', '+' + formatMoney(cisternCost));
        }
      }

      const rSol = document.getElementById('rowSolar');
      if (rSol) rSol.style.display = state.solar ? 'table-row' : 'none';

      // AC row - show if count > 0
      const rAC = document.getElementById('rowAC');
      if (rAC) {
        const showAC = state.ac > 0;
        rAC.style.display = showAC ? 'table-row' : 'none';
        if (showAC) {
          safeSetText('lblAC', `Protecci√≥n de ${state.ac} Aire${state.ac > 1 ? 's' : ''} Acondicionado${state.ac > 1 ? 's' : ''} ($250 c/u)`);
          safeSetText('sumAC', '+' + formatMoney(acCost));
        }
      }

      // Show removal cost row if Danosa with removal layers >= 2
      const rRem = document.getElementById('rowRemoval');
      if (rRem) {
        const showRemoval = removalCost > 0;
        rRem.style.display = showRemoval ? 'table-row' : 'none';
        if (showRemoval) {
          const extraLayers = state.layers - 1;
          safeSetText('lblRemoval', `Remoci√≥n de ${extraLayers} Membrana${extraLayers > 1 ? 's' : ''} ($1.00/ft¬≤)`);
          safeSetText('sumRemoval', '+' + formatMoney(removalCost));
        }
      }

      safeSetText('sumTax', formatMoney(tax));
      safeSetText('sumTotal', formatMoney(grandTotal));

      // Set quote number and date
      const now = new Date();
      const quoteNum = 'SET-' + now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '-' + String(Math.floor(Math.random() * 9000) + 1000);
      const quoteDate = now.toLocaleDateString('es-PR', { year: 'numeric', month: 'long', day: 'numeric' });

      safeSetText('quoteNumber', quoteNum);
      safeSetText('quoteDate', quoteDate);

      // Store quote number in state for PDF
      state.quoteNumber = quoteNum;
      state.quoteDate = quoteDate;

      // Set service type label
      const serviceLabel = state.service === 'Danosa' ? 'Danosa' : 'Silicone';
      safeSetText('serviceTypeLabel', serviceLabel);
    }

    function safeSetText(id, text) {
      const el = document.getElementById(id);
      if (el) el.innerText = text;
    }

    // DANOSA LOGIC
    function setRemoval(isRemoval, btn) {
      state.removal = isRemoval;
      // UI toggle
      const parent = btn.parentElement;
      parent.querySelectorAll('.btn').forEach(b => {
        b.classList.remove('btn-light', 'text-dark');
        b.classList.add('btn-outline-light');
      });
      btn.classList.remove('btn-outline-light');
      btn.classList.add('btn-light', 'text-dark');

      const layerDiv = document.getElementById('layersInput');
      layerDiv.style.display = isRemoval ? 'block' : 'none';

      // Reset layers to 1 if "No" is selected
      if (!isRemoval) {
        state.layers = 1;
        document.getElementById('layerCount').innerText = '1';
      }

      validateStep();
    }

    function continueFromDanosa() {
      // Check if removal option was selected
      if (state.removal === undefined || state.removal === null) {
        alert('Por favor selecciona si necesitas remover membrana vieja.');
        return;
      }
      changeStep(1);
    }

    function adjLayers(delta) {
      let newL = state.layers + delta;
      if (newL < 1) newL = 1;
      if (newL > 5) newL = 5;
      state.layers = newL;
      document.getElementById('layerCount').innerText = newL;
    }

    // Cistern quantity adjustment
    function adjustCistern(delta) {
      let newCount = state.cistern + delta;
      if (newCount < 0) newCount = 0;
      if (newCount > 10) newCount = 10;
      state.cistern = newCount;
      document.getElementById('cisternCount').innerText = newCount;
    }

    function confirmCistern() {
      console.log("Cistern count confirmed:", state.cistern);
      showStep('step4');
      currentStep = 4;
      updateSteps();
    }

    // AC quantity adjustment
    function adjustAC(delta) {
      let newCount = state.ac + delta;
      if (newCount < 0) newCount = 0;
      if (newCount > 10) newCount = 10;
      state.ac = newCount;
      document.getElementById('acCount').innerText = newCount;
    }

    function confirmAC() {
      console.log("AC count confirmed:", state.ac);
      showStep('step5');
      currentStep = 5;
      updateSteps();
    }

    // Helper to manually show specific ID (bypassing number logic occasionally)
    function showStep(id) {
      document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      // Progress Bar Update based on numeric currentStep
      // If 99 (Calendar), full bar
      let pct = ((currentStep - 1) / (totalSteps - 1)) * 100;
      if (currentStep === 97) pct = 30; // Contact info before calendar
      if (currentStep === 98) pct = 15; // Location before calendar
      if (currentStep === 99) pct = 100;
      document.getElementById('progressFill').style.width = pct + '%';
      document.querySelector('.w-header .small span').innerText = (currentStep > 6 && currentStep < 97) ? '-' : (currentStep >= 97 && currentStep <= 99 ? 'üìç' : currentStep);
    }

    // --- NEW LOGIC END ---

    function updateSteps() {
      console.log("Updating steps. Current:", currentStep);

      // Handle Calendar Mode (Step 99)
      if (currentStep === 99) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById('step2B').classList.add('active');
        document.getElementById('progressFill').style.width = '100%';
        return;
      }

      // Show/Hide steps (Standard Flow)
      // Note: Step 1 (idx 0) -> Step 2A (idx 1) -> Step 2B (idx 2, skipped by logic usually) -> Step Hidden (idx 3) -> Step 3 (idx 4)...
      // This numeric logic is now fragile. Ideally we should use IDs.
      // But for now, if currentStep=2, it hits Step 2A (idx 1). 
      // If currentStep=3, it targets idx 2 (Step 2B)? No, we want Step 3 (cistern).

      // FIXING INDEX MAPPING:
      // Step 1: ID step1
      // Step 2: ID step2A
      // Step 3: ID step3
      // ...

      // Let's use explicit ID mapping for safety now that DOM is mixed
      const stepMap = {
        1: 'step1',
        2: 'step2A',
        3: 'step3',
        4: 'step4',
        5: 'step4B',  // AC step
        6: 'step5',   // Service type
        7: 'step5C',  // Location/Pin
        8: 'step6',   // Contact form
        9: 'step7'    // Quote summary
      };

      const targetId = stepMap[currentStep];
      if (targetId) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(targetId);
        if (target) target.classList.add('active');
      } else {
        // Fallback legacy numeric (if map logic tries to use it)
        document.querySelectorAll('.step-content').forEach((el, idx) => {
          // el.classList.toggle('active', (idx + 1) === currentStep); 
        });
      }

      // Progress
      const pct = ((currentStep - 1) / (totalSteps - 1)) * 100;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('stepCount').innerText = currentStep;

      // Hide step counter on final summary page (step 7)
      const stepCounter = document.getElementById('stepCounter');
      if (stepCounter) {
        stepCounter.style.display = (currentStep === 7) ? 'none' : 'block';
      }

      // Back Button - Show/hide based on current step
      const backBtnContainer = document.getElementById('backButtonContainer');
      if (backBtnContainer) {
        // Hide on step 1 (nothing to go back to) and step 7 (quote summary has its own buttons)
        if (currentStep === 1 || currentStep === 7 || currentStep === 99) {
          backBtnContainer.style.display = 'none';
        } else if (currentStep === 97 || currentStep === 98) {
          // Show back button for calendar flow steps
          backBtnContainer.style.display = 'block';
        } else {
          backBtnContainer.style.display = 'block';
        }
      }

      // Step Specific Logic
      validateStep();

      // Restore visual selection state when navigating back to a step
      restoreSelectionState();

      // Map Resize Hack
      if (currentStep === 2 && window.map) {
        setTimeout(() => {
          google.maps.event.trigger(window.map, 'resize');
          if (window.mapCenter) window.map.setCenter(window.mapCenter);
        }, 100);
      }

      // Initialize location map when entering step 7 (location step)
      if (currentStep === 7) {
        console.log("üìç Step 7 reached - initializing location map");
        setTimeout(() => {
          if (!locationMap) {
            initLocationMap();
          } else {
            google.maps.event.trigger(locationMap, 'resize');
          }
        }, 200);
      }

      // Pre-fill contact form address with pin location when entering step 8
      if (currentStep === 8) {
        const addressField = document.getElementById('contactAddress');
        if (addressField && state.pinLocation?.address && !addressField.value.trim()) {
          addressField.value = state.pinLocation.address;
          console.log("üìç Pre-filled address from pin location:", state.pinLocation.address);
        }
      }

      // Render summary when reaching final step
      if (currentStep === 9) {
        console.log("üìä Step 9 reached - calling renderSummary()");
        console.log("Current state before renderSummary:", state);
        renderSummary();
      }

      // DEBUG: Log all active steps (to catch duplicates)
      const activeSteps = document.querySelectorAll('.step-content.active');
      if (activeSteps.length > 1) {
        console.error("MULTIPLE STEPS ACTIVE:", activeSteps);
      }
    }

    async function changeStep(dir) {
      console.log("changeStep called with:", dir);

      if (dir === -1) {
        // BACK NAVIGATION LOGIC
        if (currentStep === 99) {
          // Return from Calendar to Origin
          currentStep = previousStepForCalendar;
          // If coming from location step (98), go back to location
          if (previousStepForCalendar === 98) {
            showStep('step1B');
            currentStep = 98;
          } else if (previousStepForCalendar === 1) {
            showStep('step1');
          } else {
            // If was at 6, go back to 6
            if (previousStepForCalendar === 6) renderSummary();
            // Force update via standard logic if numeric match
          }
        }
        else if (currentStep === 97) {
          // Return from Contact Info to Location (calendar flow)
          currentStep = 98;
          showStep('step1B');
          initLocationMapForCalendar(); // Re-init map if needed
        }
        else if (currentStep === 98) {
          // Return from Location (calendar flow) to Step 1
          currentStep = 1;
          showStep('step1');
        }
        else if (currentStep === 3) {
          // Step 3 (Cistern) -> Step 2A (Manual Input)
          // Step 2 is legacy map, Step 2A is Manual. 
          // Since we force Step 2A or 2B in Step 1, we should go back to Step 2A.
          currentStep = 2;
        }
        else {
          currentStep += dir;
        }

        // Safety bounds
        if (currentStep < 1) currentStep = 1;
        updateSteps();
        return;
      }

      // Going Forward logic
      if (dir === 1) {
        if (!validateStep(true)) {
          console.log("Validation failed for next step");
          // Highlight error
          if (currentStep === 1) {
            // No specific input to highlight anymore
          }
          return;
        }

        // CRITICAL: Capture area from input when leaving Step 2A
        if (currentStep === 2) {
          const inputEl = document.getElementById('inputSqFt');
          if (inputEl && inputEl.value) {
            const val = parseFloat(inputEl.value);
            if (val > 0 && (!state.area || state.area === 0)) {
              // User entered value but didn't click Continuar
              // Capture it now before advancing
              state.area = val;
              state.knowsSqFt = true;
              state.manualOverride = true;
              window.manualArea = val;
              console.log("‚ö†Ô∏è CAPTURED AREA FROM INPUT (user used Siguiente instead of Continuar):", val);
              console.log("State updated:", { area: state.area, manualOverride: state.manualOverride });
            }
          }
        }

      }

      currentStep += dir;
      // Safety bounds
      if (currentStep < 1) currentStep = 1;
      if (currentStep > totalSteps) currentStep = totalSteps;

      console.log("New step:", currentStep);
      updateSteps();
    }
    // Restore visual selection state when navigating back to a step
    function restoreSelectionState() {
      // Step 3: Cistern counter - restore the displayed count
      if (currentStep === 3) {
        const cisternCountEl = document.getElementById('cisternCount');
        if (cisternCountEl) cisternCountEl.innerText = state.cistern;
      }

      // Step 4: Solar selection
      if (currentStep === 4 && state.solar !== null) {
        const cards = document.querySelectorAll('#step4 .option-card');
        cards.forEach(card => {
          card.classList.remove('selected');
          const onclick = card.getAttribute('onclick');
          if (state.solar === true && onclick && onclick.includes('true')) {
            card.classList.add('selected');
          } else if (state.solar === false && onclick && onclick.includes('false')) {
            card.classList.add('selected');
          }
        });
      }

      // Step 5: AC counter - restore the displayed count (step4B)
      if (currentStep === 5) {
        const acCountEl = document.getElementById('acCount');
        if (acCountEl) acCountEl.innerText = state.ac;
      }

      // Step 6: Service selection
      if (currentStep === 6 && state.service !== null) {
        const cards = document.querySelectorAll('#step5 .option-card');
        cards.forEach(card => {
          card.classList.remove('selected');
          const onclick = card.getAttribute('onclick');
          if (onclick && onclick.includes(`'${state.service}'`)) {
            card.classList.add('selected');
          }
        });

        // Also restore Danosa options visibility if Danosa was selected
        const danosaOpts = document.getElementById('danosaOptions');
        const continueBtn = document.getElementById('danosaContinueBtn');
        if (state.service === 'Danosa') {
          if (danosaOpts) danosaOpts.style.display = 'block';
          // If removal option was already selected, show continue button
          if (state.removal !== undefined && continueBtn) {
            continueBtn.style.display = 'block';
          }
        } else {
          if (danosaOpts) danosaOpts.style.display = 'none';
          if (continueBtn) continueBtn.style.display = 'none';
        }
      }
    }

    function validateStep(shake = false) {
      let valid = false;

      if (currentStep === 1) {
        // Validation handled by card selection
        valid = state.knowsSqFt !== null;
      } else if (currentStep === 2) {
        // For step 2A (manual input), check if area is set
        // OR check if input has a valid value
        const inputEl = document.getElementById('inputSqFt');
        valid = state.area > 0 || (inputEl && parseFloat(inputEl.value) >= 100);
      } else if (currentStep === 3) {
        // Cistern is now a counter (0+), always valid
        valid = true;
      } else if (currentStep === 4) {
        valid = state.solar !== null;
      } else if (currentStep === 5) {
        // AC is now a counter (0+), always valid
        valid = true;
      } else if (currentStep === 6) {
        // Step 6 is Service step (step5)
        valid = state.service !== null;
      } else if (currentStep === 7) {
        // Step 7 is Location step (step5C) - requires location to be selected
        valid = state.pinLocation !== null;
      } else if (currentStep === 8) {
        // Step 8 is Contact form (step6)
        const name = document.getElementById('contactName')?.value?.trim();
        const email = document.getElementById('contactEmail')?.value?.trim();
        const phone = document.getElementById('contactPhone')?.value?.trim();
        const consent = document.getElementById('contactConsent')?.checked;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        valid = name && email && phone && consent &&
                emailRegex.test(email) && phone.length >= 10;

        if (shake && !valid) {
          alert('‚ö†Ô∏è Por favor completa todos los campos requeridos correctamente');
        }
      } else if (currentStep === 9) {
        // Final step - always valid
        valid = true;
      }

      return valid;
    }

    // ========== LOCATION STEP FUNCTIONS ==========
    let locationMap = null;
    let locationMarker = null;
    let locationAutocomplete = null;

    function initLocationMap() {
      console.log('üìç Initializing location map...');

      const mapContainer = document.getElementById('locationMap');
      if (!mapContainer) {
        console.error('Location map container not found');
        return;
      }

      // Default to Puerto Rico center
      const defaultLocation = { lat: 18.2208, lng: -66.5901 };

      locationMap = new google.maps.Map(mapContainer, {
        center: defaultLocation,
        zoom: 9,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#1a3646" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
          { featureType: "road", elementType: "geometry", stylers: [{ color: "#304a7d" }] },
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      // Add click listener to map for manual pin placement
      locationMap.addListener('click', function(event) {
        placeMarker(event.latLng);
        reverseGeocode(event.latLng);
      });

      // Initialize autocomplete
      const input = document.getElementById('locationSearch');
      if (input && google.maps.places) {
        locationAutocomplete = new google.maps.places.Autocomplete(input, {
          componentRestrictions: { country: 'pr' },
          fields: ['formatted_address', 'geometry', 'name']
        });

        locationAutocomplete.addListener('place_changed', function() {
          const place = locationAutocomplete.getPlace();
          if (place.geometry && place.geometry.location) {
            const location = place.geometry.location;
            locationMap.setCenter(location);
            locationMap.setZoom(17);
            placeMarker(location);

            const address = place.formatted_address || place.name;
            updateLocationState(location.lat(), location.lng(), address);
          }
        });
      }

      console.log('‚úÖ Location map initialized');
    }

    function placeMarker(location) {
      if (locationMarker) {
        locationMarker.setMap(null);
      }

      locationMarker = new google.maps.Marker({
        position: location,
        map: locationMap,
        draggable: true,
        animation: google.maps.Animation.DROP,
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#ff9900">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
          `),
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 40)
        }
      });

      // Allow dragging the marker
      locationMarker.addListener('dragend', function() {
        const pos = locationMarker.getPosition();
        reverseGeocode(pos);
      });
    }

    function reverseGeocode(location) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: location }, function(results, status) {
        if (status === 'OK' && results[0]) {
          const address = results[0].formatted_address;
          updateLocationState(location.lat(), location.lng(), address);
        } else {
          updateLocationState(location.lat(), location.lng(), `${location.lat().toFixed(6)}, ${location.lng().toFixed(6)}`);
        }
      });
    }

    function updateLocationState(lat, lng, address) {
      const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;

      state.pinLocation = {
        lat: lat,
        lng: lng,
        address: address,
        mapsUrl: mapsUrl
      };

      // Update UI
      document.getElementById('addressText').textContent = address;
      document.getElementById('selectedAddress').style.display = 'block';
      document.getElementById('locationContinueBtn').style.display = 'block';

      console.log('üìç Location updated:', state.pinLocation);
    }

    function confirmLocation() {
      if (state.pinLocation) {
        console.log('‚úÖ Location confirmed:', state.pinLocation);
        changeStep(1);
      }
    }

    function autoLocate() {
      if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizaci√≥n. Por favor escribe tu direcci√≥n.');
        return;
      }

      // Show loading state
      document.getElementById('autoLocateBtnText').style.display = 'none';
      document.getElementById('autoLocateSpinner').style.display = 'inline';
      document.getElementById('autoLocationBtn').disabled = true;

      navigator.geolocation.getCurrentPosition(
        function(position) {
          // Success
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const location = new google.maps.LatLng(lat, lng);

          console.log('üìç GPS location obtained:', lat, lng);

          // Center map and place marker
          if (locationMap) {
            locationMap.setCenter(location);
            locationMap.setZoom(17);
            placeMarker(location);
            reverseGeocode(location);
          }

          // Reset button state
          document.getElementById('autoLocateBtnText').style.display = 'inline';
          document.getElementById('autoLocateSpinner').style.display = 'none';
          document.getElementById('autoLocationBtn').disabled = false;
        },
        function(error) {
          // Error
          console.error('Geolocation error:', error);
          let errorMsg = 'No se pudo obtener tu ubicaci√≥n. ';

          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg += 'Permiso denegado. Por favor permite el acceso a tu ubicaci√≥n.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg += 'Ubicaci√≥n no disponible.';
              break;
            case error.TIMEOUT:
              errorMsg += 'Tiempo de espera agotado.';
              break;
            default:
              errorMsg += 'Por favor escribe tu direcci√≥n manualmente.';
          }

          alert(errorMsg);

          // Reset button state
          document.getElementById('autoLocateBtnText').style.display = 'inline';
          document.getElementById('autoLocateSpinner').style.display = 'none';
          document.getElementById('autoLocationBtn').disabled = false;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    // ========== CALENDAR FLOW LOCATION FUNCTIONS ==========
    let locationMapCal = null;
    let locationMarkerCal = null;
    let locationAutocompleteCal = null;

    function initLocationMapForCalendar() {
      console.log('üìç Initializing location map for calendar flow...');

      const mapContainer = document.getElementById('locationMapCal');
      if (!mapContainer) {
        console.error('Calendar location map container not found');
        return;
      }

      // Default to Puerto Rico center
      const defaultLocation = { lat: 18.2208, lng: -66.5901 };

      locationMapCal = new google.maps.Map(mapContainer, {
        center: defaultLocation,
        zoom: 9,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#1a3646" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
          { featureType: "road", elementType: "geometry", stylers: [{ color: "#304a7d" }] },
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      // Add click listener to map for manual pin placement
      locationMapCal.addListener('click', function(event) {
        placeMarkerCal(event.latLng);
        reverseGeocodeCal(event.latLng);
      });

      // Initialize autocomplete
      const input = document.getElementById('locationSearchCal');
      if (input && google.maps.places) {
        locationAutocompleteCal = new google.maps.places.Autocomplete(input, {
          componentRestrictions: { country: 'pr' },
          fields: ['formatted_address', 'geometry', 'name']
        });

        locationAutocompleteCal.addListener('place_changed', function() {
          const place = locationAutocompleteCal.getPlace();
          if (place.geometry && place.geometry.location) {
            const location = place.geometry.location;
            locationMapCal.setCenter(location);
            locationMapCal.setZoom(17);
            placeMarkerCal(location);

            const address = place.formatted_address || place.name;
            updateLocationStateCal(location.lat(), location.lng(), address);
          }
        });
      }

      console.log('‚úÖ Calendar location map initialized');
    }

    function placeMarkerCal(location) {
      if (locationMarkerCal) {
        locationMarkerCal.setMap(null);
      }

      locationMarkerCal = new google.maps.Marker({
        position: location,
        map: locationMapCal,
        draggable: true,
        animation: google.maps.Animation.DROP,
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#ff9900">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
          `),
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 40)
        }
      });

      // Allow dragging the marker
      locationMarkerCal.addListener('dragend', function() {
        const pos = locationMarkerCal.getPosition();
        reverseGeocodeCal(pos);
      });
    }

    function reverseGeocodeCal(location) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: location }, function(results, status) {
        if (status === 'OK' && results[0]) {
          const address = results[0].formatted_address;
          updateLocationStateCal(location.lat(), location.lng(), address);
        } else {
          updateLocationStateCal(location.lat(), location.lng(), `${location.lat().toFixed(6)}, ${location.lng().toFixed(6)}`);
        }
      });
    }

    function updateLocationStateCal(lat, lng, address) {
      const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;

      state.pinLocationCal = {
        lat: lat,
        lng: lng,
        address: address,
        mapsUrl: mapsUrl
      };

      // Update UI
      document.getElementById('addressTextCal').textContent = address;
      document.getElementById('selectedAddressCal').style.display = 'block';
      document.getElementById('locationContinueBtnCal').style.display = 'block';

      // Store in localStorage for later use after calendar booking
      localStorage.setItem('pendingPinLocation', JSON.stringify(state.pinLocationCal));

      console.log('üìç Calendar location updated:', state.pinLocationCal);
    }

    function confirmLocationForCalendar() {
      if (state.pinLocationCal) {
        console.log('‚úÖ Location confirmed for calendar:', state.pinLocationCal);
        // Go to contact info step (step 97)
        showStep('step1C');
        currentStep = 97;
        updateSteps();
      }
    }

    // Create contact with pin location, then show calendar
    async function createContactAndShowCalendar() {
      const name = document.getElementById('calContactName').value.trim();
      const email = document.getElementById('calContactEmail').value.trim();
      const phone = document.getElementById('calContactPhone').value.trim();
      const statusEl = document.getElementById('calContactStatus');

      // Validate
      if (!name || !email || !phone) {
        statusEl.textContent = '‚ö†Ô∏è Por favor completa todos los campos';
        statusEl.style.display = 'block';
        statusEl.style.color = '#ff6b6b';
        return;
      }

      if (!email.includes('@')) {
        statusEl.textContent = '‚ö†Ô∏è Por favor ingresa un email v√°lido';
        statusEl.style.display = 'block';
        statusEl.style.color = '#ff6b6b';
        return;
      }

      if (phone.replace(/\D/g, '').length < 10) {
        statusEl.textContent = '‚ö†Ô∏è Por favor ingresa un tel√©fono v√°lido';
        statusEl.style.display = 'block';
        statusEl.style.color = '#ff6b6b';
        return;
      }

      // Show loading
      document.getElementById('calContactBtnText').style.display = 'none';
      document.getElementById('calContactSpinner').style.display = 'inline';
      statusEl.textContent = '‚è≥ Guardando tu informaci√≥n...';
      statusEl.style.display = 'block';
      statusEl.style.color = '#ffc107';

      try {
        const ghlToken = 'pit-f3ebb971-2fd1-415b-91f0-f4449c8e5314';
        const ghlLocationId = 'LVwbqYFEmGiKJ7AgtSIf';
        const ghlApiUrl = 'https://services.leadconnectorhq.com/contacts/';

        // Format phone
        const digits = phone.replace(/\D/g, '');
        const formattedPhone = digits.startsWith('1') ? `+${digits}` : `+1${digits}`;

        // Parse name
        const nameParts = name.split(/\s+/);
        const firstName = nameParts[0];
        const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';

        // Get pin location
        const pinData = state.pinLocationCal || {};

        const contactData = {
          locationId: ghlLocationId,
          firstName: firstName,
          lastName: lastName,
          email: email,
          phone: formattedPhone,
          address1: pinData.address || '',
          source: 'Cotizador Online - Inspecci√≥n',
          tags: ['cotizador-online', 'inspeccion-pendiente'],
          customFields: [
            { id: 'X8GLbec6WrfimB9lR4XV', value: pinData.mapsUrl || '' }  // Pin Location
          ]
        };

        console.log('üì§ Creating contact with pin location:', contactData);

        const response = await fetch(ghlApiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ghlToken}`,
            'Content-Type': 'application/json',
            'Version': '2021-07-28'
          },
          body: JSON.stringify(contactData)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ Contact created with pin location:', result);
          statusEl.textContent = '‚úÖ ¬°Informaci√≥n guardada!';
          statusEl.style.color = '#51cf66';

          // Clear pending location
          localStorage.removeItem('pendingPinLocation');

          // Go to calendar after short delay
          setTimeout(() => {
            goToCalendar(97);
          }, 500);

        } else if (response.status === 400) {
          // Contact might already exist, try to update
          const errorData = await response.json();
          console.log('Contact may exist:', errorData);

          if (errorData.meta?.contactId) {
            // Update existing contact
            const updateResponse = await fetch(`${ghlApiUrl}${errorData.meta.contactId}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${ghlToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
              },
              body: JSON.stringify({
                firstName: firstName,
                lastName: lastName,
                phone: formattedPhone,
                address1: pinData.address || '',
                customFields: [
                  { id: 'X8GLbec6WrfimB9lR4XV', value: pinData.mapsUrl || '' }
                ]
              })
            });

            if (updateResponse.ok) {
              console.log('‚úÖ Existing contact updated with pin location');
              statusEl.textContent = '‚úÖ ¬°Informaci√≥n actualizada!';
              statusEl.style.color = '#51cf66';
              localStorage.removeItem('pendingPinLocation');

              setTimeout(() => {
                goToCalendar(97);
              }, 500);
            } else {
              throw new Error('Failed to update contact');
            }
          } else {
            throw new Error('Contact creation failed');
          }
        } else {
          throw new Error(`Server error: ${response.status}`);
        }

      } catch (error) {
        console.error('Error creating contact:', error);
        statusEl.textContent = '‚ö†Ô∏è Error al guardar. Intenta de nuevo.';
        statusEl.style.color = '#ff6b6b';

        // Reset button
        document.getElementById('calContactBtnText').style.display = 'inline';
        document.getElementById('calContactSpinner').style.display = 'none';
      }
    }

    function autoLocateForCalendar() {
      if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizaci√≥n. Por favor escribe tu direcci√≥n.');
        return;
      }

      // Show loading state
      document.getElementById('autoLocateBtnTextCal').style.display = 'none';
      document.getElementById('autoLocateSpinnerCal').style.display = 'inline';
      document.getElementById('autoLocationBtnCal').disabled = true;

      navigator.geolocation.getCurrentPosition(
        function(position) {
          // Success
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const location = new google.maps.LatLng(lat, lng);

          console.log('üìç GPS location obtained for calendar:', lat, lng);

          // Center map and place marker
          if (locationMapCal) {
            locationMapCal.setCenter(location);
            locationMapCal.setZoom(17);
            placeMarkerCal(location);
            reverseGeocodeCal(location);
          }

          // Reset button state
          document.getElementById('autoLocateBtnTextCal').style.display = 'inline';
          document.getElementById('autoLocateSpinnerCal').style.display = 'none';
          document.getElementById('autoLocationBtnCal').disabled = false;
        },
        function(error) {
          // Error
          console.error('Geolocation error:', error);
          let errorMsg = 'No se pudo obtener tu ubicaci√≥n. ';

          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg += 'Permiso denegado. Por favor permite el acceso a tu ubicaci√≥n.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg += 'Ubicaci√≥n no disponible.';
              break;
            case error.TIMEOUT:
              errorMsg += 'Tiempo de espera agotado.';
              break;
            default:
              errorMsg += 'Por favor escribe tu direcci√≥n manualmente.';
          }

          alert(errorMsg);

          // Reset button state
          document.getElementById('autoLocateBtnTextCal').style.display = 'inline';
          document.getElementById('autoLocateSpinnerCal').style.display = 'none';
          document.getElementById('autoLocationBtnCal').disabled = false;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    // Listen for calendar booking completion and update contact
    window.addEventListener('message', async function(event) {
      // Check if message is from GHL calendar widget
      if (event.data && (event.data.type === 'booking_confirmed' || event.data.booking_confirmed)) {
        console.log('üìÖ Calendar booking detected:', event.data);
        await updateContactWithPinLocation(event.data);
      }
    });

    // Also check periodically if user has booked (fallback)
    async function updateContactWithPinLocation(bookingData) {
      const pendingLocation = localStorage.getItem('pendingPinLocation');
      if (!pendingLocation) {
        console.log('No pending pin location to update');
        return;
      }

      const pinData = JSON.parse(pendingLocation);
      const email = bookingData?.email || bookingData?.contact?.email;

      if (!email) {
        console.log('No email found in booking data, will try to update later');
        return;
      }

      try {
        const ghlToken = 'pit-f3ebb971-2fd1-415b-91f0-f4449c8e5314';
        const ghlLocationId = 'LVwbqYFEmGiKJ7AgtSIf';

        // Search for contact by email
        const searchResponse = await fetch(
          `https://services.leadconnectorhq.com/contacts/?locationId=${ghlLocationId}&query=${encodeURIComponent(email)}&limit=1`,
          {
            headers: {
              'Authorization': `Bearer ${ghlToken}`,
              'Version': '2021-07-28',
              'Accept': 'application/json'
            }
          }
        );

        if (searchResponse.ok) {
          const searchResult = await searchResponse.json();
          if (searchResult.contacts && searchResult.contacts.length > 0) {
            const contactId = searchResult.contacts[0].id;

            // Update contact with pin location
            const updateResponse = await fetch(
              `https://services.leadconnectorhq.com/contacts/${contactId}`,
              {
                method: 'PUT',
                headers: {
                  'Authorization': `Bearer ${ghlToken}`,
                  'Content-Type': 'application/json',
                  'Version': '2021-07-28'
                },
                body: JSON.stringify({
                  address1: pinData.address,
                  customFields: [
                    { id: 'X8GLbec6WrfimB9lR4XV', value: pinData.mapsUrl }
                  ]
                })
              }
            );

            if (updateResponse.ok) {
              console.log('‚úÖ Contact updated with pin location');
              localStorage.removeItem('pendingPinLocation');
            } else {
              console.warn('Failed to update contact with pin location');
            }
          }
        }
      } catch (error) {
        console.error('Error updating contact with pin location:', error);
      }
    }

    // Function to confirm booking and update contact with pin location
    async function confirmBookingWithLocation() {
      const emailInput = document.getElementById('bookingEmailConfirm');
      const statusEl = document.getElementById('bookingConfirmStatus');
      const email = emailInput?.value?.trim();

      if (!email || !email.includes('@')) {
        statusEl.textContent = '‚ö†Ô∏è Por favor ingresa un email v√°lido';
        statusEl.style.display = 'block';
        statusEl.style.color = '#ff6b6b';
        return;
      }

      const pendingLocation = localStorage.getItem('pendingPinLocation');
      if (!pendingLocation) {
        statusEl.textContent = '‚ö†Ô∏è No hay ubicaci√≥n pendiente';
        statusEl.style.display = 'block';
        statusEl.style.color = '#ff6b6b';
        return;
      }

      const pinData = JSON.parse(pendingLocation);

      statusEl.textContent = '‚è≥ Buscando tu cita...';
      statusEl.style.display = 'block';
      statusEl.style.color = '#ffc107';

      try {
        const ghlToken = 'pit-f3ebb971-2fd1-415b-91f0-f4449c8e5314';
        const ghlLocationId = 'LVwbqYFEmGiKJ7AgtSIf';

        // Search for contact by email
        const searchResponse = await fetch(
          `https://services.leadconnectorhq.com/contacts/?locationId=${ghlLocationId}&query=${encodeURIComponent(email)}&limit=1`,
          {
            headers: {
              'Authorization': `Bearer ${ghlToken}`,
              'Version': '2021-07-28',
              'Accept': 'application/json'
            }
          }
        );

        if (searchResponse.ok) {
          const searchResult = await searchResponse.json();
          if (searchResult.contacts && searchResult.contacts.length > 0) {
            const contactId = searchResult.contacts[0].id;
            console.log('üìç Found contact:', contactId);

            // Update contact with pin location
            const updateResponse = await fetch(
              `https://services.leadconnectorhq.com/contacts/${contactId}`,
              {
                method: 'PUT',
                headers: {
                  'Authorization': `Bearer ${ghlToken}`,
                  'Content-Type': 'application/json',
                  'Version': '2021-07-28'
                },
                body: JSON.stringify({
                  address1: pinData.address,
                  customFields: [
                    { id: 'X8GLbec6WrfimB9lR4XV', value: pinData.mapsUrl }
                  ]
                })
              }
            );

            if (updateResponse.ok) {
              console.log('‚úÖ Contact updated with pin location');
              localStorage.removeItem('pendingPinLocation');
              statusEl.innerHTML = '‚úÖ <strong>¬°Ubicaci√≥n guardada!</strong> Te contactaremos pronto.';
              statusEl.style.color = '#51cf66';

              // Hide the confirm section after success
              setTimeout(() => {
                document.getElementById('confirmBookingSection').style.display = 'none';
              }, 3000);
            } else {
              const errorText = await updateResponse.text();
              console.error('Failed to update contact:', errorText);
              statusEl.textContent = '‚ö†Ô∏è Error al guardar ubicaci√≥n. Intenta de nuevo.';
              statusEl.style.color = '#ff6b6b';
            }
          } else {
            statusEl.textContent = '‚ö†Ô∏è No encontramos tu cita. Verifica el email o agenda primero.';
            statusEl.style.color = '#ff6b6b';
          }
        } else {
          statusEl.textContent = '‚ö†Ô∏è Error al buscar. Intenta de nuevo.';
          statusEl.style.color = '#ff6b6b';
        }
      } catch (error) {
        console.error('Error confirming booking:', error);
        statusEl.textContent = '‚ö†Ô∏è Error de conexi√≥n. Intenta de nuevo.';
        statusEl.style.color = '#ff6b6b';
      }
    }

    // ========== END LOCATION FUNCTIONS ==========

    function setOption(key, val, card) {
      state[key] = val;
      // UI selection
      const siblings = card.parentElement.parentElement.querySelectorAll('.option-card');
      siblings.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      // Toggle Danosa Options visibility AND Image Logic
      if (key === 'service') {
        const danosaOpts = document.getElementById('danosaOptions');
        const serviceImg = document.getElementById('serviceImg');

        if (val === 'Danosa') {
          danosaOpts.style.display = 'block';
          // Hide image on mobile to make room for Danosa options
          if (serviceImg) {
            serviceImg.style.display = window.innerWidth <= 768 ? 'none' : 'block';
            serviceImg.src = 'assets/danosa_membrane.png?v=' + new Date().getTime() + '_2';
          }
          // Don't auto-advance - user needs to configure Danosa options
        } else {
          danosaOpts.style.display = 'none';
          state.removal = false; // reset
          if (serviceImg) {
            serviceImg.style.display = 'block';
            serviceImg.src = 'assets/service.png?v=2';
          }
          // Auto-advance for Silicona after short delay
          setTimeout(() => {
            changeStep(1);
          }, 400);
        }
      } else {
        // Auto-advance for cistern (step 3) and solar (step 4) selections
        setTimeout(() => {
          changeStep(1);
        }, 400);
      }

      validateStep();
    }

    // Old renderSummary deleted to avoid shadowing. 
    // The active renderSummary is now located closer to confirmManualSqFt.

    function formatMoney(n) {
      return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // PDF Download Function
    function downloadPDF() {
      console.log('üì• downloadPDF() called');

      // Check if jsPDF is available (comes with html2pdf bundle)
      if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
        console.error('‚ùå jsPDF library not loaded');
        alert('Error: La librer√≠a de PDF no est√° cargada. Recarga la p√°gina e intenta de nuevo.');
        return;
      }

      // Show loading state on button immediately
      const pdfBtn = document.querySelector('button[onclick="downloadPDF()"]');
      const originalBtnText = pdfBtn ? pdfBtn.innerHTML : '';
      if (pdfBtn) {
        pdfBtn.innerHTML = '‚è≥ Generando PDF...';
        pdfBtn.disabled = true;
      }

      try {
        // Get jsPDF constructor
        const { jsPDF } = window.jspdf || { jsPDF: window.jsPDF };

        // Create PDF document (Letter size in points: 612 x 792)
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'pt',
          format: 'letter'
        });

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 40;
        let y = margin;

        // Get current date
        const today = new Date();
        const dateStr = today.toLocaleDateString('es-PR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        }).replace(/\//g, '-');

        // Get all data
        const customerName = document.getElementById('contactName')?.value || state.contactName || 'Cliente';
        const sanitizedName = customerName.replace(/[^a-zA-Z0-9]/g, '_');
        const areaRaw = document.getElementById('sumAreaRaw')?.innerText || String(Math.round(state.area || 0));
        const wastePercent = document.getElementById('lblWaste')?.innerText || '15';
        const wasteAmount = document.getElementById('sumWaste')?.innerText || String(Math.round((state.area || 0) * 0.15));
        const effectiveArea = document.getElementById('sumeffectiveArea')?.innerText || `${Math.round((state.area || 0) * 1.15)} ft¬≤`;
        const basePrice = document.getElementById('sumBase')?.innerText || '$0.00';
        const taxAmount = document.getElementById('sumTax')?.innerText || '$0.00';
        const totalAmount = document.getElementById('sumTotal')?.innerText || '$0.00';
        const showCistern = state.cistern > 0;
        const cisternLabel = `Manejo de ${state.cistern} Cisterna${state.cistern > 1 ? 's' : ''} ($250 c/u)`;
        const cisternAmount = `+$${(state.cistern * 250).toFixed(2)}`;
        const showSolar = state.solar === true;
        const showAC = state.ac > 0;
        const acLabel = `Protecci√≥n de ${state.ac} Aire${state.ac > 1 ? 's' : ''} Acondicionado${state.ac > 1 ? 's' : ''} ($250 c/u)`;
        const acAmount = `+$${(state.ac * 250).toFixed(2)}`;
        const showRemoval = state.removal === true && state.service === 'Danosa' && state.layers >= 2;
        const removalLabel = `Remoci√≥n de ${(state.layers || 1) - 1} Membranas`;
        const removalAmount = document.getElementById('sumRemoval')?.innerText || '+$0.00';
        const quoteNumber = state.quoteNumber || ('SET-' + today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + String(today.getDate()).padStart(2, '0') + '-' + String(Math.floor(Math.random() * 9000) + 1000));
        const quoteDate = state.quoteDate || today.toLocaleDateString('es-PR', { year: 'numeric', month: 'long', day: 'numeric' });
        const serviceLabel = state.service === 'Danosa' ? 'Danosa' : 'Silicone';
        const customerAddress = state.address || state.contactAddress || '';

      // Debug logging
      console.log('üìÑ PDF Data:', {
        customerName,
        serviceType,
        areaRaw,
        effectiveArea,
        basePrice,
        taxAmount,
        totalAmount,
        showCistern,
        showSolar,
        showAC,
        showRemoval,
        state: { ...state }
      });

      // Create PDF container - position off-screen but VISIBLE for html2canvas
      const pdfContainer = document.createElement('div');
      pdfContainer.id = 'pdfContent';
      pdfContainer.style.cssText = `
        width: 816px;
        min-height: 1056px;
        padding: 60px;
        background: #0a192f;
        color: #ffffff;
        font-family: Arial, Helvetica, sans-serif;
        position: absolute;
        top: 0;
        left: -9999px;
        z-index: 9999;
        opacity: 1;
      `;

      // Build PDF HTML content matching professional design
      pdfContainer.innerHTML = `
        <!-- Company Header -->
        <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #1b2838 0%, #0d1b2a 100%); border-bottom: 3px solid #ff9900; margin: -60px -60px 0 -60px;">
          <div style="font-size: 36px; font-weight: bold; color: #ff9900; letter-spacing: 3px;">SELLA EL TECHO</div>
          <div style="font-size: 13px; color: #94a3b8; margin-top: 5px;">Sellado Profesional de Techos en Puerto Rico</div>
        </div>

        <!-- Quote Title & Info Bar -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; margin: 25px 0 20px 0; border-bottom: 1px solid rgba(255,153,0,0.2);">
          <div>
            <span style="color: #ff9900; font-weight: bold; font-size: 18px; letter-spacing: 1px;">ESTIMADO</span>
            <span style="color: #64748b; margin-left: 10px; font-size: 14px;">#${quoteNumber}</span>
          </div>
          <div style="text-align: right;">
            <span style="color: #64748b; font-size: 14px;">${quoteDate}</span>
          </div>
        </div>

        <!-- Client Info -->
        <div style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 6px; border-left: 3px solid #ff9900;">
          <p style="margin: 6px 0; color: #94a3b8; font-size: 14px;"><strong style="color: #ffffff;">Cliente:</strong> ${customerName}</p>
          ${state.address ? `<p style="margin: 6px 0; color: #94a3b8; font-size: 14px;"><strong style="color: #ffffff;">Direcci√≥n:</strong> ${state.address}</p>` : ''}
        </div>

        <!-- Roof Measurements Section -->
        <div style="margin-bottom: 25px;">
          <div style="color: #64748b; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; margin-bottom: 12px; font-weight: bold;">Medidas del Techo</div>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 10px 0; color: #ffffff; font-size: 14px;">√Årea del Techo</td>
              <td style="padding: 10px 0; text-align: right; color: #ffffff; font-size: 14px;">${areaRaw} ft¬≤</td>
            </tr>
            <tr>
              <td style="padding: 6px 0 6px 15px; color: #64748b; font-size: 13px;">+ Material de Seguridad (${wastePercent}%)</td>
              <td style="padding: 6px 0; text-align: right; color: #64748b; font-size: 13px;">+${wasteAmount} ft¬≤</td>
            </tr>
          </table>
          <div style="margin-top: 10px; padding: 12px 15px; background: rgba(255,153,0,0.1); border-left: 3px solid #ff9900; border-radius: 4px;">
            <table style="width: 100%;"><tr>
              <td style="color: #ffffff; font-weight: 600; font-size: 14px;">Material Requerido</td>
              <td style="text-align: right; color: #ff9900; font-weight: bold; font-size: 15px;">${effectiveArea}</td>
            </tr></table>
          </div>
        </div>

        <!-- Services Section -->
        <div style="margin-bottom: 25px;">
          <div style="color: #64748b; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; margin-bottom: 12px; font-weight: bold;">Servicios</div>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 10px 0; color: #ffffff; font-size: 14px;">Sellado de Techo (${serviceLabel})</td>
              <td style="padding: 10px 0; text-align: right; color: #ffffff; font-size: 14px;">${basePrice}</td>
            </tr>
            ${showCistern ? `
            <tr>
              <td style="padding: 10px 0; color: #ffffff; font-size: 14px;">${cisternLabel}</td>
              <td style="padding: 10px 0; text-align: right; color: #ff9900; font-size: 14px;">${cisternAmount}</td>
            </tr>
            ` : ''}
            ${showSolar ? `
            <tr>
              <td style="padding: 10px 0; color: #ffffff; font-size: 14px;">Desmontaje de Placas Solares</td>
              <td style="padding: 10px 0; text-align: right; color: #ff9900; font-size: 14px;">+$1,000.00</td>
            </tr>
            ` : ''}
            ${showAC ? `
            <tr>
              <td style="padding: 10px 0; color: #ffffff; font-size: 14px;">${acLabel}</td>
              <td style="padding: 10px 0; text-align: right; color: #ff9900; font-size: 14px;">${acAmount}</td>
            </tr>
            ` : ''}
            ${showRemoval ? `
            <tr>
              <td style="padding: 10px 0; color: #ffffff; font-size: 14px;">${removalLabel}</td>
              <td style="padding: 10px 0; text-align: right; color: #ff9900; font-size: 14px;">${removalAmount}</td>
            </tr>
            ` : ''}
          </table>
        </div>

        <!-- Divider -->
        <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <!-- Tax -->
        <div style="padding: 10px 0;">
          <table style="width: 100%;"><tr>
            <td style="color: #64748b; font-size: 14px;">IVU (11.5%)</td>
            <td style="text-align: right; color: #64748b; font-size: 14px;">${taxAmount}</td>
          </tr></table>
        </div>

        <!-- Total -->
        <div style="background: linear-gradient(135deg, rgba(255,153,0,0.15) 0%, rgba(255,153,0,0.05) 100%); border: 2px solid #ff9900; border-radius: 8px; padding: 20px; margin: 15px 0 25px 0;">
          <table style="width: 100%;"><tr>
            <td style="font-size: 18px; font-weight: bold; color: #ffffff;">TOTAL ESTIMADO</td>
            <td style="font-size: 28px; font-weight: bold; color: #ff9900; text-align: right;">${totalAmount}</td>
          </tr></table>
        </div>

        <!-- Disclaimer -->
        <div style="text-align: center; margin-bottom: 30px;">
          <p style="margin: 0; color: #64748b; font-size: 12px;">
            * Precio sujeto a verificaci√≥n en inspecci√≥n f√≠sica
          </p>
        </div>

        <!-- Footer -->
        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; text-align: center;">
          <p style="color: #94a3b8; font-size: 12px; margin: 5px 0;">
            <strong style="color: #ff9900;">Sella El Techo</strong> - Sellado Profesional de Techos
          </p>
          <p style="color: #64748b; font-size: 11px; margin: 5px 0;">
            Puerto Rico | www.sellaeltecho.com
          </p>
        </div>
      `;

      // Append to body
      document.body.appendChild(pdfContainer);

      // Configure html2pdf options
      const opt = {
        margin: 0,
        filename: `Cotizacion_${sanitizedName}_${dateStr}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          backgroundColor: '#0a192f',
          logging: true,
          allowTaint: true,
          width: 816,
          height: 1056,
          scrollX: 0,
          scrollY: 0,
          x: 0,
          y: 0,
          onclone: function(clonedDoc) {
            const clonedElement = clonedDoc.getElementById('pdfContent');
            if (clonedElement) {
              clonedElement.style.position = 'relative';
              clonedElement.style.left = '0';
              clonedElement.style.top = '0';
              clonedElement.style.opacity = '1';
            }
          }
        },
        jsPDF: {
          unit: 'px',
          format: [816, 1056],
          orientation: 'portrait',
          hotfixes: ['px_scaling']
        }
      };

      // Generate and download PDF with a small delay to ensure DOM is ready
      console.log('üì• Starting PDF generation...');
      console.log('üìÑ PDF Container HTML:', pdfContainer.innerHTML.substring(0, 500) + '...');

      setTimeout(() => {
        html2pdf().set(opt).from(pdfContainer).save().then(() => {
          // Clean up: remove temporary container
          if (document.body.contains(pdfContainer)) {
            document.body.removeChild(pdfContainer);
          }
          console.log('‚úÖ PDF downloaded successfully');

          // Restore button
          if (pdfBtn) {
            pdfBtn.innerHTML = originalBtnText;
            pdfBtn.disabled = false;
          }
        }).catch(err => {
          console.error('‚ùå Error generating PDF:', err);
          if (document.body.contains(pdfContainer)) {
            document.body.removeChild(pdfContainer);
          }

          // Restore button
          if (pdfBtn) {
            pdfBtn.innerHTML = originalBtnText;
            pdfBtn.disabled = false;
          }

          alert('Error al generar el PDF: ' + err.message);
        });
      }, 100);

      } catch (error) {
        console.error('‚ùå Error in downloadPDF:', error);
        if (pdfBtn) {
          pdfBtn.innerHTML = originalBtnText;
          pdfBtn.disabled = false;
        }
        alert('Error al generar el PDF: ' + error.message);
      }
    }

    // Request Contract - Send webhook with all client info
    async function requestContract() {
      console.log('üìÑ requestContract() called');

      const btn = document.getElementById('btnContract');
      const originalText = btn ? btn.innerHTML : '';

      // Show loading state
      if (btn) {
        btn.innerHTML = '‚è≥ Enviando...';
        btn.disabled = true;
      }

      try {
        // Gather all client and quote data
        const customerName = document.getElementById('contactName')?.value || state.contactName || '';
        const customerEmail = document.getElementById('contactEmail')?.value || state.contactEmail || '';
        const customerPhone = document.getElementById('contactPhone')?.value || state.contactPhone || '';
        const customerAddress = state.address || state.pinLocation?.address || '';

        const areaRaw = document.getElementById('sumAreaRaw')?.innerText || String(Math.round(state.area || 0));
        const effectiveArea = document.getElementById('sumeffectiveArea')?.innerText || '';
        const basePrice = document.getElementById('sumBase')?.innerText || '$0.00';
        const taxAmount = document.getElementById('sumTax')?.innerText || '$0.00';
        const totalAmount = document.getElementById('sumTotal')?.innerText || '$0.00';

        const quoteNumber = state.quoteNumber || '';
        const quoteDate = state.quoteDate || new Date().toLocaleDateString('es-PR');
        const serviceType = state.service || 'Silicone';

        // Build webhook payload
        const webhookData = {
          // Contact Info
          contact: {
            name: customerName,
            email: customerEmail,
            phone: customerPhone,
            address: customerAddress
          },
          // Quote Info
          quote: {
            number: quoteNumber,
            date: quoteDate,
            service: serviceType,
            area: areaRaw,
            effectiveArea: effectiveArea,
            basePrice: basePrice,
            tax: taxAmount,
            total: totalAmount
          },
          // Options
          options: {
            cistern: state.cistern > 0,
            solar: state.solar === true,
            ac: state.ac > 0,
            removal: state.removal === true,
            layers: state.layers || 1
          },
          // Location
          location: state.pinLocation || null,
          // Timestamp
          timestamp: new Date().toISOString(),
          source: 'cotizador_web'
        };

        console.log('üì§ Sending webhook with data:', webhookData);

        // Send to webhook
        const webhookUrl = 'https://services.leadconnectorhq.com/hooks/LVwbqYFEmGiKJ7AgtSIf/webhook-trigger/92d49c40-0af4-461d-9a1f-4251d7acf30f';

        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(webhookData)
        });

        if (response.ok) {
          console.log('‚úÖ Webhook sent successfully');

          // Fire Meta Pixel InitiateCheckout - High-intent customer requesting contract
          if (typeof fbq === 'function') {
            // Parse total amount for value
            const totalValue = parseFloat(totalAmount.replace(/[^0-9.]/g, '')) || 0;
            fbq('track', 'InitiateCheckout', {
              content_name: 'Contrato ' + (serviceType || 'Sellado'),
              content_category: 'Sellado de Techo',
              value: totalValue,
              currency: 'USD',
              num_items: 1
            });
            console.log('üìä Meta Pixel: InitiateCheckout event fired (high-intent customer)');
          }

          // Show success message
          if (btn) {
            btn.innerHTML = '‚úÖ Contrato Solicitado';
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-success');
          }

          alert('¬°Solicitud enviada! Te enviaremos el contrato a tu correo electr√≥nico pronto.');
        } else {
          throw new Error('Webhook response: ' + response.status);
        }

      } catch (error) {
        console.error('‚ùå Error sending webhook:', error);

        // Restore button
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }

        alert('Error al enviar la solicitud. Por favor intenta de nuevo.');
      }
    }

    // Bridging Map Logic
    // Bridging Map Logic
    // Bridging Map Logic
    window.updateAreaState = function (sqft, stats = null) {
      // 1. STRICT MANUAL OVERRIDE CHECK
      // If the user manually entered a value, the map should NEVER overwrite it.
      if (state.manualOverride === true || state.knowsSqFt === true || (window.manualArea && window.manualArea > 0)) {
        console.log("Blocking map update because Manual Override is active.");
        return;
      }

      // 2. Standard Logic
      state.area = sqft;
      state.stats = stats;

      console.log("Area updated to:", state.area);

      // Update Main Display
      const liveArea = document.getElementById('liveArea');
      if (liveArea) liveArea.innerText = Math.round(sqft).toLocaleString();

      // Update Table if stats provided
      if (document.getElementById('valSat')) {
        const displayVal = stats ? stats.geometric : sqft;
        document.getElementById('valSat').innerText = Math.round(displayVal).toLocaleString() + " ft¬≤";
      }

      // If we are on the quote page, re-render
      if (currentStep === 7) renderSummary();

      validateStep();
    };

    // Show work calendar in step7
    function showWorkCalendar() {
      const calendarSection = document.getElementById('workCalendarSection');
      const btn = document.getElementById('btnShowCalendar');
      if (calendarSection) {
        calendarSection.style.display = 'block';
        calendarSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        if (btn) {
          btn.style.display = 'none';
        }
      }
    }

    // Make functions globally available
    window.updateSteps = updateSteps;
    window.validateStep = validateStep;
    window.setOption = setOption;
    window.changeStep = changeStep;
    window.submitContactAndProceed = submitContactAndProceed;
    window.downloadPDF = downloadPDF;
    window.showWorkCalendar = showWorkCalendar;

    // Verification Links


    // Initial Init
    document.addEventListener('DOMContentLoaded', () => {
      console.log("Wizard Initializing...");

      // Input Listener for real-time validation
      const addrInput = document.getElementById('addressInput');
      if (addrInput) {
        addrInput.addEventListener('input', () => {
          validateStep();
        });
      }

      // STEP 1: Add explicit click listeners for mobile
      const step1Cards = document.querySelectorAll('#step1 .option-card');
      step1Cards.forEach((card, index) => {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("Step1 card clicked:", index);
          const knows = index === 0; // First card = true (S√≠), Second card = false (No)
          setKnowsSqFt(knows, this);
        });
        // Also add touch event for better mobile support
        card.addEventListener('touchend', function(e) {
          e.preventDefault();
          console.log("Step1 card touched:", index);
          const knows = index === 0;
          setKnowsSqFt(knows, this);
        });
      });

      // STEP 3 (Cistern): Add explicit click listeners
      const step3Cards = document.querySelectorAll('#step3 .option-card');
      step3Cards.forEach((card, index) => {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("Step3 card clicked:", index);
          const hasCistern = index === 1; // First = No, Second = S√≠
          setOption('cistern', hasCistern, this);
        });
        card.addEventListener('touchend', function(e) {
          e.preventDefault();
          const hasCistern = index === 1;
          setOption('cistern', hasCistern, this);
        });
      });

      // STEP 4 (Solar): Add explicit click listeners
      const step4Cards = document.querySelectorAll('#step4 .option-card');
      step4Cards.forEach((card, index) => {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("Step4 card clicked:", index);
          const hasSolar = index === 1; // First = No, Second = S√≠
          setOption('solar', hasSolar, this);
        });
        card.addEventListener('touchend', function(e) {
          e.preventDefault();
          const hasSolar = index === 1;
          setOption('solar', hasSolar, this);
        });
      });

      // STEP 4B (AC): Add explicit click listeners
      const step4BCards = document.querySelectorAll('#step4B .option-card');
      step4BCards.forEach((card, index) => {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("Step4B card clicked:", index);
          const hasAC = index === 1; // First = No, Second = S√≠
          setOption('ac', hasAC, this);
        });
        card.addEventListener('touchend', function(e) {
          e.preventDefault();
          const hasAC = index === 1;
          setOption('ac', hasAC, this);
        });
      });

      // STEP 5 (Service): Add explicit click listeners
      const step5Cards = document.querySelectorAll('#step5 .option-card');
      step5Cards.forEach((card, index) => {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log("Step5 card clicked:", index);
          const service = index === 0 ? 'Silicona' : 'Danosa';
          setOption('service', service, this);
        });
        card.addEventListener('touchend', function(e) {
          e.preventDefault();
          const service = index === 0 ? 'Silicona' : 'Danosa';
          setOption('service', service, this);
        });
      });

      console.log("‚úÖ All option card listeners attached");

      updateSteps(); // Initial UI Sync
    });

    // Rotation Control Logic
    let lastSliderVal = 0;
    function handleSliderRotation(val) {
      const delta = val - lastSliderVal;
      lastSliderVal = val;
      if (window.rotatePolygon) window.rotatePolygon(delta);
    }

    // Expose control visibility
    window.showRotationControls = function (show) {
      const el = document.getElementById('rotationControls');
      if (el) el.style.display = show ? 'block' : 'none';

      // Reset slider when showing
      if (show) {
        const slider = document.getElementById('rotSlider');
        if (slider) slider.value = 0;
        lastSliderVal = 0;
      }
    };
  </script>

  <!-- CRITICAL BACKUP SCRIPT: Geolocation -->
  <!-- Embedded to ensure functionality even if map_logic.js fails -->
  <script>
    console.log("‚ö° Main HTML Script Loaded. Defining useCurrentLocation...");

    window.useCurrentLocation = function () {
      console.log("üìç HTML-embedded useCurrentLocation triggered.");
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalizaci√≥n.");
        return;
      }

      const btn = document.getElementById('btnUseLocation');
      let originalText = "üìç Usar mi ubicaci√≥n";
      if (btn) {
        originalText = btn.innerText;
        btn.innerText = "‚è≥ Buscando...";
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          console.log("üìç Location Found:", position);

          // Debug Alert for User
          // alert("üìç Ubicaci√≥n detectada. Entrando al mapa...");

          const pos = { lat: position.coords.latitude, lng: position.coords.longitude };

          // Update Map if available
          if (window.map) {
            window.map.setCenter(pos);
            window.map.setZoom(21);
            window.map.setHeading(0);
            window.map.setTilt(45);
          }
          if (window.mapCenter) window.mapCenter = pos;

          // Update UI
          const addrInput = document.getElementById("addressInput");
          if (addrInput) addrInput.value = "Ubicaci√≥n detectada (" + pos.lat.toFixed(5) + ", " + pos.lng.toFixed(5) + ")";

          // Call Solar Logic (Backend)
          if (window.fetchSolarData) {
            window.fetchSolarData(pos.lat, pos.lng);
          } else {
            console.warn("fetchSolarData not ready yet. Calling manually after delay.");
            setTimeout(() => {
              if (window.fetchSolarData) window.fetchSolarData(pos.lat, pos.lng);
            }, 2000);
          }

          if (btn) btn.innerText = originalText;

          // FORCE ADVANCE STEP
          if (typeof window.changeStep === 'function') {
            console.log("üöÄ Advancing to Step 2...");
            window.changeStep(1);
          } else {
            alert("Error: changeStep no existe. Recarga la p√°gina.");
          }
        },
        (error) => {
          console.error("Geo Error:", error);
          let msg = "No pudimos ubicarte.";
          if (error.code === 1) msg = "‚ùå Permiso denegado. Revisa la configuraci√≥n del navegador.";
          if (error.code === 2) msg = "‚ùå Se√±al GPS no disponible.";
          if (error.code === 3) msg = "‚ùå Tiempo de espera agotado (Timeout).";

          alert(msg + "\n\nPor favor escribe tu direcci√≥n manualmente.");

          if (btn) btn.innerText = originalText;
        },
        { enableHighAccuracy: false, timeout: 8000, maximumAge: 0 }
      );
    };
  </script>
  <script src="https://widgets.leadconnectorhq.com/loader.js"
    data-resources-url="https://widgets.leadconnectorhq.com/chat-widget/loader.js"
    data-widget-id="6981012bab03625e91524a50">
    </script>
</body>

</html>