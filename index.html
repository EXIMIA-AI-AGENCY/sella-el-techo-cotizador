<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Cotizador | Sella El Techo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a192f">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700;800&display=swap"
    rel="stylesheet">
  <!-- HTML2PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      /* Core Colors */
      --bg-color: #0a192f;
      --bg-secondary: #0d1f3c;
      --card-bg: #112240;
      --card-elevated: #1a2f4f;
      --text-main: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #ff9900;
      --accent-hover: #ffaa33;
      --accent-light: rgba(255, 153, 0, 0.1);
      --border: #1e3a5f;
      --border-light: #2d4a6f;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      --shadow-glow: 0 0 20px rgba(255, 153, 0, 0.3);

      /* Spacing */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;

      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Override Bootstrap muted text for better visibility on dark theme */
    .text-muted {
      color: var(--text-muted) !important;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-color) 0%, var(--bg-secondary) 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-xl);
      padding-bottom: 120px;
      -webkit-tap-highlight-color: var(--accent-light);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* Prevent unwanted behaviors on mobile */
    * {
      -webkit-touch-callout: none;
      /* Disable callout on long press */
    }

    /* Allow text selection for inputs and text content */
    input,
    textarea,
    p,
    span,
    td,
    th {
      -webkit-touch-callout: default;
      user-select: text;
    }

    .wizard-container {
      max-width: 1000px;
      width: 100%;
      background: var(--card-bg);
      border-radius: var(--radius-2xl);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
      min-height: 650px;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    /* Header & Progress */
    .w-header {
      padding: var(--spacing-xl) var(--spacing-2xl);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, rgba(10, 25, 47, 0.95) 0%, rgba(17, 34, 64, 0.95) 100%);
      backdrop-filter: blur(10px);
    }

    .w-header img {
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
      transition: transform var(--transition-base);
    }

    .w-header img:hover {
      transform: scale(1.02);
    }

    .progress-track {
      height: 6px;
      background: var(--border);
      width: 100%;
      margin-top: 0;
      position: relative;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
      width: 0%;
      transition: width var(--transition-slow);
      box-shadow: var(--shadow-glow);
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    /* Step Content */
    .step-content {
      flex-grow: 1;
      padding: var(--spacing-2xl);
      display: none;
      animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .step-content.active {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(24px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Typography Improvements */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    h1 {
      font-size: 2.5rem;
    }

    h2 {
      font-size: 2rem;
      color: var(--text-main);
    }

    h3 {
      font-size: 1.75rem;
      color: var(--text-main);
    }

    p {
      line-height: 1.6;
      color: var(--text-secondary);
    }

    small {
      color: var(--text-muted);
    }

    /* Map Specifics */
    #map-container {
      width: 100%;
      height: 450px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--border);
      position: relative;
      background: #000;
      /* Loading state */
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* Inputs & UI */
    .search-lg {
      background: transparent;
      border: 2px solid var(--border);
      color: white;
      font-size: 1.2rem;
      padding: 15px 20px;
      border-radius: 12px;
      width: 100%;
      transition: all 0.3s;
    }

    .search-lg:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 20px rgba(255, 153, 0, 0.1);
    }

    .option-card {
      background: linear-gradient(135deg, var(--card-elevated) 0%, var(--card-bg) 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      cursor: pointer;
      transition: all var(--transition-base);
      text-align: center;
      height: 100%;
      user-select: none;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    .option-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0;
      transition: opacity var(--transition-base);
    }

    .option-card:hover {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--card-elevated) 0%, rgba(255, 153, 0, 0.05) 100%);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      transform: translateY(-4px);
    }

    .option-card:hover::before {
      opacity: 1;
    }

    .option-card.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 153, 0, 0.1) 0%, var(--card-elevated) 100%);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      transform: translateY(-2px);
    }

    .option-card.selected::before {
      opacity: 1;
    }

    .option-card:active {
      transform: translateY(0) scale(0.98);
    }

    .option-card .img-3d {
      max-height: 180px;
      width: auto;
      filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.3));
      transition: all 0.3s ease;
    }

    /* Ensure Danosa image fits well */
    #serviceImg {
      max-height: 180px;
      object-fit: contain;
    }

    .option-card:hover img {
      transform: scale(1.05);
    }

    /* 3D Asset Style */
    .img-3d {
      max-height: 200px;
      animation: float 5s ease-in-out infinite;
      /* Seamless Solid Style */
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
    }

    @keyframes float {
      0% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-10px);
      }

      100% {
        transform: translateY(0px);
      }
    }

    /* Footer Navigation */
    .w-footer {
      padding: 20px 30px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      background: var(--bg-color);
      position: relative;
      z-index: 10000;
      /* FORCE TOP LAYER */
    }

    /* Professional Button System */
    .btn {
      font-weight: 600;
      transition: all var(--transition-base);
      user-select: none;
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-lg);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:active::before {
      width: 300px;
      height: 300px;
    }

    .btn-nav {
      padding: 14px 32px;
      border-radius: var(--radius-lg);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.875rem;
      transition: all var(--transition-base);
      user-select: none;
      box-shadow: var(--shadow-md);
    }

    .btn-next {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: #000;
      border: none;
      font-weight: 700;
    }

    .btn-next:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, var(--accent) 100%);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      transform: translateY(-2px);
    }

    .btn-next:active {
      transform: translateY(0);
    }

    .btn-next:disabled {
      background: var(--border);
      cursor: not-allowed;
      transform: none;
      opacity: 0.5;
      box-shadow: none;
    }

    .btn-prev {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text-secondary);
      font-weight: 600;
    }

    .btn-prev:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-light);
      transform: translateY(-2px);
    }

    .btn-prev:active {
      transform: translateY(0);
    }

    /* Warning Button (Continuar, etc) */
    .btn-warning {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border: none;
      color: #000;
      font-weight: 700;
      box-shadow: var(--shadow-md), var(--shadow-glow);
      transition: all var(--transition-base);
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, var(--accent) 100%);
      box-shadow: var(--shadow-lg), 0 0 30px rgba(255, 153, 0, 0.4);
      transform: translateY(-2px);
    }

    .btn-warning:active {
      transform: translateY(0);
    }

    /* Primary Button */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      color: white;
      font-weight: 700;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    /* Summary Specific */
    .summary-table td {
      color: var(--text-muted);
      padding: 10px 0;
      font-size: 0.95rem;
    }

    .summary-table .price {
      color: white;
      text-align: right;
      font-family: 'Inter', monospace;
      font-size: 1.15rem;
      font-weight: 600;
    }

    /* Professional quote header on step 6 */
    #step6 h3 {
      text-transform: uppercase;
      font-weight: 800;
    }

    /* Improved total box */
    #step6 .total-row {
      border-top: 1px solid var(--border);
      margin-top: 10px;
      padding-top: 10px;
      font-size: 1.5rem;
      color: var(--accent);
      font-weight: 800;
      display: flex;
      justify-content: space-between;
    }

    /* Mobile Responsiveness - Enhanced */
    @media (max-width: 768px) {
      body {
        padding: 0 !important;
        margin: 0 !important;
        background-color: var(--card-bg);
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        justify-content: flex-start !important;
        align-items: stretch !important;
      }

      .wizard-container {
        border-radius: 0;
        border: none;
        box-shadow: none;
        height: 100vh;
        height: 100dvh;
        min-height: 100vh;
        min-height: 100dvh;
        max-height: 100vh;
        max-height: 100dvh;
        display: flex;
        flex-direction: column;
        max-width: 100%;
        width: 100%;
        overflow: hidden;
        margin: 0 !important;
      }

      .w-header {
        padding: 8px 15px;
        flex-wrap: wrap;
        gap: 5px;
        flex-shrink: 0;
      }

      .w-header img {
        max-height: 180px !important;
      }

      .w-header .small {
        font-size: 0.75rem !important;
      }

      #backButtonContainer {
        flex-shrink: 0;
        padding: 5px 15px !important;
      }

      .step-content {
        padding: 10px 15px;
        overflow: hidden;
      }

      .step-content.active {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding-top: 20px;
      }

      .step-content > div {
        max-height: 100%;
      }

      /* Steps that need scrolling on mobile */
      #step2B.active,
      #step3.active,
      #step4.active,
      #step5.active,
      #step6.active,
      #step7.active {
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
      }

      #step2B .flex-grow-1 {
        min-height: auto;
        height: auto;
      }

      #map-container {
        height: 35vh;
      }

      .search-lg {
        font-size: 1rem;
        padding: 10px 14px;
      }

      h1 {
        font-size: 1.5rem !important;
      }

      h2 {
        font-size: 1.2rem !important;
        margin-bottom: 0.5rem !important;
      }

      h3 {
        font-size: 1.1rem !important;
      }

      h4 {
        font-size: 1rem !important;
      }

      h5 {
        font-size: 0.9rem !important;
      }

      /* Improved option cards for touch */
      .option-card {
        padding: 15px 10px;
        min-height: auto;
        border-width: 2px;
        /* More visible */
      }

      .option-card h5 {
        font-size: 1.1rem !important;
        margin-top: 10px !important;
      }

      .option-card small {
        font-size: 0.9rem !important;
      }

      /* Better spacing for option grids */
      .row.g-3 {
        gap: 15px !important;
      }

      /* Larger, more tappable buttons */
      .w-footer {
        padding: 15px;
        padding-bottom: 25px;
        padding-right: 90px;
        /* Extra padding for chat widget on right */
        background: var(--card-bg);
        position: sticky;
        bottom: 0;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
        /* Elevation for footer */
        z-index: 900;
        /* Below chat widget but above content */
      }

      .btn-nav {
        padding: 14px 24px;
        font-size: 1rem;
        min-height: 50px;
        /* Better touch target */
        font-weight: 700;
        max-width: 48%;
        /* Ensure buttons don't stretch too much */
        flex-shrink: 1;
      }

      /* Summary table improvements */
      .summary-table td {
        padding: 8px 0;
        font-size: 0.9rem;
      }

      .summary-table .price {
        font-size: 1.05rem;
      }

      /* Professional quote improvements on mobile */
      #step6 h3 {
        font-size: 1.4rem !important;
      }

      #step6 .total-row {
        font-size: 1.2rem;
        padding-top: 15px;
      }

      /* Quote content box */
      #quoteContent {
        padding: 20px 16px !important;
      }

      /* Input improvements */
      input[type="number"] {
        font-size: 1.5rem !important;
        padding: 18px !important;
        text-align: center;
        -webkit-appearance: none;
        -moz-appearance: textfield;
      }

      /* Remove spinner from number inputs */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* Floating area badge on map */
      #map-container .position-absolute {
        max-width: 95% !important;
        margin: 10px !important;
      }

      /* Images */
      .img-3d {
        max-height: 140px !important;
      }

      #serviceImg {
        max-height: 120px !important;
      }

      /* Calendar iframe */
      #step2B .flex-grow-1 {
        min-height: 70vh !important;
      }

      /* Danosa options */
      #danosaOptions {
        padding: 20px 15px !important;
        margin-top: 20px !important;
      }

      #danosaOptions .btn {
        padding: 12px 18px !important;
        font-size: 0.95rem !important;
        min-height: 48px;
        /* Touch friendly */
      }

      /* Layer adjustment buttons */
      #layersInput .btn {
        width: 44px;
        height: 44px;
        font-size: 1.2rem;
        padding: 0;
      }

      #layersInput #layerCount {
        font-size: 1.8rem !important;
        min-width: 60px;
      }

      /* Action buttons (Continuar, etc) */
      .btn-warning {
        font-size: 1.1rem !important;
        padding: 15px 30px !important;
        min-height: 54px;
      }

      /* PDF Download button */
      .btn-success {
        font-size: 1rem !important;
        padding: 12px 20px !important;
        min-height: 50px;
      }

      /* Quote content box */
      #quoteContent {
        padding: 20px 15px !important;
      }

      /* Better text sizing */
      p {
        font-size: 1rem;
        line-height: 1.5;
      }

      small {
        font-size: 0.875rem !important;
      }

      /* Prevent zoom on focus for iOS */
      select,
      textarea,
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="tel"] {
        font-size: 16px !important;
        /* Prevents zoom on iOS */
      }
    }

    /* Extra small devices (phones in portrait) */
    @media (max-width: 576px) {
      .w-header img {
        max-height: 150px !important;
      }

      .w-header {
        padding: 5px 10px !important;
      }

      h2 {
        font-size: 1.1rem !important;
      }

      h3 {
        font-size: 1rem !important;
      }

      .option-card {
        padding: 12px 10px;
      }

      .option-card h1 {
        font-size: 1.5rem !important;
        margin-bottom: 0 !important;
      }

      .option-card h3 {
        font-size: 0.95rem !important;
        margin-top: 0.3rem !important;
      }

      .option-card small {
        font-size: 0.75rem !important;
      }

      .total-row {
        font-size: 1rem;
        flex-direction: column;
        align-items: flex-end;
        gap: 3px;
      }

      .row.g-4 {
        --bs-gutter-y: 0.5rem;
        --bs-gutter-x: 0.5rem;
      }

      .mb-4 {
        margin-bottom: 0.5rem !important;
      }

      .mt-4 {
        margin-top: 0.5rem !important;
      }

      .py-3 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }

      input[type="number"] {
        font-size: 1.1rem !important;
        padding: 10px !important;
      }

      #quoteContent {
        padding: 10px !important;
      }

      #quoteContent table {
        font-size: 0.85rem;
      }
    }

    /* Modal improvements for mobile */
    @media (max-width: 768px) {
      .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
      }

      .modal-content {
        border-radius: 15px;
      }

      .modal-body {
        padding: 20px;
        font-size: 1rem;
        line-height: 1.6;
      }

      .modal-header {
        padding: 15px 20px;
      }

      .modal-title {
        font-size: 1.25rem !important;
      }

      .btn-close {
        font-size: 1.2rem;
        padding: 10px;
      }
    }

    /* Landscape mobile optimization */
    @media (max-width: 896px) and (orientation: landscape) {
      .wizard-container {
        max-height: 100vh;
        overflow-y: auto;
      }

      .step-content {
        padding: 15px;
      }

      .img-3d {
        max-height: 100px !important;
      }

      .option-card {
        padding: 15px 10px;
        min-height: 100px;
      }

      h3 {
        font-size: 1.1rem !important;
      }
    }

    /* Chat widget accommodation */
    /* Ensure chat widget doesn't cover important content */
    @media (max-width: 768px) {
      /* Add safe area for chat widget on mobile */
      .wizard-container {
        padding-bottom: 80px;
        /* Space for chat widget bubble */
      }

      /* Adjust footer to stay above fold with chat widget */
      .w-footer {
        margin-bottom: 0;
        padding-bottom: 20px;
        padding-right: 90px;
        /* Critical: Ensure buttons don't overlap with chat */
      }

      /* Ensure summary content doesn't get hidden */
      #step6 {
        padding-bottom: 100px !important;
      }
    }

    /* Desktop chat widget spacing */
    @media (min-width: 769px) {
      /* Ensure PDF button and actions don't overlap with chat */
      #step6 .col-md-8 {
        padding-right: 120px;
        /* Space for chat widget on right side */
      }
    }
  </style>
</head>

<body>

  <div class="wizard-container">

    <!-- Header -->
    <div class="w-header">
      <img src="assets/logo_white_ps.png" alt="Sella El Techo"
        style="max-height: 450px; width: auto; object-fit: contain;">
      <div class="text-muted small" id="stepCounter">Paso <span id="stepCount" class="font-monospace">1</span> de 7</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Back Button -->
    <div class="px-3 pt-2" id="backButtonContainer" style="display: none;">
      <button class="btn btn-link text-muted p-0" id="btnPrev" type="button" onclick="changeStep(-1)">
        <span style="font-size: 14px;">‚Üê Atr√°s</span>
      </button>
    </div>

    <!-- STEP 1: Qualification -->
    <div class="step-content active" id="step1">
      <div class="text-center my-auto px-5">
        <h2 class="mb-4">¬øConoces los pies cuadrados de tu techo?</h2>
        <div class="row justify-content-center g-4">
          <div class="col-md-5">
            <div class="option-card" onclick="setKnowsSqFt(true, this)">
              <h1 class="mb-0">‚úÖ</h1>
              <h3 class="mt-3">S√≠, los conozco</h3>
              <small class="text-muted">Ingresar medidas manuales</small>
            </div>
          </div>
          <div class="col-md-5">
            <div class="option-card" onclick="setKnowsSqFt(false, this)">
              <h1 class="mb-0">‚ùå</h1>
              <h3 class="mt-3">No, necesito ayuda</h3>
              <small class="text-muted">Agendar cita con un experto</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2A: Manual Input (YES path) -->
    <div class="step-content" id="step2A">
      <div class="text-center my-auto px-5">
        <h3 class="mb-4">Ingresa el tama√±o del techo</h3>
        <div class="d-flex justify-content-center align-items-center gap-3">
          <input type="number" id="inputSqFt" class="search-lg text-center" placeholder="1500" style="width: 200px;" min="100" step="1">
          <span class="fs-4 text-muted">ft¬≤</span>
        </div>
        <p class="text-muted mt-3">Ingresa el √°rea total a sellar.</p>
        <button class="btn btn-warning fw-bold px-5 mt-3" onclick="confirmManualSqFt()">Continuar ‚û°Ô∏è</button>
        <!-- Debug info -->
        <div id="debugArea" class="mt-3 small text-warning" style="display:none;"></div>
      </div>
    </div>

    <!-- STEP 2B: Calendar (NO path) -->
    <div class="step-content" id="step2B">
      <div class="text-center h-100 d-flex flex-column">
        <h3 class="mb-2">Agenda tu Inspecci√≥n</h3>
        <p class="text-muted mb-3">Uno de nuestros expertos te visitar√° para medir.</p>

        <!-- CALENDAR EMBED -->
        <div class="flex-grow-1 border border-secondary rounded overflow-hidden"
          style="background: #fff; min-height: 600px;">
          <iframe src="https://api.leadconnectorhq.com/widget/booking/hSO8bJXNuwvua7DybRJ7"
            style="width: 100%; height: 100%; border:none; overflow: hidden;" scrolling="no"
            id="hSO8bJXNuwvua7DybRJ7_1769897386462">
          </iframe>
          <script src="https://link.msgsndr.com/js/form_embed.js" type="text/javascript"></script>
        </div>
      </div>
    </div>

    <!-- Hidden Step 2 Legacy Map (Preserved but Hidden) -->
    <div class="step-content" id="stepMapHidden" style="display:none!important">
      <div class="step-content" id="step2">
        <div class="row h-100">
          <div class="col-12 mb-3">
            <div class="d-flex justify-content-between align-items-end mb-2">
              <div>
                <h3 class="mb-1">Selecciona el Techo</h3>
                <p class="text-muted small m-0">Haz clic en la casa para detectar. O usa modo manual.</p>
              </div>
              <button id="btnDrawToggle" class="btn btn-sm btn-outline-secondary" onclick="toggleDrawMode()">‚úèÔ∏è Dibujar
                Manual</button>
            </div>
            <script>
              let manualMode = false;
              function toggleDrawMode() {
                manualMode = !manualMode;
                if (window.setManualDraw) window.setManualDraw(manualMode);
                const btn = document.getElementById('btnDrawToggle');
                if (manualMode) {
                  btn.className = 'btn btn-sm btn-primary';
                  btn.innerText = 'üëÜ Volver a Auto';
                } else {
                  btn.className = 'btn btn-sm btn-outline-secondary';
                  btn.innerText = '‚úèÔ∏è Dibujar Manual';
                }
              }
            </script>
          </div>
          <div class="col-12">
            <div id="map-container">
              <div id="map"></div>

              <!-- Floating Area Badge -->
              <!-- Floating Area Badge -->
              <div
                class="position-absolute bottom-0 end-0 m-3 bg-dark text-white p-3 rounded shadow border border-secondary"
                style="max-width: 280px; z-index: 1000;">
                <small class="text-muted d-block uppercase" style="font-size:0.7em;">Area Promedio Estimada</small>
                <div class="fw-bold fs-3 text-warning mb-2 lh-1"><span id="liveArea">0</span> <small
                    class="fs-6 text-white">ft¬≤</small></div>

                <div class="small border-top border-secondary pt-2 mb-2">
                  <div class="d-flex justify-content-between">
                    <span class="text-muted">üì° Sat√©lite:</span>
                    <span id="valSat" class="fw-bold text-light">-</span>
                  </div>
                </div>

                <div class="mt-2 text-end border-top border-secondary pt-2">
                  <button class="btn btn-warning w-100 fw-bold" onclick="changeStep(1)">
                    ‚úÖ Confirmar y Seguir
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- STEP 3: Cistern -->
    <div class="step-content" id="step3">
      <div class="text-center my-auto">
        <img src="assets/cistern.png" class="img-3d img-fluid mb-4">
        <h3 class="mb-3">¬øTienes Cisterna?</h3>
        <div class="row justify-content-center g-3">
          <div class="col-md-5">
            <div class="option-card" onclick="setOption('cistern', false, this)">
              <h5 class="mt-2">No</h5>
              <small class="text-muted">Techo libre</small>
            </div>
          </div>
          <div class="col-md-5">
            <div class="option-card" onclick="setOption('cistern', true, this)">
              <h5 class="mt-2">S√≠ (+$150)</h5>
              <small class="text-muted">Incluye movimiento</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 4: Solar -->
    <div class="step-content" id="step4">
      <div class="text-center my-auto">
        <img src="assets/solar.png" class="img-3d img-fluid mb-4">
        <h3 class="mb-3">¬øPlacas Solares?</h3>
        <div class="row justify-content-center g-3">
          <div class="col-md-5">
            <div class="option-card" onclick="setOption('solar', false, this)">
              <h5 class="mt-2">No</h5>
              <small class="text-muted">Sin sistema solar</small>
            </div>
          </div>
          <div class="col-md-5">
            <div class="option-card" onclick="setOption('solar', true, this)">
              <h5 class="mt-2">S√≠ (+$1,000)</h5>
              <small class="text-muted">Protecci√≥n especial</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 5: Service Type -->
    <div class="step-content" id="step5">
      <div class="text-center my-auto">
        <img src="assets/service.png" id="serviceImg" class="img-3d img-fluid mb-4">
        <h3 class="mb-3">Tipo de Sellado</h3>

        <div class="row justify-content-center g-3 mb-4">
          <div class="col-md-4">
            <div class="option-card" onclick="setOption('service', 'Silicona', this)">
              <h5 class="mt-2 text-warning">Silicona 100%</h5>
              <small class="text-muted">Premium Reflectivo</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="option-card" onclick="setOption('service', 'Danosa', this)">
              <h5 class="mt-2">Danosa</h5>
              <small class="text-muted">Membrana Asf√°ltica</small>
            </div>
          </div>
        </div>

        <!-- DANOSA EXTRA OPTIONS -->
        <div id="danosaOptions" class="mt-4 p-3 border border-secondary rounded"
          style="display:none; background: rgba(255,153,0,0.05);">
          <h5 class="mb-3 text-warning">Opciones de Remoci√≥n</h5>
          <p class="small text-muted">¬øNecesitas remover membrana vieja?</p>

          <div class="d-flex justify-content-center gap-3 mb-3">
            <button class="btn btn-outline-light btn-sm" onclick="setRemoval(false, this)">No, techo limpio</button>
            <button class="btn btn-outline-light btn-sm" onclick="setRemoval(true, this)">S√≠, remover viejo</button>
          </div>

          <div id="layersInput" style="display:none;">
            <label class="small text-muted mb-2">¬øCu√°ntas capas estimadas hay?</label>
            <div class="d-flex justify-content-center align-items-center gap-2">
              <button class="btn btn-secondary btn-sm" onclick="adjLayers(-1)">-</button>
              <span id="layerCount" class="fw-bold fs-5 px-3">1</span>
              <button class="btn btn-secondary btn-sm" onclick="adjLayers(1)">+</button>
            </div>
            <small class="text-warning d-block mt-2">*Si hay m√°s de 2 capas, se cobra extra ($1/ft¬≤ por capa
              adicional).</small>
          </div>

          <button id="danosaContinueBtn" class="btn btn-warning w-100 mt-3 py-2 fw-bold" style="display:none;" onclick="changeStep(1)">
            Continuar ‚Üí
          </button>
        </div>

      </div>
    </div>

    <!-- STEP 6: Contact Information (NEW) -->
    <div class="step-content" id="step6">
      <div class="row justify-content-center h-100 align-items-center">
        <div class="col-md-7">
          <div class="text-center mb-4">
            <h3 class="mb-2">üìã Informaci√≥n de Contacto</h3>
            <p class="text-secondary">Para enviarte tu cotizaci√≥n y coordinar el servicio</p>
          </div>

          <div class="p-4 rounded border border-warning" style="background: linear-gradient(135deg, var(--card-elevated) 0%, var(--card-bg) 100%);">
            <form id="contactForm" onsubmit="return false;">
              <div class="mb-3">
                <label for="contactName" class="form-label text-light">Nombre Completo *</label>
                <input type="text" class="form-control search-lg" id="contactName" required
                  placeholder="Juan P√©rez" style="background: var(--card-bg); color: white;">
              </div>

              <div class="mb-3">
                <label for="contactEmail" class="form-label text-light">Email *</label>
                <input type="email" class="form-control search-lg" id="contactEmail" required
                  placeholder="juan@email.com" style="background: var(--card-bg); color: white;">
              </div>

              <div class="mb-3">
                <label for="contactPhone" class="form-label text-light">Tel√©fono *</label>
                <input type="tel" class="form-control search-lg" id="contactPhone" required
                  placeholder="(787) 123-4567" style="background: var(--card-bg); color: white;">
              </div>

              <div class="mb-3">
                <label for="contactAddress" class="form-label text-light">Direcci√≥n de la Propiedad</label>
                <textarea class="form-control search-lg" id="contactAddress" rows="2"
                  placeholder="Calle, Ciudad, PR" style="background: var(--card-bg); color: white;"></textarea>
                <small class="text-muted">Opcional - ayuda para la inspecci√≥n</small>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="contactConsent" required
                  style="width: 20px; height: 20px; cursor: pointer;">
                <label class="form-check-label text-secondary ms-2" for="contactConsent" style="cursor: pointer;">
                  Acepto recibir informaci√≥n sobre mi cotizaci√≥n y servicios de Sella El Techo
                </label>
              </div>

              <button type="button" class="btn btn-warning w-100 py-3 fw-bold" onclick="submitContactAndProceed()">
                ‚úÖ Confirmar y Ver Cotizaci√≥n
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 7: Quote Summary (renamed from step6) -->
    <div class="step-content" id="step7">
      <div class="row justify-content-center h-100 align-items-center">
        <div class="col-md-8">
          <!-- Debug alert for missing area -->
          <div id="areaWarning" class="alert alert-danger mb-3" style="display:none;">
            <strong>‚ö†Ô∏è ERROR:</strong> No se detect√≥ el √°rea del techo.<br>
            <small>state.area = <span id="debugStateArea">0</span></small><br>
            <small>window.manualArea = <span id="debugWindowArea">0</span></small><br>
            <small>DOM input = <span id="debugDomInput">N/A</span></small>
          </div>

          <div class="p-4 rounded border border-warning" style="background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2))" id="quoteContent">
            <div class="text-center mb-4">
              <h3 class="text-warning fw-bold mb-1" style="letter-spacing: 1px;">COTIZACI√ìN PROFESIONAL</h3>
              <p class="text-muted small mb-0">Sella El Techo</p>
            </div>

            <table class="w-100 summary-table">
              <tr>
                <td class="text-muted">√Årea Geom√©trica (3D)</td>
                <td class="text-end text-light"><span id="sumAreaRaw">0</span> ft¬≤</td>
              </tr>
              <tr class="text-muted small">
                <td style="padding-left: 20px;">+ Seguridad (<span id="lblWaste">15</span>%)</td>
                <td class="text-end">+<span id="sumWaste">0</span> ft¬≤</td>
              </tr>
              <tr class="border-bottom border-warning" style="border-width: 2px !important;">
                <td class="pb-3 pt-2 fw-bold">Material Requerido</td>
                <td class="text-end fw-bold pb-3 pt-2 text-warning" id="sumeffectiveArea">0 ft¬≤</td>
              </tr>
              <tr>
                <td class="pt-3">Precio Base</td>
                <td class="price pt-3" id="sumBase">$0.00</td>
              </tr>
              <tr id="rowCistern" style="display:none">
                <td>Remoci√≥n / Manejo de Cisterna</td>
                <td class="price text-warning">+$150.00</td>
              </tr>
              <tr id="rowSolar" style="display:none">
                <td>Remoci√≥n / Desmontaje Placas Solares</td>
                <td class="price text-warning">+$1,000.00</td>
              </tr>
              <tr class="border-top border-secondary">
                <td class="pt-3 text-muted">IVU (11.5%)</td>
                <td class="pt-3 price text-muted" id="sumTax">$0.00</td>
              </tr>
            </table>

            <div class="mt-4 p-3 rounded" style="background: rgba(255, 153, 0, 0.1); border: 2px solid var(--accent);">
              <div class="d-flex justify-content-between align-items-center">
                <span class="fs-4 fw-bold text-light">TOTAL</span>
                <span id="sumTotal" class="fs-3 fw-bold text-warning">$0.00</span>
              </div>
            </div>

            <div class="mt-3 p-2 text-center" style="background: rgba(255, 153, 0, 0.05); border-radius: 8px;">
              <p class="mb-0 text-muted small">
                <i class="text-warning">*</i> Precio sujeto a inspecci√≥n f√≠sica final
              </p>
            </div>
          </div>

          <div class="text-center mt-4 d-grid gap-2">
            <button class="btn btn-primary py-3 fw-bold" onclick="goToCalendar(6)">üìÖ Agendar d√≠a del sellado</button>
            <button class="btn btn-warning py-3 fw-bold" onclick="downloadPDF()">üì• Descargar PDF</button>
            <button onclick="location.reload()" class="btn btn-link text-muted small text-decoration-none mt-2">Empezar
              de nuevo</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  </div>


  <!-- Bootstrap JS (Required for Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Logic -->
  <script src="js/map_logic.js?v=fix_loc_final"></script>
  <!-- Google Maps API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBR72tWGSonQu3eMgfcEUZdDiAcqaQ_bhA&libraries=places,drawing,geometry&callback=initMap"
    async defer></script>

  <script>
    let currentStep = 1;
    const totalSteps = 7;
    const state = {
      address: '',
      area: 0,
      cistern: null,
      solar: null,
      service: null,
      // New fields
      knowsSqFt: null,
      removal: false,
      layers: 1,
      manualOverride: false
    };

    // --- NEW LOGIC START ---

    let previousStepForCalendar = 1;

    function goToCalendar(originStep) {
      previousStepForCalendar = originStep;
      showStep('step2B');
      currentStep = 99; // Calendar Mode
      updateSteps();
    }

    function setKnowsSqFt(knows, el) {
      console.log("setKnowsSqFt clicked:", knows);
      state.knowsSqFt = knows;

      // Visual feedback
      const cards = document.querySelectorAll('#step1 .option-card');
      cards.forEach(c => c.classList.remove('selected'));
      if (el) el.classList.add('selected');

      setTimeout(() => {
        if (knows) {
          // Go to Manual Input
          showStep('step2A');
          currentStep = 2; // technical mapping
        } else {
          // Go to Calendar
          goToCalendar(1);
        }
        updateSteps();
      }, 300);
    }

    function confirmManualSqFt() {
      const input = document.getElementById('inputSqFt');
      const val = parseFloat(input.value);

      console.log("confirmManualSqFt() called with input value:", input.value);
      console.log("Parsed value:", val);

      if (!val || val < 100) {
        alert("Por favor ingresa un tama√±o v√°lido (min 100 ft).");
        return;
      }

      // STRICT STATE SETTING - Triple redundancy to ensure persistence
      state.area = val;
      state.knowsSqFt = true;
      state.manualOverride = true; // Flag to prevent map from overwriting
      window.manualArea = val;

      console.log("‚úÖ CONFIRMED MANUAL AREA:", val);
      console.log("State after confirmation:", {
        area: state.area,
        knowsSqFt: state.knowsSqFt,
        manualOverride: state.manualOverride,
        windowManualArea: window.manualArea
      });

      // Show debug info
      const debugDiv = document.getElementById('debugArea');
      if (debugDiv) {
        debugDiv.style.display = 'block';
        debugDiv.innerHTML = `‚úÖ √Årea capturada: ${val} ft¬≤ (state.area: ${state.area}, window.manualArea: ${window.manualArea})`;
      }

      // NAVIGATE TO STEP 3
      currentStep = 3;
      showStep('step3'); // Explicit ID
      updateSteps();
    }

    // Submit contact form and create GoHighLevel contact
    async function submitContactAndProceed() {
      console.log("submitContactAndProceed() called");

      // 1. Validate form
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();
      const address = document.getElementById('contactAddress').value.trim();
      const consent = document.getElementById('contactConsent').checked;

      if (!name || !email || !phone) {
        alert('‚ö†Ô∏è Por favor completa todos los campos requeridos (Nombre, Email, Tel√©fono)');
        return;
      }

      if (!consent) {
        alert('‚ö†Ô∏è Debes aceptar recibir informaci√≥n para continuar');
        return;
      }

      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('‚ö†Ô∏è Por favor ingresa un email v√°lido');
        return;
      }

      // Phone validation (basic)
      if (phone.length < 10) {
        alert('‚ö†Ô∏è Por favor ingresa un tel√©fono v√°lido');
        return;
      }

      // 2. Calculate quote total
      let finalArea = state.area || window.manualArea || 0;
      if (finalArea === 0) {
        alert('‚ö†Ô∏è Error: No se detect√≥ el √°rea del techo. Por favor regresa y completa los pasos anteriores.');
        return;
      }

      // Calculate rates
      let baseRate = 4.50; // Silicona
      let surchargeRate = 0;

      if (state.service === 'Danosa') {
        baseRate = 3.50;
        if (state.removal && state.layers >= 2) {
          surchargeRate = (state.layers - 1) * 1.00;
        }
      }

      const totalRate = baseRate + surchargeRate;
      const materialCost = finalArea * totalRate;
      const cisternCost = state.cistern ? 150.00 : 0;
      const solarCost = state.solar ? 1000.00 : 0;
      const subtotal = materialCost + cisternCost + solarCost;
      const tax = subtotal * 0.115;
      const grandTotal = subtotal + tax;

      // 3. Show loading state
      const submitBtn = document.querySelector('#contactForm button[type="button"]');
      const originalText = submitBtn.innerText;
      submitBtn.innerText = '‚è≥ Enviando...';
      submitBtn.disabled = true;

      try {
        // 4. Send to GoHighLevel API
        const ghlToken = 'pit-f3ebb971-2fd1-415b-91f0-f4449c8e5314';
        const ghlLocationId = 'LVwbqYFEmGiKJ7AgtSIf';
        const ghlApiUrl = 'https://services.leadconnectorhq.com/contacts/';

        const contactData = {
          locationId: ghlLocationId,
          firstName: name.split(' ')[0] || name,
          lastName: name.split(' ').slice(1).join(' ') || '',
          email: email,
          phone: phone,
          address1: address || '',
          source: 'Cotizador Online',
          tags: ['cotizador-online', state.service ? state.service.toLowerCase() : 'sin-servicio'],
          customFields: [
            {
              key: 'area_pies_cuadrados',
              value: Math.round(finalArea).toString()
            },
            {
              key: 'valor_cotizacion',
              value: grandTotal.toFixed(2)
            },
            {
              key: 'tipo_servicio',
              value: state.service || 'No seleccionado'
            },
            {
              key: 'tiene_cisterna',
              value: state.cistern ? 'S√≠' : 'No'
            },
            {
              key: 'tiene_placas_solares',
              value: state.solar ? 'S√≠' : 'No'
            },
            {
              key: 'direccion_propiedad',
              value: address || 'No proporcionada'
            }
          ]
        };

        console.log("Sending to GHL:", contactData);

        const response = await fetch(ghlApiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ghlToken}`,
            'Content-Type': 'application/json',
            'Version': '2021-07-28'
          },
          body: JSON.stringify(contactData)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('GHL API Error:', errorText);
          throw new Error(`Error del servidor: ${response.status}`);
        }

        const result = await response.json();
        console.log('‚úÖ Contact created in GHL:', result);

        // 5. Send quote data to webhook
        const webhookUrl = 'https://services.leadconnectorhq.com/hooks/LVwbqYFEmGiKJ7AgtSIf/webhook-trigger/b275a7d9-e59e-4a55-9380-bc2a2bd33248';

        const quoteData = {
          // Contact Information
          contactId: result.contact?.id || null,
          nombre: name,
          email: email,
          telefono: phone,
          direccion: address || '',

          // Quote Details
          area_pies_cuadrados: Math.round(finalArea),
          tipo_servicio: state.service || 'No seleccionado',

          // Pricing Breakdown
          precio_por_pie: totalRate,
          costo_material: materialCost.toFixed(2),
          costo_cisterna: cisternCost.toFixed(2),
          costo_solar: solarCost.toFixed(2),
          subtotal: subtotal.toFixed(2),
          ivu: tax.toFixed(2),
          total: grandTotal.toFixed(2),

          // Additional Options
          tiene_cisterna: state.cistern ? true : false,
          tiene_placas_solares: state.solar ? true : false,
          requiere_remocion: state.removal ? true : false,
          capas_remocion: state.layers || 1,

          // Metadata
          fuente: 'Cotizador Online',
          fecha_cotizacion: new Date().toISOString(),
          url_origen: window.location.href
        };

        console.log("Sending quote to webhook:", quoteData);

        // Send to webhook - await to ensure it completes
        try {
          const webhookResponse = await fetch(webhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(quoteData)
          });
          console.log('‚úÖ Quote sent to webhook, status:', webhookResponse.status);
        } catch (webhookError) {
          // If CORS fails, try with no-cors (won't get response but data is sent)
          console.warn('‚ö†Ô∏è Webhook CORS error, retrying with no-cors:', webhookError.message);
          try {
            await fetch(webhookUrl, {
              method: 'POST',
              body: JSON.stringify(quoteData),
              mode: 'no-cors'
            });
            console.log('‚úÖ Quote sent to webhook (no-cors fallback)');
          } catch (fallbackError) {
            console.error('‚ö†Ô∏è Webhook fallback also failed:', fallbackError);
          }
        }

        // 6. Create Invoice in Draft status
        const contactId = result.contact?.id;
        if (contactId) {
          try {
            const invoiceApiUrl = 'https://services.leadconnectorhq.com/invoices/';

            // Build line items for the invoice
            const invoiceItems = [];

            // Main service item
            invoiceItems.push({
              name: `Sellado de Techo - ${state.service || 'Profesional'}`,
              description: `√Årea: ${Math.round(finalArea).toLocaleString()} ft¬≤ √ó $${totalRate.toFixed(2)}/ft¬≤`,
              price: materialCost,
              qty: 1
            });

            // Cistern if applicable
            if (state.cistern) {
              invoiceItems.push({
                name: 'Remoci√≥n / Manejo de Cisterna',
                description: 'Servicio adicional de manejo de cisterna',
                price: 150.00,
                qty: 1
              });
            }

            // Solar panels if applicable
            if (state.solar) {
              invoiceItems.push({
                name: 'Remoci√≥n / Desmontaje Placas Solares',
                description: 'Servicio adicional de desmontaje de placas solares',
                price: 1000.00,
                qty: 1
              });
            }

            // Calculate due date (30 days from now)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);

            const invoiceData = {
              contactId: contactId,
              name: `Cotizaci√≥n Sellado - ${name}`,
              title: 'Cotizaci√≥n de Sellado de Techo',
              dueDate: dueDate.toISOString().split('T')[0],
              status: 'draft',
              currency: 'USD',
              items: invoiceItems,
              amountDue: grandTotal,
              businessDetails: {
                name: 'Sella El Techo',
                address: 'Puerto Rico',
                phone: '(787) 123-4567',
                email: 'info@sellaeltecho.com'
              },
              invoiceNote: `Cotizaci√≥n generada autom√°ticamente desde el Cotizador Online.\n\nDetalles:\n- √Årea: ${Math.round(finalArea).toLocaleString()} ft¬≤\n- Servicio: ${state.service || 'No especificado'}\n- IVU (11.5%): $${tax.toFixed(2)}\n\n* Precio sujeto a inspecci√≥n f√≠sica final`,
              terms: 'Precio v√°lido por 30 d√≠as. Sujeto a inspecci√≥n f√≠sica final.'
            };

            console.log("Creating invoice in GHL:", invoiceData);

            const invoiceResponse = await fetch(invoiceApiUrl, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${ghlToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
              },
              body: JSON.stringify(invoiceData)
            });

            if (invoiceResponse.ok) {
              const invoiceResult = await invoiceResponse.json();
              console.log('‚úÖ Invoice created in draft:', invoiceResult);
              state.invoiceId = invoiceResult.invoice?.id || invoiceResult.id;
            } else {
              const invoiceError = await invoiceResponse.text();
              console.warn('‚ö†Ô∏è Invoice creation failed (non-blocking):', invoiceError);
            }
          } catch (invoiceError) {
            console.error('‚ö†Ô∏è Invoice creation error (non-blocking):', invoiceError);
          }
        }

        // 7. Store contact info in state for display
        state.contactName = name;
        state.contactEmail = email;
        state.contactPhone = phone;
        state.contactAddress = address;

        // 8. Navigate to Step 7 (Quote Summary)
        currentStep = 7;
        showStep('step7');
        updateSteps();

      } catch (error) {
        console.error('Error creating contact:', error);
        alert('‚ö†Ô∏è Hubo un problema al enviar tu informaci√≥n. Por favor intenta de nuevo o cont√°ctanos directamente.\n\nError: ' + error.message);

        // Restore button state
        submitBtn.innerText = originalText;
        submitBtn.disabled = false;
      }
    }

    // ...

    function renderSummary() {
      console.log("--- RENDER SUMMARY (ROBUST REWRITE) ---");
      console.log("DEBUG: state.area =", state.area);
      console.log("DEBUG: window.manualArea =", window.manualArea);
      console.log("DEBUG: state.knowsSqFt =", state.knowsSqFt);
      console.log("DEBUG: state =", JSON.stringify(state));

      // Update debug display
      const inputEl = document.getElementById('inputSqFt');
      const inputValue = inputEl ? inputEl.value : 'N/A';

      document.getElementById('debugStateArea').innerText = state.area || '0 (undefined)';
      document.getElementById('debugWindowArea').innerText = window.manualArea || '0 (undefined)';
      document.getElementById('debugDomInput').innerText = inputValue;

      // 1. RESOLVE AREA
      // Priority: State -> Window Global -> DOM Input
      let finalArea = state.area;

      if (!finalArea || finalArea === 0) {
        console.log("DEBUG: state.area is 0 or empty, trying window.manualArea");
        if (typeof window.manualArea === 'number' && window.manualArea > 0) {
          finalArea = window.manualArea;
          console.log("DEBUG: Using window.manualArea =", finalArea);
        }
      }

      // Fallback 2: Read DOM Input directly (Crucial for "User entered footage" handling)
      if (!finalArea || finalArea === 0) {
        console.log("DEBUG: Trying to read from DOM input");
        if (inputEl && inputEl.value) {
          const val = parseFloat(inputEl.value);
          if (val > 0) {
            finalArea = val;
            console.log("DEBUG: Using DOM input value =", finalArea);
            // Update state to preserve this value
            state.area = val;
            window.manualArea = val;
          }
        }
      }

      // Final Validity Check
      if (!finalArea || finalArea === 0) {
        console.error("‚ùå ERROR: Area could not be resolved. It is 0.");
        console.error("DEBUG: All fallbacks failed!");

        // Show warning alert
        document.getElementById('areaWarning').style.display = 'block';

        // Display error message
        document.getElementById('sumBase').innerText = "$0.00 (Falta √Årea)";
        document.getElementById('sumTax').innerText = "$0.00";
        document.getElementById('sumTotal').innerText = "$0.00";
        return; // Stop processing if no area is available
      }

      // Hide warning if area found
      document.getElementById('areaWarning').style.display = 'none';

      console.log("‚úÖ SUCCESS: finalArea resolved to:", finalArea);

      // 2. CALCULATE RATES & SURCHARGES
      let baseRate = 4.50; // Default Silicona
      let surchargeRate = 0;
      let surchargeLabel = "";

      console.log("Service type:", state.service);

      if (state.service === 'Danosa') {
        baseRate = 3.50;
        console.log("‚úÖ Danosa selected - Using $3.50 per ft¬≤");
        // Logic: Removal adds $1.00 starting from 2nd layer
        if (state.removal && state.layers >= 2) {
          const extra = state.layers - 1;
          surchargeRate = extra * 1.00;
          surchargeLabel = ` (Inc. ${extra} capa${extra > 1 ? 's' : ''} removida${extra > 1 ? 's' : ''})`;
          console.log(`Adding removal surcharge: ${extra} layer(s) √ó $1.00 = $${surchargeRate}/ft¬≤`);
        }
      } else {
        console.log("Silicona selected - Using $4.50 per ft¬≤");
      }

      const totalRate = baseRate + surchargeRate;
      const materialCost = finalArea * totalRate;

      console.log("Calculation breakdown:");
      console.log(`  Base rate: $${baseRate}/ft¬≤`);
      console.log(`  Surcharge: $${surchargeRate}/ft¬≤`);
      console.log(`  Total rate: $${totalRate}/ft¬≤`);
      console.log(`  Area: ${finalArea} ft¬≤`);
      console.log(`  Material cost: $${materialCost.toFixed(2)}`);

      // 3. FIXED COSTS
      const cisternCost = state.cistern ? 150.00 : 0;
      const solarCost = state.solar ? 1000.00 : 0;

      console.log("Add-ons:");
      console.log(`  Cisterna: ${state.cistern ? 'Yes' : 'No'} - $${cisternCost}`);
      console.log(`  Placas Solares: ${state.solar ? 'Yes' : 'No'} - $${solarCost}`);

      // 4. TOTALS
      const subtotal = materialCost + cisternCost + solarCost;
      const tax = subtotal * 0.115; // 11.5% IVU
      const grandTotal = subtotal + tax;

      console.log("Final totals:");
      console.log(`  Subtotal: $${subtotal.toFixed(2)}`);
      console.log(`  Tax (11.5%): $${tax.toFixed(2)}`);
      console.log(`  Grand Total: $${grandTotal.toFixed(2)}`);

      // 5. UPDATE UI SAFEGUARDS
      safeSetText('sumAreaRaw', Math.round(finalArea).toLocaleString());
      safeSetText('sumeffectiveArea', Math.round(finalArea).toLocaleString() + " ft¬≤");

      safeSetText('sumBase', formatMoney(materialCost) + surchargeLabel);

      const rCis = document.getElementById('rowCistern');
      if (rCis) rCis.style.display = state.cistern ? 'table-row' : 'none';

      const rSol = document.getElementById('rowSolar');
      if (rSol) rSol.style.display = state.solar ? 'table-row' : 'none';

      safeSetText('sumTax', formatMoney(tax));
      safeSetText('sumTotal', formatMoney(grandTotal));
    }

    function safeSetText(id, text) {
      const el = document.getElementById(id);
      if (el) el.innerText = text;
    }

    // DANOSA LOGIC
    function setRemoval(isRemoval, btn) {
      state.removal = isRemoval;
      // UI toggle
      const parent = btn.parentElement;
      parent.querySelectorAll('.btn').forEach(b => {
        b.classList.remove('btn-light', 'text-dark');
        b.classList.add('btn-outline-light');
      });
      btn.classList.remove('btn-outline-light');
      btn.classList.add('btn-light', 'text-dark');

      const layerDiv = document.getElementById('layersInput');
      layerDiv.style.display = isRemoval ? 'block' : 'none';

      // Show continue button after selection
      const continueBtn = document.getElementById('danosaContinueBtn');
      if (continueBtn) continueBtn.style.display = 'block';

      validateStep();
    }

    function adjLayers(delta) {
      let newL = state.layers + delta;
      if (newL < 1) newL = 1;
      if (newL > 5) newL = 5;
      state.layers = newL;
      document.getElementById('layerCount').innerText = newL;
    }

    // Helper to manually show specific ID (bypassing number logic occasionally)
    function showStep(id) {
      document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      // Progress Bar Update based on numeric currentStep
      // If 99 (Calendar), full bar
      let pct = ((currentStep - 1) / (totalSteps - 1)) * 100;
      if (currentStep === 99) pct = 100;
      document.getElementById('progressFill').style.width = pct + '%';
      document.querySelector('.w-header .small span').innerText = (currentStep > 6) ? '-' : currentStep;
    }

    // --- NEW LOGIC END ---

    function updateSteps() {
      console.log("Updating steps. Current:", currentStep);

      // Handle Calendar Mode (Step 99)
      if (currentStep === 99) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById('step2B').classList.add('active');
        document.getElementById('progressFill').style.width = '100%';
        return;
      }

      // Show/Hide steps (Standard Flow)
      // Note: Step 1 (idx 0) -> Step 2A (idx 1) -> Step 2B (idx 2, skipped by logic usually) -> Step Hidden (idx 3) -> Step 3 (idx 4)...
      // This numeric logic is now fragile. Ideally we should use IDs.
      // But for now, if currentStep=2, it hits Step 2A (idx 1). 
      // If currentStep=3, it targets idx 2 (Step 2B)? No, we want Step 3 (cistern).

      // FIXING INDEX MAPPING:
      // Step 1: ID step1
      // Step 2: ID step2A
      // Step 3: ID step3
      // ...

      // Let's use explicit ID mapping for safety now that DOM is mixed
      const stepMap = {
        1: 'step1',
        2: 'step2A',
        3: 'step3',
        4: 'step4',
        5: 'step5',
        6: 'step6',
        7: 'step7'
      };

      const targetId = stepMap[currentStep];
      if (targetId) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(targetId);
        if (target) target.classList.add('active');
      } else {
        // Fallback legacy numeric (if map logic tries to use it)
        document.querySelectorAll('.step-content').forEach((el, idx) => {
          // el.classList.toggle('active', (idx + 1) === currentStep); 
        });
      }

      // Progress
      const pct = ((currentStep - 1) / (totalSteps - 1)) * 100;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('stepCount').innerText = currentStep;

      // Hide step counter on final summary page (step 7)
      const stepCounter = document.getElementById('stepCounter');
      if (stepCounter) {
        stepCounter.style.display = (currentStep === 7) ? 'none' : 'block';
      }

      // Back Button - Show/hide based on current step
      const backBtnContainer = document.getElementById('backButtonContainer');
      if (backBtnContainer) {
        // Hide on step 1 (nothing to go back to) and step 7 (quote summary has its own buttons)
        if (currentStep === 1 || currentStep === 7 || currentStep === 99) {
          backBtnContainer.style.display = 'none';
        } else {
          backBtnContainer.style.display = 'block';
        }
      }

      // Step Specific Logic
      validateStep();

      // Restore visual selection state when navigating back to a step
      restoreSelectionState();

      // Map Resize Hack
      if (currentStep === 2 && window.map) {
        setTimeout(() => {
          google.maps.event.trigger(window.map, 'resize');
          if (window.mapCenter) window.map.setCenter(window.mapCenter);
        }, 100);
      }

      if (currentStep === 7) {
        console.log("üìä Step 7 reached - calling renderSummary()");
        console.log("Current state before renderSummary:", state);
        renderSummary();
      }

      // DEBUG: Log all active steps (to catch duplicates)
      const activeSteps = document.querySelectorAll('.step-content.active');
      if (activeSteps.length > 1) {
        console.error("MULTIPLE STEPS ACTIVE:", activeSteps);
      }
    }

    async function changeStep(dir) {
      console.log("changeStep called with:", dir);

      if (dir === -1) {
        // BACK NAVIGATION LOGIC
        if (currentStep === 99) {
          // Return from Calendar to Origin
          currentStep = previousStepForCalendar;
          // If coming back to Step 1, explicitly set it
          if (previousStepForCalendar === 1) {
            showStep('step1');
          } else {
            // If was at 6, go back to 6
            if (previousStepForCalendar === 6) renderSummary();
            // Force update via standard logic if numeric match
          }
        }
        else if (currentStep === 3) {
          // Step 3 (Cistern) -> Step 2A (Manual Input)
          // Step 2 is legacy map, Step 2A is Manual. 
          // Since we force Step 2A or 2B in Step 1, we should go back to Step 2A.
          currentStep = 2;
        }
        else {
          currentStep += dir;
        }

        // Safety bounds
        if (currentStep < 1) currentStep = 1;
        updateSteps();
        return;
      }

      // Going Forward logic
      if (dir === 1) {
        if (!validateStep(true)) {
          console.log("Validation failed for next step");
          // Highlight error
          if (currentStep === 1) {
            // No specific input to highlight anymore
          }
          return;
        }

        // CRITICAL: Capture area from input when leaving Step 2A
        if (currentStep === 2) {
          const inputEl = document.getElementById('inputSqFt');
          if (inputEl && inputEl.value) {
            const val = parseFloat(inputEl.value);
            if (val > 0 && (!state.area || state.area === 0)) {
              // User entered value but didn't click Continuar
              // Capture it now before advancing
              state.area = val;
              state.knowsSqFt = true;
              state.manualOverride = true;
              window.manualArea = val;
              console.log("‚ö†Ô∏è CAPTURED AREA FROM INPUT (user used Siguiente instead of Continuar):", val);
              console.log("State updated:", { area: state.area, manualOverride: state.manualOverride });
            }
          }
        }

      }

      currentStep += dir;
      // Safety bounds
      if (currentStep < 1) currentStep = 1;
      if (currentStep > totalSteps) currentStep = totalSteps;

      console.log("New step:", currentStep);
      updateSteps();
    }
    // Restore visual selection state when navigating back to a step
    function restoreSelectionState() {
      // Step 3: Cistern selection
      if (currentStep === 3 && state.cistern !== null) {
        const cards = document.querySelectorAll('#step3 .option-card');
        cards.forEach(card => {
          card.classList.remove('selected');
          const onclick = card.getAttribute('onclick');
          if (state.cistern === true && onclick && onclick.includes('true')) {
            card.classList.add('selected');
          } else if (state.cistern === false && onclick && onclick.includes('false')) {
            card.classList.add('selected');
          }
        });
      }

      // Step 4: Solar selection
      if (currentStep === 4 && state.solar !== null) {
        const cards = document.querySelectorAll('#step4 .option-card');
        cards.forEach(card => {
          card.classList.remove('selected');
          const onclick = card.getAttribute('onclick');
          if (state.solar === true && onclick && onclick.includes('true')) {
            card.classList.add('selected');
          } else if (state.solar === false && onclick && onclick.includes('false')) {
            card.classList.add('selected');
          }
        });
      }

      // Step 5: Service selection
      if (currentStep === 5 && state.service !== null) {
        const cards = document.querySelectorAll('#step5 .option-card');
        cards.forEach(card => {
          card.classList.remove('selected');
          const onclick = card.getAttribute('onclick');
          if (onclick && onclick.includes(`'${state.service}'`)) {
            card.classList.add('selected');
          }
        });

        // Also restore Danosa options visibility if Danosa was selected
        const danosaOpts = document.getElementById('danosaOptions');
        const continueBtn = document.getElementById('danosaContinueBtn');
        if (state.service === 'Danosa') {
          if (danosaOpts) danosaOpts.style.display = 'block';
          // If removal option was already selected, show continue button
          if (state.removal !== undefined && continueBtn) {
            continueBtn.style.display = 'block';
          }
        } else {
          if (danosaOpts) danosaOpts.style.display = 'none';
          if (continueBtn) continueBtn.style.display = 'none';
        }
      }
    }

    function validateStep(shake = false) {
      let valid = false;

      if (currentStep === 1) {
        // Validation handled by card selection
        valid = state.knowsSqFt !== null;
      } else if (currentStep === 2) {
        // For step 2A (manual input), check if area is set
        // OR check if input has a valid value
        const inputEl = document.getElementById('inputSqFt');
        valid = state.area > 0 || (inputEl && parseFloat(inputEl.value) >= 100);
      } else if (currentStep === 3) {
        valid = state.cistern !== null;
      } else if (currentStep === 4) {
        valid = state.solar !== null;
      } else if (currentStep === 5) {
        valid = state.service !== null;
      } else if (currentStep === 6) {
        // Contact form validation - handled by submitContactAndProceed()
        valid = true; // Validation happens on submit
      }

      return valid;
    }

    function setOption(key, val, card) {
      state[key] = val;
      // UI selection
      const siblings = card.parentElement.parentElement.querySelectorAll('.option-card');
      siblings.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      // Toggle Danosa Options visibility AND Image Logic
      if (key === 'service') {
        const danosaOpts = document.getElementById('danosaOptions');
        const serviceImg = document.getElementById('serviceImg');

        if (val === 'Danosa') {
          danosaOpts.style.display = 'block';
          if (serviceImg) serviceImg.src = 'assets/danosa_membrane.png?v=' + new Date().getTime() + '_2';
          // Don't auto-advance - user needs to configure Danosa options
        } else {
          danosaOpts.style.display = 'none';
          state.removal = false; // reset
          if (serviceImg) serviceImg.src = 'assets/service.png?v=2';
          // Auto-advance for Silicona after short delay
          setTimeout(() => {
            changeStep(1);
          }, 400);
        }
      } else {
        // Auto-advance for cistern (step 3) and solar (step 4) selections
        setTimeout(() => {
          changeStep(1);
        }, 400);
      }

      validateStep();
    }

    // Old renderSummary deleted to avoid shadowing. 
    // The active renderSummary is now located closer to confirmManualSqFt.

    function formatMoney(n) {
      return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // PDF Download Function
    function downloadPDF() {
      // Get current date for filename
      const today = new Date();
      const dateStr = today.toLocaleDateString('es-PR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '-');

      // Get customer name if available
      const customerName = document.getElementById('contactName')?.value || state.contactName || 'Cliente';
      const sanitizedName = customerName.replace(/[^a-zA-Z0-9]/g, '_');

      // Create PDF container
      const pdfContainer = document.createElement('div');
      pdfContainer.id = 'pdfContent';
      pdfContainer.style.cssText = `
        width: 210mm;
        padding: 20mm;
        background: #0a192f;
        color: #ffffff;
        font-family: 'Inter', Arial, sans-serif;
      `;

      // Get quote values from the DOM
      const areaRaw = document.getElementById('sumAreaRaw')?.innerText || '0';
      const wastePercent = document.getElementById('lblWaste')?.innerText || '15';
      const wasteAmount = document.getElementById('sumWaste')?.innerText || '0';
      const effectiveArea = document.getElementById('sumeffectiveArea')?.innerText || '0 ft¬≤';
      const basePrice = document.getElementById('sumBase')?.innerText || '$0.00';
      const taxAmount = document.getElementById('sumTax')?.innerText || '$0.00';
      const totalAmount = document.getElementById('sumTotal')?.innerText || '$0.00';
      const showCistern = document.getElementById('rowCistern')?.style.display !== 'none';
      const showSolar = document.getElementById('rowSolar')?.style.display !== 'none';

      // Get service type
      const serviceType = state.service || 'Sellado Profesional';

      // Get base URL for assets
      const baseUrl = window.location.origin;
      const logoUrl = `${baseUrl}/assets/logo_white_ps.png`;

      // Build PDF HTML content
      pdfContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
          <img src="${logoUrl}" style="max-width: 450px; height: auto;" crossorigin="anonymous" />
        </div>

        <div style="text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #ff9900;">
          <h1 style="color: #ff9900; font-size: 24px; margin: 0; letter-spacing: 2px;">COTIZACION PROFESIONAL</h1>
          <p style="color: #94a3b8; font-size: 12px; margin-top: 5px;">Sella El Techo</p>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <p style="margin: 5px 0; color: #94a3b8;"><strong style="color: #ffffff;">Cliente:</strong> ${customerName}</p>
          <p style="margin: 5px 0; color: #94a3b8;"><strong style="color: #ffffff;">Fecha:</strong> ${today.toLocaleDateString('es-PR', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
          <p style="margin: 5px 0; color: #94a3b8;"><strong style="color: #ffffff;">Servicio:</strong> ${serviceType}</p>
          ${state.address ? `<p style="margin: 5px 0; color: #94a3b8;"><strong style="color: #ffffff;">Direccion:</strong> ${state.address}</p>` : ''}
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <tr style="border-bottom: 1px solid #1a2f4f;">
            <td style="padding: 12px 0; color: #94a3b8;">Area Geometrica (3D)</td>
            <td style="padding: 12px 0; text-align: right; color: #ffffff;">${areaRaw} ft¬≤</td>
          </tr>
          <tr style="border-bottom: 1px solid #1a2f4f;">
            <td style="padding: 12px 0; padding-left: 20px; color: #64748b; font-size: 14px;">+ Seguridad (${wastePercent}%)</td>
            <td style="padding: 12px 0; text-align: right; color: #64748b; font-size: 14px;">+${wasteAmount} ft¬≤</td>
          </tr>
          <tr style="border-bottom: 2px solid #ff9900;">
            <td style="padding: 12px 0; font-weight: bold; color: #ffffff;">Material Requerido</td>
            <td style="padding: 12px 0; text-align: right; font-weight: bold; color: #ff9900;">${effectiveArea}</td>
          </tr>
          <tr>
            <td style="padding: 15px 0 12px; color: #ffffff;">Precio Base</td>
            <td style="padding: 15px 0 12px; text-align: right; color: #ffffff;">${basePrice}</td>
          </tr>
          ${showCistern ? `
          <tr>
            <td style="padding: 12px 0; color: #ffffff;">Remocion / Manejo de Cisterna</td>
            <td style="padding: 12px 0; text-align: right; color: #ff9900;">+$150.00</td>
          </tr>
          ` : ''}
          ${showSolar ? `
          <tr>
            <td style="padding: 12px 0; color: #ffffff;">Remocion / Desmontaje Placas Solares</td>
            <td style="padding: 12px 0; text-align: right; color: #ff9900;">+$1,000.00</td>
          </tr>
          ` : ''}
          <tr style="border-top: 1px solid #1a2f4f;">
            <td style="padding: 12px 0; color: #94a3b8;">IVU (11.5%)</td>
            <td style="padding: 12px 0; text-align: right; color: #94a3b8;">${taxAmount}</td>
          </tr>
        </table>

        <div style="background: rgba(255, 153, 0, 0.15); border: 2px solid #ff9900; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 20px; font-weight: bold; color: #ffffff;">TOTAL</span>
            <span style="font-size: 28px; font-weight: bold; color: #ff9900;">${totalAmount}</span>
          </div>
        </div>

        <div style="background: rgba(255, 153, 0, 0.05); border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 25px;">
          <p style="margin: 0; color: #94a3b8; font-size: 12px;">
            <span style="color: #ff9900;">*</span> Precio sujeto a inspeccion fisica final
          </p>
        </div>

        <div style="border-top: 1px solid #1a2f4f; padding-top: 20px; text-align: center;">
          <p style="color: #94a3b8; font-size: 12px; margin: 5px 0;">
            <strong style="color: #ff9900;">Sella El Techo</strong> - Sellado Profesional de Techos
          </p>
          <p style="color: #64748b; font-size: 11px; margin: 5px 0;">
            Tel: (787) 123-4567 | info@sellaeltecho.com
          </p>
          <p style="color: #64748b; font-size: 11px; margin: 5px 0;">
            www.sellaeltecho.com
          </p>
        </div>
      `;

      // Append to body temporarily (hidden)
      pdfContainer.style.position = 'absolute';
      pdfContainer.style.left = '-9999px';
      document.body.appendChild(pdfContainer);

      // Configure html2pdf options
      const opt = {
        margin: 0,
        filename: `Cotizacion_${sanitizedName}_${dateStr}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          backgroundColor: '#0a192f',
          logging: false
        },
        jsPDF: {
          unit: 'mm',
          format: 'letter',
          orientation: 'portrait'
        }
      };

      // Generate and download PDF
      html2pdf().set(opt).from(pdfContainer).save().then(() => {
        // Clean up: remove temporary container
        document.body.removeChild(pdfContainer);
        console.log('PDF downloaded successfully');
      }).catch(err => {
        console.error('Error generating PDF:', err);
        document.body.removeChild(pdfContainer);
        alert('Error al generar el PDF. Por favor intente de nuevo.');
      });
    }

    // Bridging Map Logic
    // Bridging Map Logic
    // Bridging Map Logic
    window.updateAreaState = function (sqft, stats = null) {
      // 1. STRICT MANUAL OVERRIDE CHECK
      // If the user manually entered a value, the map should NEVER overwrite it.
      if (state.manualOverride === true || state.knowsSqFt === true || (window.manualArea && window.manualArea > 0)) {
        console.log("Blocking map update because Manual Override is active.");
        return;
      }

      // 2. Standard Logic
      state.area = sqft;
      state.stats = stats;

      console.log("Area updated to:", state.area);

      // Update Main Display
      const liveArea = document.getElementById('liveArea');
      if (liveArea) liveArea.innerText = Math.round(sqft).toLocaleString();

      // Update Table if stats provided
      if (document.getElementById('valSat')) {
        const displayVal = stats ? stats.geometric : sqft;
        document.getElementById('valSat').innerText = Math.round(displayVal).toLocaleString() + " ft¬≤";
      }

      // If we are on the quote page, re-render
      if (currentStep === 7) renderSummary();

      validateStep();
    };

    // Make functions globally available
    window.updateSteps = updateSteps;
    window.validateStep = validateStep;
    window.setOption = setOption;
    window.changeStep = changeStep;
    window.submitContactAndProceed = submitContactAndProceed;
    window.downloadPDF = downloadPDF;

    // Verification Links


    // Initial Init
    document.addEventListener('DOMContentLoaded', () => {
      console.log("Wizard Initializing...");

      // Input Listener for real-time validation
      const addrInput = document.getElementById('addressInput');
      if (addrInput) {
        addrInput.addEventListener('input', () => {
          validateStep();
        });
      }

      updateSteps(); // Initial UI Sync
    });

    // Rotation Control Logic
    let lastSliderVal = 0;
    function handleSliderRotation(val) {
      const delta = val - lastSliderVal;
      lastSliderVal = val;
      if (window.rotatePolygon) window.rotatePolygon(delta);
    }

    // Expose control visibility
    window.showRotationControls = function (show) {
      const el = document.getElementById('rotationControls');
      if (el) el.style.display = show ? 'block' : 'none';

      // Reset slider when showing
      if (show) {
        const slider = document.getElementById('rotSlider');
        if (slider) slider.value = 0;
        lastSliderVal = 0;
      }
    };
  </script>

  <!-- CRITICAL BACKUP SCRIPT: Geolocation -->
  <!-- Embedded to ensure functionality even if map_logic.js fails -->
  <script>
    console.log("‚ö° Main HTML Script Loaded. Defining useCurrentLocation...");

    window.useCurrentLocation = function () {
      console.log("üìç HTML-embedded useCurrentLocation triggered.");
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalizaci√≥n.");
        return;
      }

      const btn = document.getElementById('btnUseLocation');
      let originalText = "üìç Usar mi ubicaci√≥n";
      if (btn) {
        originalText = btn.innerText;
        btn.innerText = "‚è≥ Buscando...";
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          console.log("üìç Location Found:", position);

          // Debug Alert for User
          // alert("üìç Ubicaci√≥n detectada. Entrando al mapa...");

          const pos = { lat: position.coords.latitude, lng: position.coords.longitude };

          // Update Map if available
          if (window.map) {
            window.map.setCenter(pos);
            window.map.setZoom(21);
            window.map.setHeading(0);
            window.map.setTilt(45);
          }
          if (window.mapCenter) window.mapCenter = pos;

          // Update UI
          const addrInput = document.getElementById("addressInput");
          if (addrInput) addrInput.value = "Ubicaci√≥n detectada (" + pos.lat.toFixed(5) + ", " + pos.lng.toFixed(5) + ")";

          // Call Solar Logic (Backend)
          if (window.fetchSolarData) {
            window.fetchSolarData(pos.lat, pos.lng);
          } else {
            console.warn("fetchSolarData not ready yet. Calling manually after delay.");
            setTimeout(() => {
              if (window.fetchSolarData) window.fetchSolarData(pos.lat, pos.lng);
            }, 2000);
          }

          if (btn) btn.innerText = originalText;

          // FORCE ADVANCE STEP
          if (typeof window.changeStep === 'function') {
            console.log("üöÄ Advancing to Step 2...");
            window.changeStep(1);
          } else {
            alert("Error: changeStep no existe. Recarga la p√°gina.");
          }
        },
        (error) => {
          console.error("Geo Error:", error);
          let msg = "No pudimos ubicarte.";
          if (error.code === 1) msg = "‚ùå Permiso denegado. Revisa la configuraci√≥n del navegador.";
          if (error.code === 2) msg = "‚ùå Se√±al GPS no disponible.";
          if (error.code === 3) msg = "‚ùå Tiempo de espera agotado (Timeout).";

          alert(msg + "\n\nPor favor escribe tu direcci√≥n manualmente.");

          if (btn) btn.innerText = originalText;
        },
        { enableHighAccuracy: false, timeout: 8000, maximumAge: 0 }
      );
    };
  </script>
  <script src="https://widgets.leadconnectorhq.com/loader.js"
    data-resources-url="https://widgets.leadconnectorhq.com/chat-widget/loader.js"
    data-widget-id="6981012bab03625e91524a50">
    </script>
</body>

</html>